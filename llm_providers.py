"""
–ú–æ–¥—É–ª—å –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏
"""

import json
import asyncio
import httpx
from abc import ABC, abstractmethod
from typing import Dict, Any, Optional, Tuple, List, TYPE_CHECKING
from loguru import logger
from config import settings

import openai
from anthropic import Anthropic

# –ò–º–ø–æ—Ä—Ç –¥–ª—è retry –ª–æ–≥–∏–∫–∏
from src.reliability.retry import RetryManager, LLM_RETRY_CONFIG

# –ò–º–ø–æ—Ä—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π
from src.exceptions.processing import LLMInsufficientCreditsError

# –ò–º–ø–æ—Ä—Ç –ø—Ä–∞–≤–∏–ª –¥–ª—è –ø–æ–ª–µ–π –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∞–≤–∏–ª
from src.prompts.prompts import (
    FIELD_SPECIFIC_RULES, 
    _build_field_specific_rules,
    build_analysis_prompt,
    build_analysis_system_prompt,
    build_generation_prompt,
    build_generation_system_prompt
)

# –ò–º–ø–æ—Ä—Ç JSON Schema –¥–ª—è structured outputs
from src.models.llm_schemas import (
    PROTOCOL_SCHEMA,
    MEETING_ANALYSIS_SCHEMA,
    PROTOCOL_DATA_SCHEMA
)

# –ò–º–ø–æ—Ä—Ç —É—Ç–∏–ª–∏—Ç –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
from src.utils.context_extraction import (
    extract_relevant_excerpts,
    build_structure_summary,
    add_prompt_caching_markers,
    build_anthropic_messages_with_caching
)

# –ò–º–ø–æ—Ä—Ç —É—Ç–∏–ª–∏—Ç –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
from src.utils.token_cache_logger import log_cached_tokens_usage, check_cache_support

# -------------------------------------------------------------
# –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
# -------------------------------------------------------------
def safe_json_parse(content: str, context: str = "LLM response") -> Dict[str, Any]:
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ JSON —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Ä–∞–∑–ª–∏—á–Ω—ã—Ö edge cases.
    
    Args:
        content: –°—Ç—Ä–æ–∫–∞ —Å JSON –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "OpenAI response")
        
    Returns:
        –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π JSON —Å–ª–æ–≤–∞—Ä—å
        
    Raises:
        ValueError: –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫
    """
    if not content or not content.strip():
        raise ValueError(f"–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –≤ {context}")
    
    original_content = content
    content_length = len(content)
    
    # –®–∞–≥ 1: –£–¥–∞–ª—è–µ–º BOM (Byte Order Mark) –∏ –Ω–µ–≤–∏–¥–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã
    content = content.strip()
    if content.startswith('\ufeff'):
        content = content[1:]
        logger.debug(f"–£–¥–∞–ª–µ–Ω BOM –∏–∑ {context}")
    
    # –®–∞–≥ 2: –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä—è–º–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
    try:
        result = json.loads(content)
        logger.debug(f"–ü—Ä—è–º–æ–π –ø–∞—Ä—Å–∏–Ω–≥ JSON —É—Å–ø–µ—à–µ–Ω –¥–ª—è {context}")
        return result
    except json.JSONDecodeError as e:
        logger.warning(f"–ü—Ä—è–º–æ–π –ø–∞—Ä—Å–∏–Ω–≥ JSON –Ω–µ —É–¥–∞–ª—Å—è –¥–ª—è {context}: {e}")
    
    # –®–∞–≥ 3: –£–¥–∞–ª—è–µ–º markdown –±–ª–æ–∫–∏ (```json ... ``` –∏–ª–∏ ``` ... ```)
    import re
    markdown_pattern = r'```(?:json)?\s*\n?(.*?)\n?```'
    markdown_match = re.search(markdown_pattern, content, re.DOTALL)
    if markdown_match:
        content = markdown_match.group(1).strip()
        logger.debug(f"–ò–∑–≤–ª–µ—á–µ–Ω JSON –∏–∑ markdown –±–ª–æ–∫–∞ –≤ {context}")
        try:
            result = json.loads(content)
            logger.info(f"–ü–∞—Ä—Å–∏–Ω–≥ JSON –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è markdown —É—Å–ø–µ—à–µ–Ω –¥–ª—è {context}")
            return result
        except json.JSONDecodeError as e:
            logger.warning(f"–ü–∞—Ä—Å–∏–Ω–≥ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è markdown –Ω–µ —É–¥–∞–ª—Å—è –¥–ª—è {context}: {e}")
    
    # –®–∞–≥ 4: –ò—â–µ–º JSON –æ–±—ä–µ–∫—Ç –≤ —Ç–µ–∫—Å—Ç–µ (–º–µ–∂–¥—É –ø–µ—Ä–≤–æ–π { –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π })
    start_idx = content.find('{')
    end_idx = content.rfind('}') + 1
    
    if start_idx != -1 and end_idx > start_idx:
        json_str = content[start_idx:end_idx]
        logger.debug(f"–ò–∑–≤–ª–µ—á–µ–Ω JSON –∏–∑ –ø–æ–∑–∏—Ü–∏–∏ {start_idx} –¥–æ {end_idx} –≤ {context}")
        try:
            result = json.loads(json_str)
            logger.info(f"–ü–∞—Ä—Å–∏–Ω–≥ –∏–∑–≤–ª–µ—á–µ–Ω–Ω–æ–≥–æ JSON —É—Å–ø–µ—à–µ–Ω –¥–ª—è {context}")
            return result
        except json.JSONDecodeError as e:
            logger.warning(f"–ü–∞—Ä—Å–∏–Ω–≥ –∏–∑–≤–ª–µ—á–µ–Ω–Ω–æ–≥–æ JSON –Ω–µ —É–¥–∞–ª—Å—è –¥–ª—è {context}: {e}")
    
    # –®–∞–≥ 5: –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ JSON –º–∞—Å—Å–∏–≤ (–º–µ–∂–¥—É –ø–µ—Ä–≤–æ–π [ –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π ])
    start_idx = content.find('[')
    end_idx = content.rfind(']') + 1
    
    if start_idx != -1 and end_idx > start_idx:
        json_str = content[start_idx:end_idx]
        logger.debug(f"–ò–∑–≤–ª–µ—á–µ–Ω JSON –º–∞—Å—Å–∏–≤ –∏–∑ –ø–æ–∑–∏—Ü–∏–∏ {start_idx} –¥–æ {end_idx} –≤ {context}")
        try:
            result = json.loads(json_str)
            logger.info(f"–ü–∞—Ä—Å–∏–Ω–≥ JSON –º–∞—Å—Å–∏–≤–∞ —É—Å–ø–µ—à–µ–Ω –¥–ª—è {context}")
            return result
        except json.JSONDecodeError as e:
            logger.warning(f"–ü–∞—Ä—Å–∏–Ω–≥ JSON –º–∞—Å—Å–∏–≤–∞ –Ω–µ —É–¥–∞–ª—Å—è –¥–ª—è {context}: {e}")
    
    # –®–∞–≥ 6: –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - —É–¥–∞–ª—è–µ–º –≤—Å–µ –¥–æ –ø–µ—Ä–≤–æ–π { –∏ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π }
    # –∏ –ø—ã—Ç–∞–µ–º—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å common issues
    try:
        # –£–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ —Å—Ç–∏–ª–µ // –∏ /* */
        content_no_comments = re.sub(r'//.*?$', '', content, flags=re.MULTILINE)
        content_no_comments = re.sub(r'/\*.*?\*/', '', content_no_comments, flags=re.DOTALL)
        
        # –£–¥–∞–ª—è–µ–º trailing commas
        content_no_comments = re.sub(r',(\s*[}\]])', r'\1', content_no_comments)
        
        result = json.loads(content_no_comments)
        logger.info(f"–ü–∞—Ä—Å–∏–Ω–≥ JSON –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ —É—Å–ø–µ—à–µ–Ω –¥–ª—è {context}")
        return result
    except json.JSONDecodeError:
        pass
    
    # –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã - –ª–æ–≥–∏—Ä—É–µ–º –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
    logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –≤ {context}")
    logger.error(f"–î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: {content_length} —Å–∏–º–≤–æ–ª–æ–≤")
    logger.error(f"–ü–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤: {original_content[:500]}")
    logger.error(f"–ü–æ—Å–ª–µ–¥–Ω–∏–µ 500 —Å–∏–º–≤–æ–ª–æ–≤: {original_content[-500:] if len(original_content) > 500 else ''}")
    
    # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ–∑–∏—Ü–∏—é –æ—à–∏–±–∫–∏
    try:
        json.loads(original_content)
    except json.JSONDecodeError as final_error:
        error_pos = getattr(final_error, 'pos', None)
        if error_pos and error_pos < len(original_content):
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ–∫—Ä—É–≥ –æ—à–∏–±–∫–∏
            start = max(0, error_pos - 50)
            end = min(len(original_content), error_pos + 50)
            context_str = original_content[start:end]
            logger.error(f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ (–ø–æ–∑–∏—Ü–∏—è {error_pos}): ...{context_str}...")
        
        raise ValueError(
            f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –≤ {context}: {final_error}. "
            f"–î–ª–∏–Ω–∞: {content_length} —Å–∏–º–≤–æ–ª–æ–≤. "
            f"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π."
        )
    
    raise ValueError(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –≤ {context}. –î–ª–∏–Ω–∞: {content_length} —Å–∏–º–≤–æ–ª–æ–≤.")

class LLMProvider(ABC):
    """–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤"""
    
    @abstractmethod
    async def generate_protocol(self, transcription: str, template_variables: Dict[str, str], diarization_data: Optional[Dict[str, Any]] = None, **kwargs) -> Dict[str, Any]:
        """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –∏ —à–∞–±–ª–æ–Ω–∞"""
        pass
    
    @abstractmethod
    def is_available(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞"""
        pass


# -------------------------------------------------------------
# –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–∏–ª–¥–µ—Ä—ã –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
# -------------------------------------------------------------
def _build_system_prompt(
    transcription: Optional[str] = None,
    diarization_analysis: Optional[Dict[str, Any]] = None,
    llm_meeting_type: Optional[str] = None
) -> str:
    """
    –°—Ç—Ä–æ–≥–∞—è —Å–∏—Å—Ç–µ–º–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞.
    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è.

    Args:
        transcription: –¢–µ–∫—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ (–¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏)
        diarization_analysis: –ê–Ω–∞–ª–∏–∑ –¥–∏–∞—Ä–∏–∑–∞—Ü–∏–∏ (–¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏)
        llm_meeting_type: –¢–∏–ø –≤—Å—Ç—Ä–µ—á–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π LLM (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º)

    Returns:
        –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–±–∞–∑–æ–≤—ã–π –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
    """
    # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: LLM-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ > –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä > –±–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç
    meeting_type = None

    # 1. –ï—Å–ª–∏ LLM –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∞ —Ç–∏–ø –≤—Å—Ç—Ä–µ—á–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
    if llm_meeting_type:
        meeting_type = llm_meeting_type
        logger.info(f"–ò—Å–ø–æ–ª—å–∑—É—é —Ç–∏–ø –≤—Å—Ç—Ä–µ—á–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π LLM: {meeting_type}")
    # 2. –ò–Ω–∞—á–µ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –µ—Å—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è
    elif settings.meeting_type_detection and transcription:
        try:
            from src.services.meeting_classifier import meeting_classifier
            # –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –≤—Å—Ç—Ä–µ—á—É
            meeting_type, _ = meeting_classifier.classify(
                transcription,
                diarization_analysis
            )
            logger.info(f"–ò—Å–ø–æ–ª—å–∑—É—é —Ç–∏–ø –≤—Å—Ç—Ä–µ—á–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º: {meeting_type}")

        except Exception as e:
            logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤—Å—Ç—Ä–µ—á–∏: {e}. –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç")

    # –ï—Å–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∏–ø –≤—Å—Ç—Ä–µ—á–∏, –ª–æ–≥–∏—Ä—É–µ–º –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç)
    if meeting_type:
        logger.info(f"–û–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∏–ø –≤—Å—Ç—Ä–µ—á–∏: {meeting_type} (–∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç)")
    
    # –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç (–æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤)
    base_prompt = (
        "–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª–∏—Å—Ç –≤—ã—Å—à–µ–π –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å –æ–ø—ã—Ç–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è "
        "–¥–µ–ª–æ–≤—ã—Ö –≤—Å—Ç—Ä–µ—á, —Å–æ–≤–µ—â–∞–Ω–∏–π –∏ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤.\n\n"
        
        "–¢–í–û–Ø –†–û–õ–¨:\n"
        "- –ò–∑–≤–ª–µ–∫–∞—Ç—å –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Å—Ç–µ–Ω–æ–≥—Ä–∞–º–º –≤—Å—Ç—Ä–µ—á\n"
        "- –°–æ–∑–¥–∞–≤–∞—Ç—å —á–µ—Ç–∫–∏–µ, –ª–∞–∫–æ–Ω–∏—á–Ω—ã–µ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã\n"
        "- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Ñ–∞–∫—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é —Ç–æ—á–Ω–æ—Å—Ç—å\n\n"
        
        "–§–£–ù–î–ê–ú–ï–ù–¢–ê–õ–¨–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´ –¢–û–ß–ù–û–°–¢–ò:\n"
        "- –ê–ë–°–û–õ–Æ–¢–ù–ê–Ø –ü–û–õ–ù–û–¢–ê: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –í–°–Æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–ª–æ–≤–∞. "
        "–ö–∞–∂–¥–∞—è —É–ø–æ–º—è–Ω—É—Ç–∞—è —Ç–µ–º–∞, –∏–¥–µ—è, –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç—Ä–∞–∂–µ–Ω—ã –≤ –ø—Ä–æ—Ç–æ–∫–æ–ª–µ\n"
        "- –§–ê–ö–¢–ò–ß–ï–°–ö–ê–Ø –¢–û–ß–ù–û–°–¢–¨: –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, —è–≤–Ω–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â—É—é –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏. "
        "–ù–ï –¥–æ–±–∞–≤–ª—è–π, –ù–ï –¥–æ–º—ã—Å–ª–∏–≤–∞–π, –ù–ï –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–π —Å–≤–µ—Ä—Ö —Å–∫–∞–∑–∞–Ω–Ω–æ–≥–æ\n"
        "- –°–û–•–†–ê–ù–ï–ù–ò–ï –ö–û–ù–¢–ï–ö–°–¢–ê: –§–∏–∫—Å–∏—Ä—É–π –Ω–µ —Ç–æ–ª—å–∫–æ –ß–¢–û –±—ã–ª–æ —Å–∫–∞–∑–∞–Ω–æ, –Ω–æ –∏ –ö–ê–ö –æ–±—Å—É–∂–¥–∞–ª–æ—Å—å "
        "(—Ç–æ–Ω –¥–∏—Å–∫—É—Å—Å–∏–∏, —É—Ä–æ–≤–µ–Ω—å —Å–æ–≥–ª–∞—Å–∏—è/–Ω–µ—Å–æ–≥–ª–∞—Å–∏—è, —Å—Ç–µ–ø–µ–Ω—å –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–ø—Ä–æ—Å–∞)\n"
        "- –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ï–ó –ü–û–¢–ï–†–¨: –ï—Å–ª–∏ —É—á–∞—Å—Ç–Ω–∏–∫ —É–ø–æ–º—è–Ω—É–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä, —Ü–∏—Ñ—Ä—É, –¥–∞—Ç—É, –∏–º—è, "
        "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é –∏–ª–∏ –ª—é–±—É—é —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫—É—é –¥–µ—Ç–∞–ª—å ‚Äî —ç—Ç–æ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –ø—Ä–æ—Ç–æ–∫–æ–ª–µ\n"
        "- –ê–¢–†–ò–ë–£–¶–ò–Ø –í–´–°–ö–ê–ó–´–í–ê–ù–ò–ô: –ï—Å–ª–∏ –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ —É–∫–∞–∑–∞–Ω—ã –∏–º–µ–Ω–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –í–°–ï–ì–î–ê —É–∫–∞–∑—ã–≤–∞–π, "
        "–∫—Ç–æ —á—Ç–æ —Å–∫–∞–∑–∞–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä: \"–ò–≤–∞–Ω –ø—Ä–µ–¥–ª–æ–∂–∏–ª...\", \"–ú–∞—Ä–∏—è –æ—Ç–º–µ—Ç–∏–ª–∞...\")\n"
        "- –û–¢–ö–†–´–¢–´–ï –í–û–ü–†–û–°–´: –§–∏–∫—Å–∏—Ä—É–π –í–°–ï –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —Ç–µ–º—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±—Å—É–∂–¥–µ–Ω–∏—è, "
        "–∏ –º–æ–º–µ–Ω—Ç—ã –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç–∏\n\n"
        
        "–ü–†–ê–í–ò–õ–ê –û–ë–†–ê–ë–û–¢–ö–ò –°–ü–ï–¶–ò–§–ò–ß–ï–°–ö–û–ô –ò–ù–§–û–†–ú–ê–¶–ò–ò:\n"
        "- –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –ª–∏—Ü–∞: –£–∫–∞–∑—ã–≤–∞–π –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —è–≤–Ω–æ –Ω–∞–∑–≤–∞–Ω—ã –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏. "
        "–ï—Å–ª–∏ —Å–∫–∞–∑–∞–Ω–æ \"–∫—Ç–æ-—Ç–æ –¥–æ–ª–∂–µ–Ω —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å\" –±–µ–∑ –∏–º–µ–Ω–∏ ‚Äî –ø–∏—à–∏ \"–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω\" –∏–ª–∏ \"–ù–µ —É–∫–∞–∑–∞–Ω–æ\"\n"
        "- –°—Ä–æ–∫–∏ –∏ –¥–∞—Ç—ã: –£–∫–∞–∑—ã–≤–∞–π –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —è–≤–Ω–æ —É–ø–æ–º—è–Ω—É—Ç—ã. –ï—Å–ª–∏ —Å–∫–∞–∑–∞–Ω–æ \"—Å–∫–æ—Ä–æ\" –∏–ª–∏ \"–≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è\" ‚Äî "
        "—Å–æ—Ö—Ä–∞–Ω—è–π —ç—Ç—É —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É\n"
        "- –†–µ—à–µ–Ω–∏—è: –ß–µ—Ç–∫–æ —Ä–∞–∑–ª–∏—á–∞–π –º–µ–∂–¥—É \"–ø—Ä–∏–Ω—è—Ç–æ —Ä–µ—à–µ–Ω–∏–µ\" –∏ \"–æ–±—Å—É–∂–¥–∞–ª–∞—Å—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å\". "
        "–§–∏–∫—Å–∏—Ä—É–π —É—Ä–æ–≤–µ–Ω—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç–∏\n"
        "- –¶–∏—Ñ—Ä—ã –∏ –º–µ—Ç—Ä–∏–∫–∏: –ó–∞–ø–∏—Å—ã–≤–∞–π –≤—Å–µ —É–ø–æ–º—è–Ω—É—Ç—ã–µ —á–∏—Å–ª–∞, –ø—Ä–æ—Ü–µ–Ω—Ç—ã, –±—é–¥–∂–µ—Ç—ã, —Å—Ä–æ–∫–∏ —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏\n\n"
        
        "–ü–†–ò–ù–¶–ò–ü–´ –†–ê–ë–û–¢–´:\n"
        "1. –¢–û–ß–ù–û–°–¢–¨: –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã, —è–≤–Ω–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –≤ —Å—Ç–µ–Ω–æ–≥—Ä–∞–º–º–µ\n"
        "2. –ù–ï–¢ –î–û–ú–´–°–õ–û–í: –ù–µ –¥–æ–¥—É–º—ã–≤–∞–π, –Ω–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–π, –Ω–µ –¥–æ–±–∞–≤–ª—è–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ—Ç —Å–µ–±—è\n"
        "3. –ö–û–ù–¢–ï–ö–°–¢: –ï—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è —Ä–æ–ª—å/–¥–æ–ª–∂–Ω–æ—Å—Ç—å/—Å—Ä–æ–∫/—Å—É–º–º–∞ ‚Äî —É–∫–∞–∂–∏ –∏—Ö; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π\n"
        "4. –ö–†–ê–¢–ö–û–°–¢–¨: –ò–∑–ª–∞–≥–∞–π —Å—É—Ç—å –±–µ–∑ –≤–æ–¥—ã, –∏–∑–±–µ–≥–∞–π –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π\n"
        "5. –¢–ï–†–ú–ò–ù–û–õ–û–ì–ò–Ø: –°–æ—Ö—Ä–∞–Ω—è–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –∏ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ\n"
        "6. –°–¢–ò–õ–¨: –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ-–¥–µ–ª–æ–≤–æ–π —è–∑—ã–∫ –±–µ–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã—Ö –æ–±–æ—Ä–æ—Ç–æ–≤\n\n"
        
        "üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –§–û–†–ú–ê–¢ –ò–ú–ï–ù –£–ß–ê–°–¢–ù–ò–ö–û–í –í –ü–†–û–¢–û–ö–û–õ–ï:\n"
        "–í —Å–µ–∫—Ü–∏–∏ '–£—á–∞—Å—Ç–Ω–∏–∫–∏' –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π –∏–º–µ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ '–ò–º—è –§–∞–º–∏–ª–∏—è' –ë–ï–ó –æ—Ç—á–µ—Å—Ç–≤–∞!\n"
        "–ï—Å–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ - –ö–û–ü–ò–†–£–ô –∏–º–µ–Ω–∞ –¢–û–ß–ù–û –∫–∞–∫ –æ–Ω–∏ —É–∫–∞–∑–∞–Ω—ã –≤ —Å–ø–∏—Å–∫–µ.\n\n"
        "‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: —Ç–æ–ª—å–∫–æ –∏–º—è ('–°–æ—Ñ—å—è', '–ì–∞–ª–∏–Ω–∞') –∏–ª–∏ —Å –æ—Ç—á–µ—Å—Ç–≤–æ–º ('–°–æ—Ñ—å—è –Æ—Ä—å–µ–≤–Ω–∞ –û—Å–∏–ø–æ–≤–∞')\n"
        "‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: '–°–æ—Ñ—å—è –û—Å–∏–ø–æ–≤–∞', '–ì–∞–ª–∏–Ω–∞ –Ø–º–∫–∏–Ω–∞', '–í–ª–∞–¥–∏–º–∏—Ä –ì–æ–ª–∏–∫–æ–≤'\n\n"
        "–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –£–ß–ê–°–¢–ù–ò–ö–û–í –ò–ó –¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–ò:\n"
        "‚ö†Ô∏è –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω —è–≤–Ω–æ:\n"
        "- –ò–∑–≤–ª–µ–∫–∞–π –∏–º–µ–Ω–∞ –¢–û–õ–¨–ö–û –∏–∑ —è–≤–Ω—ã—Ö —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏\n"
        "- –ò—Å—Ç–æ—á–Ω–∏–∫–∏: –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è ('–ú–µ–Ω—è –∑–æ–≤—É—Ç...'), –æ–±—Ä–∞—â–µ–Ω–∏—è ('–°–≤–µ—Ç–∞, –∫–∞–∫ –¥—É–º–∞–µ—à—å?')\n"
        "- –ü—Ä–µ–æ–±—Ä–∞–∑—É–π —É–º–µ–Ω—å—à–∏—Ç–µ–ª—å–Ω—ã–µ –≤ –ø–æ–ª–Ω—ã–µ: –°–≤–µ—Ç–∞‚Üí–°–≤–µ—Ç–ª–∞–Ω–∞, –õ–µ—à–∞‚Üí–ê–ª–µ–∫—Å–µ–π\n"
        "- –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç '–ò–º—è –§–∞–º–∏–ª–∏—è' –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ\n"
        "- –ï–°–õ–ò –∏–º—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å - –æ—Å—Ç–∞–≤–ª—è–π –º–µ—Ç–∫—É —Å–ø–∏–∫–µ—Ä–∞ (SPEAKER_1, SPEAKER_2)\n"
        "- ‚ùå –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∏–º–µ–Ω–∞! –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π '–£—á–∞—Å—Ç–Ω–∏–∫ 1', '–ö–æ–ª–ª–µ–≥–∞'\n"
        "- ‚ùå –ù–ï –¥—É–±–ª–∏—Ä—É–π: –µ—Å–ª–∏ –°–≤–µ—Ç–∞ = SPEAKER_1, –Ω–µ –¥–æ–±–∞–≤–ª—è–π –°–≤–µ—Ç–ª–∞–Ω—É –æ—Ç–¥–µ–ª—å–Ω–æ\n\n"
        
        "–§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –û–ë–°–£–ñ–î–ï–ù–ò–Ø:\n"
        "–ï—Å–ª–∏ –≥—Ä—É–ø–ø–∏—Ä—É–µ—à—å –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –ø–æ —Ç–µ–º–∞–º/–∫–ª–∞—Å—Ç–µ—Ä–∞–º:\n"
        "- –ù–ï –ø–∏—à–∏ —Å–ª–æ–≤–æ '–ö–ª–∞—Å—Ç–µ—Ä', —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã —Å –º–∞—Ä–∫–µ—Ä–æ–º: '‚Ä¢ **–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã**'\n"
        "- –ö–∞–∂–¥—É—é –∏–¥–µ—é/–≤—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏–µ/–ø–æ–∑–∏—Ü–∏—é —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏\n"
        "- –§–æ—Ä–º–∞—Ç –≤—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏—è: '–ò–º—è –ê–≤—Ç–æ—Ä–∞: —Ç–µ–∫—Å—Ç' (–±–µ–∑ —Å–ª–æ–≤–∞ '–ò–¥–µ—è', –±–µ–∑ —Å–∫–æ–±–æ–∫)\n"
        "- –ú–µ–∂–¥—É —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –±–ª–æ–∫–∞–º–∏ –æ—Å—Ç–∞–≤–ª—è–π –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è\n\n"
        "–ü—Ä–∏–º–µ—Ä—ã:\n"
        "‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:\n"
        "‚Ä¢ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è**\n\n"
        "–ê–ª–µ–∫—Å–µ–π –¢–∏–º—á–µ–Ω–∫–æ: –ø—Ä–µ–¥–ª–æ–∂–∏–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É\n\n"
        "–ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞: –ø–æ–¥–¥–µ—Ä–∂–∞–ª–∞, –¥–æ–±–∞–≤–∏–ª–∞ –ø—Ä–æ –≤–∞–∂–Ω–æ—Å—Ç—å API gateway\n\n"
        "‚úó –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:\n"
        "‚Ä¢ –ö–ª–∞—Å—Ç–µ—Ä ¬´–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è¬ª: –ò–¥–µ—è (–ê–ª–µ–∫—Å–µ–π –¢–∏–º—á–µ–Ω–∫–æ): –ø—Ä–µ–¥–ª–æ–∂–∏–ª...\n\n"
        
        "–ß–¢–û –ò–ì–ù–û–†–ò–†–û–í–ê–¢–¨:\n"
        "- –ú–µ–∂–¥–æ–º–µ—Ç–∏—è (—ç-—ç, –º-–º, –Ω—É, –≤–æ—Ç)\n"
        "- –ü–æ–≤—Ç–æ—Ä—ã –∏ –∑–∞–ø–∏–Ω–∫–∏\n"
        "- –í–≤–æ–¥–Ω—ã–µ —Ñ—Ä–∞–∑—ã –±–µ–∑ —Å–º—ã—Å–ª–æ–≤–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏\n"
        "- –û—Ç–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –Ω–µ –ø–æ —Ç–µ–º–µ –≤—Å—Ç—Ä–µ—á–∏\n\n"
        
        "–ß–¢–û –í–´–î–ï–õ–Ø–¢–¨:\n"
        "- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏ —Ä–µ–∑–æ–ª—é—Ü–∏–∏\n"
        "- –ü–æ—Ä—É—á–µ–Ω–∏—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π (–µ—Å–ª–∏ —É–ø–æ–º—è–Ω—É—Ç—ã)\n"
        "- –°—Ä–æ–∫–∏, —Å—É–º–º—ã, –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–≤–Ω–æ –Ω–∞–∑–≤–∞–Ω—ã)\n"
        "- –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è\n"
        "- –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏\n"
        "- –¶–∏—Ñ—Ä—ã, –º–µ—Ç—Ä–∏–∫–∏, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–∫–ª—é—á–∞–π –≤—Å–µ —É–ø–æ–º—è–Ω—É—Ç—ã–µ)\n"
        "- –í—Å–µ —Ç–µ–º—ã –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫—Ç–æ —á—Ç–æ —Å–∫–∞–∑–∞–ª\n"
        "- –ú–æ–º–µ–Ω—Ç—ã –Ω–µ—Å–æ–≥–ª–∞—Å–∏—è, –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–Ω–µ–Ω–∏—è, –Ω–µ—Ä–µ—à–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n\n"
        
        "–§–û–†–ú–ê–¢ –í–´–í–û–î–ê:\n"
        "–í–µ—Ä–Ω–∏ JSON –≤ —Ñ–æ—Ä–º–∞—Ç–µ —Å—Ö–µ–º—ã. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–ª–∏ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π '–ù–µ —É–∫–∞–∑–∞–Ω–æ'.\n\n"
    )
    
    formatting_rules = (
        "–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚Äî —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª–µ–π –ø—Ä–æ—Ç–æ–∫–æ–ª–∞:\n"
        "- –í–°–ï –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ü–†–û–°–¢–´–ú–ò –°–¢–†–û–ö–ê–ú–ò (string), –Ω–µ –æ–±—ä–µ–∫—Ç–∞–º–∏ –∏–ª–∏ –º–∞—Å—Å–∏–≤–∞–º–∏\n"
        "- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã {} –∏–ª–∏ –º–∞—Å—Å–∏–≤—ã [] –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª–µ–π –ø—Ä–æ—Ç–æ–∫–æ–ª–∞\n"
        "- –°–ø–∏—Å–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–π –∫–∞–∫ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π —Ç–µ–∫—Å—Ç —Å –º–∞—Ä–∫–µ—Ä–∞–º–∏ '- ' (–¥–µ—Ñ–∏—Å + –ø—Ä–æ–±–µ–ª)\n"
        "- –î–∞—Ç—ã –∏ –≤—Ä–µ–º—è: –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä '20 –æ–∫—Ç—è–±—Ä—è 2024, 14:30'\n"
        "- –£—á–∞—Å—Ç–Ω–∏–∫–∏: –∫–∞–∂–¥–æ–µ –∏–º—è —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ —á–µ—Ä–µ–∑ \\n, –ë–ï–ó —Ä–æ–ª–µ–π!, –Ω–∞–ø—Ä–∏–º–µ—Ä '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤\\n–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞\\n–ê–ª–µ–∫—Å–µ–π –°–º–∏—Ä–Ω–æ–≤'\n"
        "- –†–µ—à–µ–Ω–∏—è –∏ –∑–∞–¥–∞—á–∏: –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ —Å–ø–∏—Å–∫–æ–º —á–µ—Ä–µ–∑ \\n, –∫–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç —Å '- '\n\n"
        
        "–§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –°–ü–ò–°–ö–û–í:\n"
        "- –í–Ω—É—Ç—Ä–∏ –∑–Ω–∞—á–µ–Ω–∏–π JSON –ø–æ–ª–µ–π: –∏—Å–ø–æ–ª—å–∑—É–π –æ–¥–∏–Ω–∞—Ä–Ω—ã–π \\n –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø–∏—Å–∫–∞\n"
        "- –î–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –±–ª–æ–∫–æ–≤ –≤ –æ–±—Å—É–∂–¥–µ–Ω–∏–∏: –∏—Å–ø–æ–ª—å–∑—É–π –¥–≤–æ–π–Ω–æ–π \\n\\n\n\n"
        
        "–ü–†–ò–ú–ï–† –ü–†–ê–í–ò–õ–¨–ù–û–ì–û JSON:\n"
        "{\n"
        '  "date": "20 –æ–∫—Ç—è–±—Ä—è 2024",\n'
        '  "time": "14:30",\n'
        '  "participants": "–û–∫—Å–∞–Ω–∞ –ò–≤–∞–Ω–æ–≤–∞\\n–ì–∞–ª–∏–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞\\n–ê–ª–µ–∫—Å–µ–π –°–º–∏—Ä–Ω–æ–≤",\n'
        '  "decisions": "- –†–µ—à–µ–Ω–∏–µ 1\\n- –†–µ—à–µ–Ω–∏–µ 2\\n- –†–µ—à–µ–Ω–∏–µ 3"\n'
        "}\n\n"
        
        "–ü–†–ò–ú–ï–† –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ì–û JSON (–ù–ï –î–ï–õ–ê–ô –¢–ê–ö):\n"
        "{\n"
        '  "date": {"day": 20, "month": "–æ–∫—Ç—è–±—Ä—å"},  ‚ùå –≤–ª–æ–∂–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç\n'
        '  "participants": ["–û–∫—Å–∞–Ω–∞", "–ì–∞–ª—è"],  ‚ùå –º–∞—Å—Å–∏–≤\n'
        '  "decisions": [{"decision": "–†–µ—à–µ–Ω–∏–µ 1"}]  ‚ùå –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤\n'
        "}"
    )
    
    return base_prompt + formatting_rules


def _build_user_prompt(
    transcription: str,
    template_variables: Dict[str, str],
    diarization_data: Optional[Dict[str, Any]] = None,
    speaker_mapping: Optional[Dict[str, str]] = None,
    meeting_topic: Optional[str] = None,
    meeting_date: Optional[str] = None,
    meeting_time: Optional[str] = None,
    participants: Optional[List[Dict[str, str]]] = None,
) -> str:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –∫ —Ñ–æ—Ä–º–∞—Ç—É.
    
    –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è formatted_transcript –∏–∑ diarization_data, –∫–æ—Ç–æ—Ä—ã–π:
    - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏—è —Å–ø–∏–∫–µ—Ä–æ–≤
    - –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–ø–ª–∏–∫–∏ –æ–¥–Ω–æ–≥–æ —Å–ø–∏–∫–µ—Ä–∞
    - –ü–æ–∑–≤–æ–ª—è–µ—Ç LLM –ø–æ–Ω—è—Ç—å –¥–∏–Ω–∞–º–∏–∫—É –¥–∏–∞–ª–æ–≥–∞
    - –≠–∫–æ–Ω–æ–º–∏—Ç —Ç–æ–∫–µ–Ω—ã –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏—Å—Ö–æ–¥–Ω–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
    
    –ò—Å—Ö–æ–¥–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞
    —á–µ—Ä–µ–∑ settings.include_raw_transcription_in_prompts –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å –¥–∏–∞—Ä–∏–∑–∞—Ü–∏–µ–π.
    """
    # –ë–ª–æ–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (—Å —É—á—ë—Ç–æ–º –¥–∏–∞—Ä–∏–∑–∞—Ü–∏–∏)
    if diarization_data and diarization_data.get("formatted_transcript"):
        transcription_text = (
            "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –≥–æ–≤–æ—Ä—è—â–∏—Ö:\n"
            f"{diarization_data['formatted_transcript']}\n\n"
            "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n"
            f"- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–≤–æ—Ä—è—â–∏—Ö: {diarization_data.get('total_speakers', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}\n"
            f"- –°–ø–∏—Å–æ–∫ –≥–æ–≤–æ—Ä—è—â–∏—Ö: {', '.join(diarization_data.get('speakers', []))}\n\n"
        )
        
        # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        if settings.include_raw_transcription_in_prompts:
            transcription_text += (
                "\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n"
                "–ò–°–•–û–î–ù–ê–Ø –¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø (–î–õ–Ø –û–¢–õ–ê–î–ö–ò):\n"
                "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n"
                f"{transcription}\n\n"
            )
    else:
        transcription_text = (
            "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è:\n"
            f"{transcription}\n\n"
            "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –î–∏–∞—Ä–∏–∑–∞—Ü–∏—è (—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –≥–æ–≤–æ—Ä—è—â–∏—Ö) –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏.\n"
        )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ —Å–ø–∏–∫–µ—Ä–æ–≤ —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
    participants_info = ""
    if speaker_mapping:
        mapping_list = "\n".join(f"- {sid} = {name}" for sid, name in speaker_mapping.items())
        participants_info = (
            f"\n\n{'‚ïê' * 63}\n"
            "–£–ß–ê–°–¢–ù–ò–ö–ò –í–°–¢–†–ï–ß–ò (–° –†–û–õ–Ø–ú–ò)\n"
            f"{'‚ïê' * 63}\n\n"
            "–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≥–æ–≤–æ—Ä—è—â–∏—Ö —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏:\n"
            f"{mapping_list}\n\n"
            "‚ö†Ô∏è –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –†–ê–ë–û–¢–ï –° –£–ß–ê–°–¢–ù–ò–ö–ê–ú–ò:\n"
            "1. –ò—Å–ø–æ–ª—å–∑—É–π –†–ï–ê–õ–¨–ù–´–ï –ò–ú–ï–ù–ê –≤–º–µ—Å—Ç–æ –º–µ—Ç–æ–∫ —Å–ø–∏–∫–µ—Ä–æ–≤ (SPEAKER_1 ‚Üí –ò–º—è)\n"
            "2. –ü—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏–π —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤\n"
            "3. –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ: –¢–û–õ–¨–ö–û –ò–ú–Ø, –±–µ–∑ —Ä–æ–ª–∏ –≤ —Å–∫–æ–±–∫–∞—Ö\n"
            "   ‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–æ: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤'\n"
            "   ‚úó –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: '–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ (–ú–µ–Ω–µ–¥–∂–µ—Ä)'\n"
            "üìå –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–ï –ò–ú–ï–ù:\n"
            "–í —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –º–æ–≥—É—Ç –≤—Å—Ç—Ä–µ—á–∞—Ç—å—Å—è —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–µ/—Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–º–µ–Ω.\n"
            "–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–π –∏—Ö —Å –ø–æ–ª–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ:\n\n"
            "–ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–∏–∫–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è (–ø—Ä–∏–º–µ–Ω—è–π –∫–æ –í–°–ï–ú —É—á–∞—Å—Ç–Ω–∏–∫–∞–º):\n"
            "   ‚Ä¢ –£–º–µ–Ω—å—à–∏—Ç–µ–ª—å–Ω—ã–µ: –°–≤–µ—Ç–∞‚Üí–°–≤–µ—Ç–ª–∞–Ω–∞, –õ–µ—à–∞‚Üí–ê–ª–µ–∫—Å–µ–π, –°–∞—à–∞‚Üí–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –∏ —Ç.–¥.\n"
            "   ‚Ä¢ –ü–æ —Ñ–∞–º–∏–ª–∏–∏: –¢–∏–º—á–µ–Ω–∫–æ‚Üí–ê–ª–µ–∫—Å–µ–π –¢–∏–º—á–µ–Ω–∫–æ, –ö–æ—Ä–æ—Ç–∫–æ–≤–∞‚Üí–°–≤–µ—Ç–ª–∞–Ω–∞ –ö–æ—Ä–æ—Ç–∫–æ–≤–∞ –∏ —Ç.–¥.\n"
            "   ‚Ä¢ –¢–æ–ª—å–∫–æ –∏–º—è: –ê–ª–µ–∫—Å–µ–π‚Üí–ê–ª–µ–∫—Å–µ–π –¢–∏–º—á–µ–Ω–∫–æ (–µ—Å–ª–∏ –æ–¥–∏–Ω —Ç–∞–∫–æ–π –≤ —Å–ø–∏—Å–∫–µ)\n\n"
            "   ‚ö° –ù–ï –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π—Å—è –ø—Ä–∏–º–µ—Ä–∞–º–∏! –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –í–ï–°–¨ —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤—ã—à–µ.\n"
            "   ‚ö° –í —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –ø—Ä–æ—Ç–æ–∫–æ–ª–µ –∏—Å–ø–æ–ª—å–∑—É–π –ü–û–õ–ù–û–ï –ò–ú–Ø –∏–∑ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤!\n"
        )
    elif participants:
        # –ï—Å–ª–∏ –Ω–µ—Ç speaker_mapping, –Ω–æ –µ—Å—Ç—å —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ
        from src.services.participants_service import participants_service
        # –í–ê–ñ–ù–û: format_participants_for_llm –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∏–º–µ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç "–ò–º—è –§–∞–º–∏–ª–∏—è" (–±–µ–∑ –æ—Ç—á–µ—Å—Ç–≤–∞)
        formatted_participants = participants_service.format_participants_for_llm(participants)
        
        participants_info = (
            f"\n\n{'‚ïê' * 63}\n"
            "üéØ –ü–û–õ–ù–´–ô –°–ü–ò–°–û–ö –£–ß–ê–°–¢–ù–ò–ö–û–í –í–°–¢–†–ï–ß–ò (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ)\n"
            f"{'‚ïê' * 63}\n\n"
            f"{formatted_participants}\n\n"
            "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n"
            "‚ïë  üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø     ‚ïë\n"
            "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n"
            "1Ô∏è‚É£ –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û –ò–ú–ï–ù–ê –ò–ó –°–ü–ò–°–ö–ê –í–´–®–ï!\n"
            "   –ó–ê–ü–†–ï–©–ï–ù–û –¥–æ–±–∞–≤–ª—è—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –≤ —Å–ø–∏—Å–∫–µ!\n"
            "   ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: '–ö–æ–ª–ª–µ–≥–∞ –∏–∑ –û–†–¢', '–ö–æ–ª–ª–µ–≥–∏ –∏–∑ ERP', '–ö–æ–º–∞–Ω–¥–∞'\n"
            "   ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–º–µ–Ω–∞ –∏–∑ —Å–ø–∏—Å–∫–∞\n\n"
            "2Ô∏è‚É£ –§–û–†–ú–ê–¢ –ò–ú–ï–ù: '–ò–º—è –§–∞–º–∏–ª–∏—è' (–ë–ï–ó –æ—Ç—á–µ—Å—Ç–≤–∞)!\n"
            "   ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: '–°–æ—Ñ—å—è' (—Ç–æ–ª—å–∫–æ –∏–º—è)\n"
            "   ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: '–í–∏–∫—É–ª–∏–Ω' (—Ç–æ–ª—å–∫–æ —Ñ–∞–º–∏–ª–∏—è)\n"
            "   ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: '–û—Å–∏–ø–æ–≤–∞ –°–æ—Ñ—å—è –Æ—Ä—å–µ–≤–Ω–∞' (—Å –æ—Ç—á–µ—Å—Ç–≤–æ–º)\n"
            "   ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: '–°–æ—Ñ—å—è –û—Å–∏–ø–æ–≤–∞', '–ì–∞–ª–∏–Ω–∞ –Ø–º–∫–∏–Ω–∞', '–í–ª–∞–¥–∏–º–∏—Ä –ì–æ–ª–∏–∫–æ–≤'\n\n"
            "3Ô∏è‚É£ –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–ï –°–û–ö–†–ê–©–ï–ù–ù–´–• –ò–ú–ï–ù:\n"
            "   –í —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–º–∏.\n"
            "   –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞–π–¥–∏ –≤ —Å–ø–∏—Å–∫–µ –≤—ã—à–µ –ü–û–õ–ù–û–ï —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:\n\n"
            "   üìã –ü–†–ê–í–ò–õ–ê –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–Ø:\n"
            "   ‚Ä¢ '–°–≤–µ—Ç–∞', '–°–≤–µ—Ç–æ—á–∫–∞' ‚Üí –Ω–∞–π–¥–∏ '–°–≤–µ—Ç–ª–∞–Ω–∞' –≤ —Å–ø–∏—Å–∫–µ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª–Ω–æ–µ –∏–º—è\n"
            "   ‚Ä¢ '–õ–µ—à–∞', '–ê–ª—ë—à–∞' ‚Üí –Ω–∞–π–¥–∏ '–ê–ª–µ–∫—Å–µ–π' –≤ —Å–ø–∏—Å–∫–µ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª–Ω–æ–µ –∏–º—è\n"
            "   ‚Ä¢ '–ì–∞–ª—è' ‚Üí –Ω–∞–π–¥–∏ '–ì–∞–ª–∏–Ω–∞' –≤ —Å–ø–∏—Å–∫–µ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª–Ω–æ–µ –∏–º—è\n"
            "   ‚Ä¢ '–í–æ–ª–æ–¥—å', '–í–æ–≤–∞' ‚Üí –Ω–∞–π–¥–∏ '–í–ª–∞–¥–∏–º–∏—Ä' –≤ —Å–ø–∏—Å–∫–µ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª–Ω–æ–µ –∏–º—è\n"
            "   ‚Ä¢ '–°—Ç–∞—Å' ‚Üí –Ω–∞–π–¥–∏ '–°—Ç–∞–Ω–∏—Å–ª–∞–≤' –∏–ª–∏ '–°–≤—è—Ç–æ—Å–ª–∞–≤' –≤ —Å–ø–∏—Å–∫–µ\n"
            "   ‚Ä¢ '–í–∏–∫—É–ª–∏–Ω', '–¢–∏–º—á–µ–Ω–∫–æ' (—Ñ–∞–º–∏–ª–∏—è) ‚Üí –Ω–∞–π–¥–∏ –≤ —Å–ø–∏—Å–∫–µ –ø–æ —Ñ–∞–º–∏–ª–∏–∏\n"
            "   ‚Ä¢ '–ú–∞—Ä–∞—Ç' (–∏–º—è) ‚Üí –Ω–∞–π–¥–∏ –≤ —Å–ø–∏—Å–∫–µ –ø–æ –∏–º–µ–Ω–∏ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª–Ω–æ–µ –∏–º—è\n\n"
            "4Ô∏è‚É£ –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–î –î–û–ë–ê–í–õ–ï–ù–ò–ï–ú –í –ü–†–û–¢–û–ö–û–õ:\n"
            "   –î–ª—è –ö–ê–ñ–î–û–ì–û —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏:\n"
            "   ‚úì –ù–∞–π–¥–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ —Å–ø–∏—Å–∫–µ –≤—ã—à–µ\n"
            "   ‚úì –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–ß–ù–û–ï –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞ (–ò–º—è –§–∞–º–∏–ª–∏—è)\n"
            "   ‚úì –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ - –ù–ï –≤–∫–ª—é—á–∞–π –≤ –ø—Ä–æ—Ç–æ–∫–æ–ª\n\n"
            "‚ö° –í–ê–ñ–ù–û: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –í–ï–°–¨ —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤—ã—à–µ!\n"
            "‚ö° –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π –∏–º–µ–Ω–∞! –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∏–∑ —Å–ø–∏—Å–∫–∞!\n"
            "‚ö° –ü—Ä–∏ –º–∞–ª–µ–π—à–µ–º —Å–æ–º–Ω–µ–Ω–∏–∏ - —Å–æ–ø–æ—Å—Ç–∞–≤—å —Å –ø–æ–ª–Ω—ã–º —Å–ø–∏—Å–∫–æ–º!\n\n"
        )
    else:
        # –ù–µ—Ç –Ω–∏ speaker_mapping, –Ω–∏ participants - –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–∑ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
        participants_info = (
            f"\n\n{'‚ïê' * 63}\n"
            "‚öôÔ∏è –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –£–ß–ê–°–¢–ù–ò–ö–û–í –ò–ó –¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–ò\n"
            f"{'‚ïê' * 63}\n\n"
            "–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω. –û–ø—Ä–µ–¥–µ–ª–∏ –∏–º–µ–Ω–∞ –∏–∑ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏.\n\n"
            "üìã –ü–†–ê–í–ò–õ–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø:\n\n"
            "1Ô∏è‚É£ –ò–©–ò –Ø–í–ù–´–ï –£–ü–û–ú–ò–ù–ê–ù–ò–Ø:\n"
            "   ‚Ä¢ –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è: '–ú–µ–Ω—è –∑–æ–≤—É—Ç –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤', '–Ø ‚Äî –ú–∞—Ä–∏—è'\n"
            "   ‚Ä¢ –û–±—Ä–∞—â–µ–Ω–∏—è: '–°–≤–µ—Ç–∞, –∫–∞–∫ –¥—É–º–∞–µ—à—å?', '–ü–µ—Ç—Ä–æ–≤, —Ä–∞—Å—Å–∫–∞–∂–∏ –æ –∑–∞–¥–∞—á–µ'\n"
            "   ‚Ä¢ –£–ø–æ–º–∏–Ω–∞–Ω–∏—è: '–ö–∞–∫ —Å–∫–∞–∑–∞–ª –ò–≤–∞–Ω...', '–ù—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å —É –ú–∞—Ä–∏–∏'\n\n"
            "2Ô∏è‚É£ –§–û–†–ú–ê–¢ –ò–ú–ï–ù:\n"
            "   ‚Ä¢ –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ: '–ò–º—è –§–∞–º–∏–ª–∏—è' (–ë–ï–ó –æ—Ç—á–µ—Å—Ç–≤–∞)\n"
            "   ‚Ä¢ –ï—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ —Ç–æ–ª—å–∫–æ –∏–º—è: '–ò–≤–∞–Ω'\n"
            "   ‚Ä¢ –ï—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–∞ —Ç–æ–ª—å–∫–æ —Ñ–∞–º–∏–ª–∏—è: '–ü–µ—Ç—Ä–æ–≤'\n"
            "   ‚Ä¢ –ü—Ä–µ–æ–±—Ä–∞–∑—É–π —É–º–µ–Ω—å—à–∏—Ç–µ–ª—å–Ω—ã–µ: –°–≤–µ—Ç–∞‚Üí–°–≤–µ—Ç–ª–∞–Ω–∞, –õ–µ—à–∞‚Üí–ê–ª–µ–∫—Å–µ–π, –í–æ–ª–æ–¥—è‚Üí–í–ª–∞–¥–∏–º–∏—Ä\n\n"
            "3Ô∏è‚É£ –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–ï –°–û –°–ü–ò–ö–ï–†–ê–ú–ò:\n"
            "   ‚Ä¢ –°–æ–ø–æ—Å—Ç–∞–≤—å –∫–∞–∂–¥—É—é –º–µ—Ç–∫—É (SPEAKER_1, SPEAKER_2...) —Å –∏–º–µ–Ω–µ–º –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ\n"
            "   ‚Ä¢ –ï—Å–ª–∏ –∏–º—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ù–ï–í–û–ó–ú–û–ñ–ù–û - –æ—Å—Ç–∞–≤—å –º–µ—Ç–∫—É —Å–ø–∏–∫–µ—Ä–∞ –∫–∞–∫ –µ—Å—Ç—å\n"
            "   ‚Ä¢ –ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤\\n–°–ü–ï–ê–ö–ïR_2\\n–°–≤–µ—Ç–ª–∞–Ω–∞ –ö–æ—Ä–æ—Ç–∫–æ–≤–∞\\n–°–ü–ï–ê–ö–ïR_4'\n\n"
            "4Ô∏è‚É£ –°–¢–†–û–ì–ò–ï –ó–ê–ü–†–ï–¢–´:\n"
            "   ‚ùå –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∏–º–µ–Ω–∞, –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏\n"
            "   ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π '–£—á–∞—Å—Ç–Ω–∏–∫ 1', '–ö–æ–ª–ª–µ–≥–∞', '–ß–µ–ª–æ–≤–µ–∫ –ê', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'\n"
            "   ‚ùå –ù–ï –¥—É–±–ª–∏—Ä—É–π: –µ—Å–ª–∏ –°–≤–µ—Ç–∞ = SPEAKER_1, –Ω–µ –¥–æ–±–∞–≤–ª—è–π –°–≤–µ—Ç–ª–∞–Ω—É –æ—Ç–¥–µ–ª—å–Ω–æ\n"
            "   ‚ùå –ù–ï –∑–∞–º–µ–Ω—è–π SPEAKER_N –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏—è —Ç–∏–ø–∞ '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –≤—Å—Ç—Ä–µ—á–∏'\n\n"
            "üí° –ü–û–î–°–ö–ê–ó–ö–ò:\n"
            "   ‚Ä¢ –ù–∞—á–∞–ª–æ –≤—Å—Ç—Ä–µ—á–∏ - —á–∞—Å—Ç–æ —Ç–∞–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è\n"
            "   ‚Ä¢ –û–±—Ä–∞—â–µ–Ω–∏—è –ø–æ –∏–º–µ–Ω–∏ - —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫\n"
            "   ‚Ä¢ –ö–æ–Ω—Ç–µ–∫—Å—Ç: '–Ω–∞—à —Ç–∏–º–ª–∏–¥ –ê–ª–µ–∫—Å–µ–π', '–º–µ–Ω–µ–¥–∂–µ—Ä –ú–∞—Ä–∏—è'\n"
            "   ‚Ä¢ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–µ—Ç? ‚Üí –û—Å—Ç–∞–≤—å SPEAKER_N\n\n"
        )

    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Å—Ç—Ä–µ—á–µ
    meeting_info = ""
    if meeting_topic or meeting_date or meeting_time:
        meeting_info = "\n\n" + "‚ïê" * 63 + "\n"
        meeting_info += "–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –í–°–¢–†–ï–ß–ï\n"
        meeting_info += "‚ïê" * 63 + "\n\n"

        if meeting_topic:
            meeting_info += f"üìã –¢–µ–º–∞: {meeting_topic}\n"
        if meeting_date:
            meeting_info += f"üìÖ –î–∞—Ç–∞: {meeting_date}\n"
        if meeting_time:
            meeting_info += f"üïê –í—Ä–µ–º—è: {meeting_time}\n"
        meeting_info += "\n"


    
    variables_str = "\n".join([f"- {key}: {desc}" for key, desc in template_variables.items()])

    # –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç
    user_prompt = (
        "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n"
        "–ò–°–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê\n"
        "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n"
        f"{transcription_text}\n"
        f"{participants_info}"
        f"{meeting_info}"
        "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n"
        "–ü–û–õ–Ø –î–õ–Ø –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø\n"
        "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n"
        f"{variables_str}\n\n"
        "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n"
        "–ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –ò–ó–í–õ–ï–ß–ï–ù–ò–Æ\n"
        "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n"
        
        "üìã –°–¢–†–£–ö–¢–£–†–ê –í–´–í–û–î–ê:\n"
        "- –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON-–æ–±—ä–µ–∫—Ç (–±–µ–∑ ```json, –±–µ–∑ markdown)\n"
        "- –ò—Å–ø–æ–ª—å–∑—É–π –°–¢–†–û–ì–û —ç—Ç–∏ –∫–ª—é—á–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–æ–ª–µ–π\n"
        "- –°–æ—Ö—Ä–∞–Ω—è–π –ø–æ—Ä—è–¥–æ–∫ –∫–ª—é—á–µ–π –∫–∞–∫ –≤ —Å–ø–∏—Å–∫–µ –≤—ã—à–µ\n"
        "- –ö–∞–∂–¥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî —Å—Ç—Ä–æ–∫–∞ (UTF-8), –ë–ï–ó –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –∏–ª–∏ –º–∞—Å—Å–∏–≤–æ–≤\n\n"
        
        "üìù –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –¢–ï–ö–°–¢–ê:\n"
        "- –î–ª—è —Å–ø–∏—Å–∫–æ–≤/–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–π: –∫–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏, –Ω–∞—á–∏–Ω–∞–π —Å '- ' (–¥–µ—Ñ–∏—Å + –ø—Ä–æ–±–µ–ª)\n"
        "- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –Ω—É–º–µ—Ä–∞—Ü–∏—é (1. 2. 3.), —Ç–æ–ª—å–∫–æ –¥–µ—Ñ–∏—Å—ã\n"
        "- –ù–ï —Å—Ç–∞–≤—å —Ç–æ—á–∫—É –≤ –∫–æ–Ω—Ü–µ –ø—É–Ω–∫—Ç–∞ —Å–ø–∏—Å–∫–∞\n"
        "- –î–ª—è –∏–º–µ–Ω/—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: —Ä–∞–∑–¥–µ–ª—è–π —Ç–æ—á–∫–æ–π —Å –∑–∞–ø—è—Ç–æ–π (;)\n"
        "- –î–ª—è –¥–∞—Ç/–≤—Ä–µ–º–µ–Ω–∏: —Å–æ—Ö—Ä–∞–Ω—è–π —Ñ–æ—Ä–º–∞—Ç –∫–∞–∫ —É–ø–æ–º—è–Ω—É—Ç –≤ —Ç–µ–∫—Å—Ç–µ\n\n"
        
        "üéØ –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –î–ê–ù–ù–´–•:\n"
        "- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Ñ–∞–∫—Ç—ã –∏–∑ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏\n"
        "- –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É–ø–æ–º—è–Ω—É—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (—Ä–æ–ª—å, —Å—Ä–æ–∫, —Å—É–º–º–∞) ‚Äî —É–∫–∞–∂–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é\n"
        "- –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã –∏–ª–∏ –Ω–µ—è—Å–Ω—ã ‚Äî –ø–∏—à–∏ '–ù–µ —É–∫–∞–∑–∞–Ω–æ'\n"
        "- –£–±–∏—Ä–∞–π –¥—É–±–ª–∏–∫–∞—Ç—ã, –æ–±—ä–µ–¥–∏–Ω—è–π –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ –ø—É–Ω–∫—Ç—ã\n"
        "- –°–æ—Ö—Ä–∞–Ω—è–π —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—é: –ø–æ—Ä—è–¥–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ = –ø–æ—Ä—è–¥–æ–∫ –≤ —Ç–µ–∫—Å—Ç–µ\n\n"
        
        "üîç –û–ë–†–ê–ë–û–¢–ö–ê –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –ì–û–í–û–†–Ø–©–ò–•:\n"
        "- –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–∏–∞—Ä–∏–∑–∞—Ü–∏—è: –∏—Å–ø–æ–ª—å–∑—É–π –º–µ—Ç–∫–∏ '–°–ø–∏–∫–µ—Ä 1:', '–°–ø–∏–∫–µ—Ä 2:' –∏ —Ç.–¥.\n"
        "- –û–ø—Ä–µ–¥–µ–ª—è–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –∏—Ö –≤—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏–π\n"
        "- –£–∫–∞–∑—ã–≤–∞–π –∫—Ç–æ –ø—Ä–∏–Ω—è–ª —Ä–µ—à–µ–Ω–∏–µ –∏–ª–∏ –≤–∑—è–ª –Ω–∞ —Å–µ–±—è –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ\n"
        "- –ï—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω—ã –∏–º–µ–Ω–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –ò–•, –∞ –Ω–µ –º–µ—Ç–∫–∏ —Å–ø–∏–∫–µ—Ä–æ–≤\n"
        "- –§–æ—Ä–º–∞—Ç –∑–∞–¥–∞—á–∏: '–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ ‚Äî –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: –ò–º—è –§–∞–º–∏–ª–∏—è' (–±–µ–∑ —Ä–æ–ª–∏!)\n"
        "- –§–æ—Ä–º–∞—Ç —Ä–µ—à–µ–Ω–∏—è: '–†–µ—à–µ–Ω–∏–µ. –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä: –ò–º—è –§–∞–º–∏–ª–∏—è' (–µ—Å–ª–∏ –≤–∞–∂–Ω–æ –∫—Ç–æ –ø—Ä–∏–Ω—è–ª)\n\n"
        
        "üßπ –ß–¢–û –û–¢–§–ò–õ–¨–¢–†–û–í–´–í–ê–¢–¨:\n"
        "- –ú–µ–∂–¥–æ–º–µ—Ç–∏—è, –∑–∞–ø–∏–Ω–∫–∏, –ø–æ–≤—Ç–æ—Ä—ã —Å–ª–æ–≤\n"
        "- –í–≤–æ–¥–Ω—ã–µ —Ñ—Ä–∞–∑—ã –±–µ–∑ —Å–º—ã—Å–ª–æ–≤–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏\n"
        "- –†–∞–∑–≥–æ–≤–æ—Ä—ã –Ω–µ –ø–æ —Ç–µ–º–µ –≤—Å—Ç—Ä–µ—á–∏\n"
        "- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ('–Ω–µ —Å–ª—ã—à–Ω–æ', '–ø–æ–≤—Ç–æ—Ä–∏—Ç–µ' –∏ —Ç.–¥.)\n\n"
        
        "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n"
        "–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø\n"
        "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n"
        
        "‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:\n"
        "{\n"
        "  \"participants\": \"–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤\\n–ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–∞\\n–ê–ª–µ–∫—Å–µ–π –°–∏–¥–æ—Ä–æ–≤\",\n"
        "  \"main_topic\": \"–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–π –∫–∞–º–ø–∞–Ω–∏–∏ –Ω–∞ Q2 2024\",\n"
        "  \"decisions\": \"- –£–≤–µ–ª–∏—á–∏—Ç—å –±—é–¥–∂–µ—Ç –Ω–∞ digital-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –Ω–∞ 30%\\n- –£—Ç–≤–µ—Ä–¥–∏—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –≤ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö\\n- –û—Ç–ª–æ–∂–∏—Ç—å –∑–∞–ø—É—Å–∫ —Ä–µ–∫–ª–∞–º—ã –Ω–∞ –¢–í –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–≤–∞—Ä—Ç–∞–ª–∞\",\n"
        "  \"action_items\": \"- –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é –Ω–æ–≤–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∫ 15 –º–∞—Ä—Ç–∞ ‚Äî –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: –ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–∞\\n- –°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –±—é–¥–∂–µ—Ç —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º –æ—Ç–¥–µ–ª–æ–º ‚Äî –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤\\n- –ü—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ ‚Äî –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: –ê–ª–µ–∫—Å–µ–π –°–∏–¥–æ—Ä–æ–≤\",\n"
        "  \"deadlines\": \"- –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: 15 –º–∞—Ä—Ç–∞ 2024\\n- –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞: –¥–æ –∫–æ–Ω—Ü–∞ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏\\n- –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤: –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–æ–≤–µ—â–∞–Ω–∏—é\",\n"
        "  \"issues\": \"- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –æ—Ö–≤–∞—Ç —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ —Ç–µ–∫—É—â–∏–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏\\n- –í—ã—Å–æ–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞\\n- –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—Ä–µ–∞—Ç–∏–≤–æ–≤\"\n"
        "}\n\n"
        "–û–ë–†–ê–¢–ò–¢–ï –í–ù–ò–ú–ê–ù–ò–ï: –í action_items —É–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –ò–ú–ï–ù–ê –±–µ–∑ —Ä–æ–ª–µ–π –≤ —Å–∫–æ–±–∫–∞—Ö!\n\n"
        
        "‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:\n"
        "{\n"
        "  \"participants\": [\"–ò–≤–∞–Ω\", \"–ú–∞—Ä–∏—è\"],  ‚ùå –º–∞—Å—Å–∏–≤ –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∏\n"
        "  \"decisions\": \"1) –†–µ—à–µ–Ω–∏–µ –æ–¥–∏–Ω 2) –†–µ—à–µ–Ω–∏–µ –¥–≤–∞.\",  ‚ùå –Ω—É–º–µ—Ä–∞—Ü–∏—è + —Ç–æ—á–∫–∏\n"
        "  \"action_items\": \"–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é (–ú–∞—Ä–∏—è)\",  ‚ùå –±–µ–∑ –¥–µ—Ñ–∏—Å–∞, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç\n"
        "  \"deadlines\": \"–°—Ä–æ—á–Ω–æ, –∫–∞–∫ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ\",  ‚ùå –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏, —Ö–æ—Ç—è –æ–Ω–∞ –º–æ–≥–ª–∞ –±—ã—Ç—å\n"
        "  \"extra_field\": \"...\",  ‚ùå –ø–æ–ª–µ –Ω–µ –∏–∑ —Å–ø–∏—Å–∫–∞\n"
        "  \"budget\": \"50000 —Ä—É–±–ª–µ–π (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ)\"  ‚ùå –¥–æ–º—ã—Å–ª—ã –≤ —Å–∫–æ–±–∫–∞—Ö\n"
        "}\n\n"
        
        "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n"
        "–°–ü–ï–¶–ò–§–ò–ß–ù–´–ï –ü–†–ê–í–ò–õ–ê –ü–û –¢–ò–ü–ê–ú –ü–û–õ–ï–ô\n"
        "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n"
        f"{_build_field_specific_rules(template_variables)}\n\n"
        "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n"
        
        "–ù–ê–ß–ò–ù–ê–ô –ê–ù–ê–õ–ò–ó. –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.\n"
    )
    return user_prompt


class OpenAIProvider(LLMProvider):
    """–ü—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è OpenAI GPT"""
    
    def __init__(self):
        self.client = None
        self.http_client = None
        if settings.openai_api_key:
            openai.api_key = settings.openai_api_key
            # –°–æ–∑–¥–∞–µ–º HTTP –∫–ª–∏–µ–Ω—Ç —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ SSL –∏ —Ç–∞–π–º–∞—É—Ç–æ–º –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            import httpx
            self.http_client = httpx.Client(verify=settings.ssl_verify, timeout=settings.llm_timeout_seconds)
            self.client = openai.OpenAI(
                api_key=settings.openai_api_key,
                base_url=settings.openai_base_url,
                http_client=self.http_client
            )
    
    def is_available(self) -> bool:
        return self.client is not None and settings.openai_api_key is not None
    
    async def generate_protocol(self, transcription: str, template_variables: Dict[str, str], diarization_data: Optional[Dict[str, Any]] = None, **kwargs) -> Dict[str, Any]:
        """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª –∏—Å–ø–æ–ª—å–∑—É—è OpenAI GPT (–î–≤—É—Ö—ç—Ç–∞–ø–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å)"""
        if not self.is_available():
            raise ValueError("OpenAI API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ kwargs
        participants = kwargs.get('participants')
        meeting_metadata = {
            'meeting_topic': kwargs.get('meeting_topic', ''),
            'meeting_date': kwargs.get('meeting_date', ''),
            'meeting_time': kwargs.get('meeting_time', '')
        }

        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —ç—Ç–∞–ø–∞ (–ê–Ω–∞–ª–∏–∑)
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º formatted_transcript –µ—Å–ª–∏ –µ—Å—Ç—å, —Ç–∞–∫ –∫–∞–∫ –æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ—Ç–∫–∏ —Å–ø–∏–∫–µ—Ä–æ–≤
        analysis_transcription = transcription
        if diarization_data and diarization_data.get("formatted_transcript"):
            analysis_transcription = diarization_data["formatted_transcript"]

        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        participants_list_str = "–ù–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω"
        if participants:
            try:
                from src.services.participants_service import participants_service
                participants_list_str = participants_service.format_participants_for_llm(participants)
            except ImportError:
                participants_list_str = "\\n".join([f"- {p.get('name', 'Unknown')}" for p in participants])

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –ª–∏ meeting_type –∏–∑ speaker_mapping_service
        provided_meeting_type = kwargs.get('meeting_type')
        provided_speaker_mapping = kwargs.get('speaker_mapping')

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–¥–µ–ª—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–¥–ª—è –æ–±–æ–∏—Ö —ç—Ç–∞–ø–æ–≤)
        # –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω openai_model_key, –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –º–æ–¥–µ–ª—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
        selected_model = settings.openai_model
        openai_model_key = kwargs.get('openai_model_key')
        
        if openai_model_key:
            try:
                preset = next((p for p in settings.openai_models if p.key == openai_model_key), None)
                if preset:
                    selected_model = preset.model
                    logger.info(f"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –º–æ–¥–µ–ª—å: {selected_model} (–∫–ª—é—á: {openai_model_key})")
            except Exception as e:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–¥–µ–ª—å –ø–æ –∫–ª—é—á—É {openai_model_key}: {e}")
        
        if provided_meeting_type and provided_speaker_mapping:
            # –≠–¢–ê–ü 1 –ø—Ä–æ–ø—É—â–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ speaker_mapping_service
            logger.info(f"‚úÖ –≠–¢–ê–ü 1 –ø—Ä–æ–ø—É—â–µ–Ω: —Ç–∏–ø –≤—Å—Ç—Ä–µ—á–∏ ({provided_meeting_type}) –∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏–∫–µ—Ä–æ–≤ ({len(provided_speaker_mapping)} —Å–ø–∏–∫–µ—Ä–æ–≤) —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã")
            meeting_type = provided_meeting_type
            speaker_mapping = provided_speaker_mapping
        else:
            # –≠–¢–ê–ü 1: –ê–ù–ê–õ–ò–ó (–¢–∏–ø –≤—Å—Ç—Ä–µ—á–∏ + –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏–∫–µ—Ä–æ–≤)
            logger.info("üöÄ –ó–∞–ø—É—Å–∫ –≠–¢–ê–ü–ê 1: –ê–Ω–∞–ª–∏–∑ –≤—Å—Ç—Ä–µ—á–∏ –∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏–∫–µ—Ä–æ–≤")
            
            analysis_system_prompt = build_analysis_system_prompt()
            analysis_user_prompt = build_analysis_prompt(
                transcription=analysis_transcription,
                participants_list=participants_list_str,
                meeting_metadata=meeting_metadata
            )

            analysis_result = await self._call_openai(
                system_prompt=analysis_system_prompt,
                user_prompt=analysis_user_prompt,
                schema=MEETING_ANALYSIS_SCHEMA,
                step_name="Analysis",
                model=selected_model
            )

            meeting_type = analysis_result.get('meeting_type', 'general')
            speaker_mapping = analysis_result.get('speaker_mappings', {})
            
            logger.info(f"‚úÖ –≠–¢–ê–ü 1 –∑–∞–≤–µ—Ä—à–µ–Ω. –¢–∏–ø: {meeting_type}, –°–ø–∏–∫–µ—Ä–æ–≤ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: {len(speaker_mapping)}")

        # –≠–¢–ê–ü 2: –ì–ï–ù–ï–†–ê–¶–ò–Ø (–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–∞)
        logger.info("üöÄ –ó–∞–ø—É—Å–∫ –≠–¢–ê–ü–ê 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞")

        generation_system_prompt = build_generation_system_prompt()
        generation_user_prompt = build_generation_prompt(
            transcription=analysis_transcription, # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é —Å –º–µ—Ç–∫–∞–º–∏
            template_variables=template_variables,
            speaker_mapping=speaker_mapping,
            meeting_type=meeting_type
        )

        generation_result = await self._call_openai(
            system_prompt=generation_system_prompt,
            user_prompt=generation_user_prompt,
            schema=PROTOCOL_DATA_SCHEMA,
            step_name="Generation",
            model=selected_model
        )

        protocol_data = generation_result.get('protocol_data', {})
        
        logger.info(f"‚úÖ –≠–¢–ê–ü 2 –∑–∞–≤–µ—Ä—à–µ–Ω. –ò–∑–≤–ª–µ—á–µ–Ω–æ –ø–æ–ª–µ–π: {len(protocol_data)}")

        # –ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–ª–æ—Å–∫–∏–π —Å–ª–æ–≤–∞—Ä—å, –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç –æ—Å—Ç–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
        # –ù–æ –¥–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞
        final_result = protocol_data.copy()
        final_result['_meeting_type'] = meeting_type
        final_result['_speaker_mapping'] = speaker_mapping
        final_result['_analysis_confidence'] = 0.0 if provided_meeting_type else analysis_result.get('analysis_confidence', 0.0)
        final_result['_quality_score'] = generation_result.get('quality_score', 0.0)

        return final_result

    async def _call_openai(self, system_prompt: str, user_prompt: str, schema: Dict[str, Any], step_name: str, model: str = None) -> Dict[str, Any]:
        """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –≤—ã–∑–æ–≤–∞ OpenAI"""
        
        selected_model = model or settings.openai_model
        # –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å –ø–æ–ø—Ä–æ—â–µ/–±—ã—Å—Ç—Ä–µ–µ, –Ω–æ –ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Å–Ω–æ–≤–Ω—É—é
        
        extra_headers = {}
        if settings.http_referer:
            extra_headers["HTTP-Referer"] = settings.http_referer
        if settings.x_title:
            extra_headers["X-Title"] = settings.x_title

        logger.info(f"–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ OpenAI [{step_name}] —Å –º–æ–¥–µ–ª—å—é {selected_model}")

        async def _api_call():
            return await asyncio.to_thread(
                self.client.chat.completions.create,
                model=selected_model,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt}
                ],
                temperature=0.1,
                response_format={"type": "json_schema", "json_schema": schema},
                extra_headers=extra_headers
            )

        try:
            response = await _api_call()
            content = response.choices[0].message.content
            
            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
            if settings.log_cache_metrics:
                log_cached_tokens_usage(
                    response=response,
                    context=f"generate_protocol_{step_name}",
                    model_name=selected_model,
                    provider="openai"
                )
                
            return safe_json_parse(content, context=f"OpenAI {step_name} response")
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ OpenAI [{step_name}]: {e}")
            raise


class AnthropicProvider(LLMProvider):
    """–ü—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è Anthropic Claude"""
    
    def __init__(self):
        self.client = None
        if settings.anthropic_api_key:
            # –°–æ–∑–¥–∞–µ–º HTTP –∫–ª–∏–µ–Ω—Ç —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ SSL –∏ —Ç–∞–π–º–∞—É—Ç–æ–º –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            import httpx
            http_client = httpx.Client(verify=settings.ssl_verify, timeout=settings.llm_timeout_seconds)
            self.client = Anthropic(
                api_key=settings.anthropic_api_key,
                http_client=http_client
            )
    
    def is_available(self) -> bool:
        return self.client is not None and settings.anthropic_api_key is not None
    
    async def generate_protocol(self, transcription: str, template_variables: Dict[str, str], diarization_data: Optional[Dict[str, Any]] = None, **kwargs) -> Dict[str, Any]:
        """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª –∏—Å–ø–æ–ª—å–∑—É—è Anthropic Claude (–î–≤—É—Ö—ç—Ç–∞–ø–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å)"""
        if not self.is_available():
            raise ValueError("Anthropic API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ kwargs
        participants = kwargs.get('participants')
        meeting_metadata = {
            'meeting_topic': kwargs.get('meeting_topic', ''),
            'meeting_date': kwargs.get('meeting_date', ''),
            'meeting_time': kwargs.get('meeting_time', '')
        }

        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —ç—Ç–∞–ø–∞ (–ê–Ω–∞–ª–∏–∑)
        analysis_transcription = transcription
        if diarization_data and diarization_data.get("formatted_transcript"):
            analysis_transcription = diarization_data["formatted_transcript"]

        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        participants_list_str = "–ù–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω"
        if participants:
            try:
                from src.services.participants_service import participants_service
                participants_list_str = participants_service.format_participants_for_llm(participants)
            except ImportError:
                participants_list_str = "\\n".join([f"- {p.get('name', 'Unknown')}" for p in participants])

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –ª–∏ meeting_type –∏–∑ speaker_mapping_service
        provided_meeting_type = kwargs.get('meeting_type')
        provided_speaker_mapping = kwargs.get('speaker_mapping')
        
        if provided_meeting_type and provided_speaker_mapping:
            # –≠–¢–ê–ü 1 –ø—Ä–æ–ø—É—â–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ speaker_mapping_service
            logger.info(f"‚úÖ [Anthropic] –≠–¢–ê–ü 1 –ø—Ä–æ–ø—É—â–µ–Ω: —Ç–∏–ø –≤—Å—Ç—Ä–µ—á–∏ ({provided_meeting_type}) –∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏–∫–µ—Ä–æ–≤ ({len(provided_speaker_mapping)} —Å–ø–∏–∫–µ—Ä–æ–≤) —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã")
            meeting_type = provided_meeting_type
            speaker_mapping = provided_speaker_mapping
        else:
            # –≠–¢–ê–ü 1: –ê–ù–ê–õ–ò–ó
            logger.info("üöÄ [Anthropic] –ó–∞–ø—É—Å–∫ –≠–¢–ê–ü–ê 1: –ê–Ω–∞–ª–∏–∑ –≤—Å—Ç—Ä–µ—á–∏")
            
            analysis_system_prompt = build_analysis_system_prompt()
            analysis_user_prompt = build_analysis_prompt(
                transcription=analysis_transcription,
                participants_list=participants_list_str,
                meeting_metadata=meeting_metadata
            )

            # –ò—Å–ø–æ–ª—å–∑—É–µ–º prompt caching –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —ç—Ç–∞–ø–∞ (–≥–¥–µ –±–æ–ª—å—à–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è)
            analysis_result = await self._call_anthropic(
                system_prompt=analysis_system_prompt,
                user_prompt=analysis_user_prompt,
                step_name="Analysis",
                use_caching=True,
                transcription_for_caching=analysis_transcription
            )

            meeting_type = analysis_result.get('meeting_type', 'general')
            speaker_mapping = analysis_result.get('speaker_mappings', {})
            
            logger.info(f"‚úÖ [Anthropic] –≠–¢–ê–ü 1 –∑–∞–≤–µ—Ä—à–µ–Ω. –¢–∏–ø: {meeting_type}")

        # –≠–¢–ê–ü 2: –ì–ï–ù–ï–†–ê–¶–ò–Ø
        logger.info("üöÄ [Anthropic] –ó–∞–ø—É—Å–∫ –≠–¢–ê–ü–ê 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞")

        generation_system_prompt = build_generation_system_prompt()
        generation_user_prompt = build_generation_prompt(
            transcription=analysis_transcription,
            template_variables=template_variables,
            speaker_mapping=speaker_mapping,
            meeting_type=meeting_type
        )

        # –¢–æ–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º caching, —Ç–∞–∫ –∫–∞–∫ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —Ç–∞ –∂–µ
        generation_result = await self._call_anthropic(
            system_prompt=generation_system_prompt,
            user_prompt=generation_user_prompt,
            step_name="Generation",
            use_caching=True,
            transcription_for_caching=analysis_transcription
        )

        protocol_data = generation_result.get('protocol_data', {})
        
        logger.info(f"‚úÖ [Anthropic] –≠–¢–ê–ü 2 –∑–∞–≤–µ—Ä—à–µ–Ω.")

        # –ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è
        final_result = protocol_data.copy()
        final_result['_meeting_type'] = meeting_type
        final_result['_speaker_mapping'] = speaker_mapping
        final_result['_analysis_confidence'] = analysis_result.get('analysis_confidence', 0.0)
        final_result['_quality_score'] = generation_result.get('quality_score', 0.0)

        return final_result

    async def _call_anthropic(self, system_prompt: str, user_prompt: str, step_name: str, use_caching: bool = False, transcription_for_caching: str = "") -> Dict[str, Any]:
        """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –≤—ã–∑–æ–≤–∞ Anthropic"""
        
        extra_headers = {}
        if settings.http_referer:
            extra_headers["HTTP-Referer"] = settings.http_referer
        if settings.x_title:
            extra_headers["X-Title"] = settings.x_title

        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —É—á–µ—Ç–æ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
        system_block = system_prompt
        messages = [{"role": "user", "content": user_prompt}]

        if use_caching and settings.enable_prompt_caching and len(transcription_for_caching) >= settings.min_transcription_length_for_cache:
            logger.debug(f"–ò—Å–ø–æ–ª—å–∑—É–µ–º Anthropic prompt caching –¥–ª—è {step_name}")
            system_block, messages = build_anthropic_messages_with_caching(
                system_prompt, transcription_for_caching, user_prompt
            )

        async def _api_call():
            return await asyncio.to_thread(
                self.client.messages.create,
                model="claude-3-haiku-20240307",
                max_tokens=4000,
                temperature=0.1,
                system=system_block,
                messages=messages,
                extra_headers=extra_headers
            )

        try:
            response = await _api_call()
            content = response.content[0].text
            
            if settings.log_cache_metrics:
                log_cached_tokens_usage(
                    response=response,
                    context=f"Anthropic_{step_name}",
                    model_name="claude-3-haiku-20240307",
                    provider="anthropic"
                )
                
            return safe_json_parse(content, context=f"Anthropic {step_name} response")
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ Anthropic [{step_name}]: {e}")
            raise


class YandexGPTProvider(LLMProvider):
    """–ü—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è Yandex GPT"""
    
    def __init__(self):
        self.api_key = settings.yandex_api_key
        self.folder_id = settings.yandex_folder_id
    
    def is_available(self) -> bool:
        return self.api_key is not None and self.folder_id is not None
    
    async def generate_protocol(self, transcription: str, template_variables: Dict[str, str], diarization_data: Optional[Dict[str, Any]] = None, **kwargs) -> Dict[str, Any]:
        """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª –∏—Å–ø–æ–ª—å–∑—É—è Yandex GPT"""
        if not self.is_available():
            raise ValueError("Yandex GPT API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ kwargs
        speaker_mapping = kwargs.get('speaker_mapping')
        meeting_topic = kwargs.get('meeting_topic')
        meeting_date = kwargs.get('meeting_date')
        meeting_time = kwargs.get('meeting_time')
        participants = kwargs.get('participants')

        # –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–π –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç—ã
        system_prompt = _build_system_prompt()

        prompt = _build_user_prompt(
            transcription,
            template_variables,
            diarization_data,
            speaker_mapping,
            meeting_topic,
            meeting_date,
            meeting_time,
            participants
        )
        
        headers = {
            "Authorization": f"Api-Key {self.api_key}",
            "Content-Type": "application/json"
        }
        
        if settings.http_referer:
            headers["Referer"] = settings.http_referer
        if settings.x_title:
            headers["X-Title"] = settings.x_title
        
        data = {
            "modelUri": f"gpt://{self.folder_id}/yandexgpt-lite",
            "completionOptions": {
                "stream": False,
                "temperature": 0.1,
                "maxTokens": 2000
            },
            "messages": [
                {
                    "role": "system",
                    "text": system_prompt
                },
                {
                    "role": "user", 
                    "text": prompt
                }
            ]
        }
        
        try:
            async with httpx.AsyncClient(verify=settings.ssl_verify) as client:
                response = await client.post(
                    "https://llm.api.cloud.yandex.net/foundationModels/v1/completion",
                    headers=headers,
                    json=data,
                    timeout=settings.llm_timeout_seconds
                )
                response.raise_for_status()
                
                result = response.json()
                content = result["result"]["alternatives"][0]["message"]["text"]
                logger.info(f"–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç Yandex GPT (–¥–ª–∏–Ω–∞: {len(content) if content else 0}): {content[:200] if content else 'None'}...")
                
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä JSON
                return safe_json_parse(content, context="Yandex GPT API response")
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Yandex GPT API: {e}")
            raise


class LLMManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏"""
    
    def __init__(self):
        self.providers = {
            "openai": OpenAIProvider(),
            "anthropic": AnthropicProvider(),
            "yandex": YandexGPTProvider()
        }
    
    def get_available_providers(self) -> Dict[str, str]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤"""
        available = {}
        provider_names = {
            "openai": "OpenAI GPT",
            "anthropic": "Anthropic Claude",
            "yandex": "Yandex GPT"
        }
        
        for key, provider in self.providers.items():
            if provider.is_available():
                available[key] = provider_names[key]
        
        return available
    
    async def generate_protocol(self, provider_name: str, transcription: str, 
                              template_variables: Dict[str, str], diarization_data: Optional[Dict[str, Any]] = None, **kwargs) -> Dict[str, Any]:
        """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª –∏—Å–ø–æ–ª—å–∑—É—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞"""
        if provider_name not in self.providers:
            raise ValueError(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä: {provider_name}")
        
        provider = self.providers[provider_name]
        if not provider.is_available():
            raise ValueError(f"–ü—Ä–æ–≤–∞–π–¥–µ—Ä {provider_name} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
        
        # –ü–µ—Ä–µ–¥–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, openai_model_key)
        return await provider.generate_protocol(transcription, template_variables, diarization_data, **kwargs)
    
    async def generate_protocol_with_fallback(self, preferred_provider: str, transcription: str, 
                                            template_variables: Dict[str, str], diarization_data: Optional[Dict[str, Any]] = None, **kwargs) -> Dict[str, Any]:
        """–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏"""
        available_providers = list(self.get_available_providers().keys())
        
        if not available_providers:
            raise ValueError("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤")
        
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä
        providers_to_try = [preferred_provider] if preferred_provider in available_providers else []
        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ
        for provider in available_providers:
            if provider not in providers_to_try:
                providers_to_try.append(provider)
        
        last_error = None
        for provider_name in providers_to_try:
            try:
                logger.info(f"–ü–æ–ø—ã—Ç–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º: {provider_name}")
                result = await self.generate_protocol(provider_name, transcription, template_variables, diarization_data, **kwargs)
                logger.info(f"–£—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –ø—Ä–æ—Ç–æ–∫–æ–ª —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º: {provider_name}")
                return result
            except Exception as e:
                last_error = e
                logger.warning(f"–û—à–∏–±–∫–∞ —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º {provider_name}: {e}")
                continue
        
        # –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏
        raise ValueError(f"–í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏. –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: {last_error}")

async def generate_protocol(
    manager: 'LLMManager',
    provider_name: str,
    transcription: str,
    template_variables: Dict[str, str],
    diarization_data: Optional[Dict[str, Any]] = None,
    diarization_analysis: Optional[Dict[str, Any]] = None,
    participants_list: Optional[str] = None,
    meeting_metadata: Optional[Dict[str, str]] = None,
    **kwargs
) -> Dict[str, Any]:
    """
    –ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞: 2 –∑–∞–ø—Ä–æ—Å–∞ –≤–º–µ—Å—Ç–æ 5-6
    –ó–∞–ø—Ä–æ—Å 1: –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏–∫–µ—Ä–æ–≤ + –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    –ó–∞–ø—Ä–æ—Å 2: –§–∏–Ω–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ + QA

    Args:
        manager: –ú–µ–Ω–µ–¥–∂–µ—Ä LLM
        provider_name: –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        transcription: –¢–µ–∫—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
        template_variables: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω–∞
        diarization_data: –î–∞–Ω–Ω—ã–µ –¥–∏–∞—Ä–∏–∑–∞—Ü–∏–∏
        diarization_analysis: –ê–Ω–∞–ª–∏–∑ –¥–∏–∞—Ä–∏–∑–∞—Ü–∏–∏
        participants_list: –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        meeting_metadata: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤—Å—Ç—Ä–µ—á–∏
        **kwargs: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

    Returns:
        –§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª
    """
    """
    –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª (–æ–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º)
    """
    # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ –º–µ–Ω–µ–¥–∂–µ—Ä
    # Preserve original participants if it exists
    original_participants = kwargs.get('participants')
    
    call_kwargs = kwargs.copy()
    
    # –ü–µ—Ä–µ–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    if participants_list:
        # Only set if not already present or if original was None
        if 'participants' not in call_kwargs:
            call_kwargs['participants'] = participants_list
        
    # –ü–µ—Ä–µ–¥–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤—Å—Ç—Ä–µ—á–∏
    if meeting_metadata:
        call_kwargs.update(meeting_metadata)
        
    # –ü–µ—Ä–µ–¥–∞–µ–º –∞–Ω–∞–ª–∏–∑ –¥–∏–∞—Ä–∏–∑–∞—Ü–∏–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
    if diarization_analysis:
        call_kwargs['diarization_analysis'] = diarization_analysis

    # Restore original participants if it was present, ensuring it takes precedence
    if original_participants is not None:
        call_kwargs['participants'] = original_participants

    return await manager.generate_protocol(
        provider_name=provider_name,
        transcription=transcription,
        template_variables=template_variables,
        diarization_data=diarization_data,
        **call_kwargs
    )


async def generate_protocol_consolidated_simplified(
    manager: 'LLMManager',
    provider_name: str,
    transcription: str,
    template_variables: Dict[str, str],
    participants_list: Optional[str] = None,
    **kwargs
) -> Dict[str, Any]:
    """
    –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –∫–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ –±–µ–∑ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏
    """
    logger.info("–ò—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥")

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –±–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    meeting_metadata = {
        'meeting_topic': kwargs.get('meeting_topic', ''),
        'meeting_date': kwargs.get('meeting_date', ''),
        'meeting_time': kwargs.get('meeting_time', ''),
        'participants': kwargs.get('participants', participants_list or '')
    }

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥
    return await generate_protocol(
        manager=manager,
        provider_name=provider_name,
        transcription=transcription,
        template_variables=template_variables,
        participants_list=participants_list,
        meeting_metadata=meeting_metadata,
        **kwargs
    )


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞ LLM
llm_manager = LLMManager()
