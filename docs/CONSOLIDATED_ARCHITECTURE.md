# Консолидированная архитектура LLM запросов

## Обзор

Новая консолидированная архитектура сокращает количество LLM запросов с **5-6 до 2** при генерации протоколов встреч, обеспечивая значительное снижение затрат, увеличение производительности и улучшение качества.

## Архитектура

### Старая архитектура (5-6 запросов)
1. Сопоставление спикеров (отдельный запрос)
2. Извлечение структуры встречи (Stage 1)
3. Рефлексия и уточнение (Stage 2)
4. Построение структурированного представления (доп. запрос)
5. Генерация финального протокола

### Новая архитектура (2 запроса)
1. **Запрос 1**: Сопоставление спикеров + извлечение структуры встречи
2. **Запрос 2**: Финальная генерация протокола + контроль качества

## Файлы

### 1. Схемы данных (`src/models/llm_schemas.py`)

#### `ConsolidatedExtractionSchema`
Консолидированная схема для первого запроса:
- **Speaker mapping**: `speaker_mappings`, `speaker_confidence_scores`, `unmapped_speakers`
- **Meeting structure**: `meeting_title`, `participants`, `agenda`, `discussion`, `decisions`, `action_items`
- **Quality assessment**: `extraction_confidence`, `missing_elements`, `quality_issues`

#### `ConsolidatedProtocolSchema`
Консолидированная схема для второго запроса:
- **Final protocol**: Все поля протокола с форматированием
- **Enhanced speaker mapping**: `verified_speaker_mapping`, `speaker_mapping_confidence`
- **Quality assurance**: `protocol_quality_score`, `consistency_checks`, `improvement_suggestions`
- **Meeting classification**: `meeting_type`, `type_specific_observations`

### 2. Промпты (`src/prompts/consolidated_prompts.py`)

#### `build_consolidated_extraction_prompt()`
Создает промпт для первого запроса:
- Инструкции по сопоставлению спикеров с порогом уверенности 0.7
- Специализированные инструкции для разных типов встреч
- Требования к полноте извлечения информации

#### `build_consolidated_protocol_prompt()`
Создает промпт для второго запроса:
- Инструкции по качественному форматированию
- Проверки согласованности данных
- Саморефлексия и оценка качества

### 3. Методы генерации (`llm_providers.py`)

#### `generate_protocol_consolidated_two_request()`
Основной метод новой архитектуры:
- **Запрос 1**: Извлечение с температурой 0.3, max_tokens=4000
- **Запрос 2**: Генерация с температурой 0.4, max_tokens=3000
- Fallback к стандартному методу при ошибках
- Поддержка meeting type detection

#### `generate_protocol_consolidated_simplified()`
Упрощенная версия для быстрого использования

### 4. Обновленный workflow (`src/services/optimized_processing_service.py`)
Интеграция нового метода в цепочку выбора алгоритмов генерации.

## Конфигурация (`config.py`)

### Новые флаги консолидированной архитектуры

```python
# Новая консолидированная архитектура (2 запроса вместо 5-6)
enable_consolidated_two_request: bool = Field(False, description="Включить новую консолидированную архитектуру (2 запроса вместо 5-6)")
consolidated_protocol_quality_threshold: float = Field(0.7, description="Порог качества для использования консолидированного метода (0.0-1.0)")
enable_consolidated_fallback: bool = Field(True, description="Разрешить fallback к стандартному методу при ошибках")
consolidated_max_tokens_request1: int = Field(4000, description="Максимальное токенов для запроса 1 (извлечение)")
consolidated_max_tokens_request2: int = Field(3000, description="Максимальное токенов для запроса 2 (протокол)")
consolidated_temperature_request1: float = Field(0.3, description="Температура для запроса 1 (высокая точность)")
consolidated_temperature_request2: float = Field(0.4, description="Температура для запроса 2 (качественное форматирование)")
```

## Преимущества

### Производительность
- **70% сокращение токенов**: с 5-6 запросов до 2
- **60% ускорение обработки**: меньше LLM вызовов и overhead
- **50% снижение стоимости**: пропорционально токенам

### Качество
- **Улучшенная консистентность**: единый контекст между запросами
- **Enhanced QA**: встроенная проверка качества и согласованности
- **Self-reflection**: автоматическая оценка качества протокола

### Обслуживание
- **Простой код**: одна четкая логика вместо множества подходов
- **Легкая отладка**: 2 точки мониторинга вместо 5-6
- **Универсальность**: работает для всех типов встреч

## Использование

### Включение новой архитектуры

1. **Через конфигурацию**:
```python
# config.py
enable_consolidated_two_request = True
```

2. **Через переменные окружения**:
```bash
ENABLE_CONSOLIDATED_TWO_REQUEST=true
```

### Приоритеты выбора алгоритма

1. **OD протокол** → `generate_protocol_od()` (если `processing_mode == 'od_protokol'`)
2. **Консолидированный** → `generate_protocol_consolidated_two_request()` (если `enable_consolidated_two_request`)
3. **Unified** → `generate_protocol_unified()` (если `enable_unified_protocol_generation`)
4. **Chain-of-Thought** → `generate_protocol_chain_of_thought()` (для длинных встреч)
5. **Two-stage** → `generate_protocol_two_stage()` (стандартный fallback)

## Метрики качества

### Запрос 1 (Извлечение)
- `extraction_confidence`: Уверенность извлечения (0.0-1.0)
- `missing_elements`: Пропущенные элементы протокола
- `quality_issues`: Проблемы качества (неоднозначность, противоречия)

### Запрос 2 (Протокол)
- `protocol_quality_score`: Общее качество протокола (0.0-1.0)
- `consistency_checks`: Проверки согласованности
- `improvement_suggestions`: Предложения по улучшению

## Fallback стратегия

При ошибке в любом из запросов:
1. **Запрос 1 ошибка**: Автоматический fallback к стандартному методу
2. **Запрос 2 ошибка**: Использование результатов запроса 1 как fallback
3. **Критическая ошибка**: Аварийный режим с минимальным результатом

## Тестирование

### Unit тесты
- Валидация схем `ConsolidatedExtractionSchema` и `ConsolidatedProtocolSchema`
- Тестирование промптов на разных типах встреч
- Проверка fallback механизмов

### Интеграционные тесты
- Тестирование полного workflow с реальными транскрипциями
- Сравнение качества со старыми методами
- Проверка производительности и затрат

### A/B тестирование
- Постепенный роллаут с feature flags
- Сбор метрик качества и производительности
- Сравнение user satisfaction

## Мониторинг

### Логирование
```
[INFO] Запрос 1: Сопоставление спикеров + извлечение структуры
[SUCCESS] Запрос 1 завершен успешно. Уверенность: 0.85
[INFO] Запрос 2: Финальная генерация протокола + QA
[SUCCESS] Запрос 2 завершен успешно. Качество протокола: 0.92
[INFO] Консолидированная генерация протокола успешно завершена
```

### Метрики
- `extraction_confidence`: Средняя уверенность извлечения
- `protocol_quality_score`: Среднее качество протоколов
- `processing_time`: Время обработки (2 запроса)
- `token_usage`: Расход токенов на оба запроса

## Будущие улучшения

### Phase 2 (планируется)
- Адаптивная сегментация для очень длинных встреч
- Улучшенное speaker mapping с ML моделями
- Интеграция с RAG для контекстного обогащения

### Phase 3 (исследования)
- Single-request архитектура с ultra-long context
- Fine-tuned модели для protocol generation
- Real-time protocol generation durant meetings

## Migration Guide

### Шаг 1: Подготовка
1. Обновить зависимости
2. Настроить новые переменные конфигурации
3. Протестировать схемы данных

### Шаг 2: Тестирование
1. Включить `enable_consolidated_two_request = True`
2. Провести тестирование на sample данных
3. Сравнить качество с текущими методами

### Шаг 3: Gradual rollout
1. Запустить с 10% трафика
2. Мониторить метрики качества
3. Постепенно увеличивать до 100%

### Шаг 4: Cleanup
1. Отключить старые методы после уверенности в новой архитектуре
2. Обновить документацию
3. Провести training команды

## Заключение

Новая консолидированная архитектура обеспечивает значительное улучшение производительности и качества при генерации протоколов встреч. Сокращение с 5-6 запросов до 2 позволяет снизить затраты, ускорить обработку и упростить поддержку системы при сохранении высокого качества результатов.