# Интеграция Deepgram API

## Обзор

Добавлена поддержка Deepgram API для транскрипции и диаризации аудио/видео файлов. Deepgram предоставляет высококачественную облачную транскрипцию с автоматическим разделением говорящих и интеллектуальным форматированием текста.

## Возможности

### Транскрипция
- Поддержка множества аудио и видео форматов
- Высокая точность распознавания речи
- Поддержка различных языков
- Smart Format - автоматическое форматирование текста
- Пунктуация и капитализация
- Разделение на высказывания (utterances)

### Диаризация
- Автоматическое разделение говорящих
- Интеграция с результатами транскрипции
- Точное определение смены говорящих

### Модели
- **Nova-2** - новейшая модель, рекомендуется для большинства случаев
- **Whisper Cloud** - совместимость с Whisper
- **Enhanced** - повышенная точность
- **Base** - базовая модель

## Настройка

### 1. Получение API ключа

1. Зарегистрируйтесь на [Deepgram Console](https://console.deepgram.com/)
2. Создайте новый проект
3. Создайте API ключ в разделе "API Keys"
4. Сохраните ключ в переменной окружения

### 2. Конфигурация

Добавьте следующие переменные в ваш `.env` файл:

```env
# Deepgram API
DEEPGRAM_API_KEY=your_api_key_here
DEEPGRAM_MODEL=nova-2
DEEPGRAM_LANGUAGE=ru

# Режим транскрипции
TRANSCRIPTION_MODE=deepgram

# SSL настройки (для решения проблем с сертификатами)
SSL_VERIFY=false  # Установите true для продакшена
```

### 3. Установка зависимостей

```bash
pip install "deepgram-sdk>=3.0.0,<6.0.0"
```

**Рекомендуемые версии:**
- Минимальная: 5.0.0 (полностью переработанный API)
- Актуальная: 5.1.0 (последняя стабильная версия на момент написания)
- Версии 3.x и 4.x используют устаревший API (PrerecordedOptions)
- Версия 5.x принесла breaking changes: новая структура API, отказ от PrerecordedOptions

**Важно:** Код написан для SDK v5.x! Для версий 3.x-4.x потребуется другая реализация.

## Использование

### Переключение режима транскрипции

Администраторы могут переключать режим транскрипции через команду:

```
/transcription_mode
```

Доступные режимы:
- **Локальная (Whisper)** - локальная транскрипция
- **Облачная (Groq)** - облачная транскрипция через Groq
- **Гибридная** - облачная транскрипция + локальная диаризация
- **Speechmatics** - транскрипция и диаризация через Speechmatics
- **Deepgram** - транскрипция и диаризация через Deepgram
- **Leopard** - локальная транскрипция через Picovoice

### Автоматический fallback

При ошибках Deepgram API система автоматически переключается на локальную транскрипцию через Whisper.

## Конфигурационные параметры

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `deepgram_api_key` | API ключ Deepgram | - |
| `deepgram_model` | Модель для транскрипции | `nova-2` |
| `deepgram_language` | Язык для транскрипции | `ru` |

### Доступные модели

- **nova-2** - новейшая универсальная модель (рекомендуется)
- **whisper-cloud** - Whisper в облаке
- **enhanced** - улучшенная модель для высокой точности
- **base** - базовая модель для быстрой обработки

### Поддерживаемые языки

Deepgram поддерживает более 30 языков, включая:
- `ru` - Русский
- `en` - Английский
- `es` - Испанский
- `fr` - Французский
- `de` - Немецкий
- И многие другие

Полный список доступен в [документации Deepgram](https://developers.deepgram.com/docs/models-languages-overview).

## Ограничения

### Размер файлов
- Максимальный размер определяется настройками системы (`MAX_FILE_SIZE` или `OOM_MAX_FILE_SIZE_MB`)
- Рекомендуемый размер: до 500MB для оптимальной производительности

### Поддерживаемые форматы
- Аудио: MP3, WAV, M4A, FLAC, OGG, AAC
- Видео: MP4, AVI, MOV, MKV

### Лимиты API
- Зависит от вашего тарифного плана Deepgram
- При превышении лимитов система автоматически переключается на локальную транскрипцию

## Обработка ошибок

### Типы ошибок

1. **DeepgramAPIError** - ошибки API Deepgram
   - Неверный API ключ (401)
   - Неверный формат запроса (400)
   - Файл слишком большой (413)
   - Превышен лимит запросов (429)
   - SSL ошибки (certificate verify failed)

2. **CloudTranscriptionError** - общие ошибки облачной транскрипции

### Решение SSL проблем

Если вы получаете ошибку `[SSL: CERTIFICATE_VERIFY_FAILED]`, это означает проблему с SSL сертификатами. Решение:

1. **Отключите SSL верификацию** (для разработки):
   ```env
   SSL_VERIFY=false
   ```

2. **Или обновите сертификаты** (для продакшена):
   ```bash
   # На macOS
   /Applications/Python\ 3.x/Install\ Certificates.command
   
   # На Ubuntu/Debian
   sudo apt-get update && sudo apt-get install ca-certificates
   ```

3. **Или установите корневые сертификаты**:
   ```bash
   pip install --upgrade certifi
   ```

### Fallback стратегия

При ошибке Deepgram API:
1. Логируется ошибка
2. Система переключается на локальную транскрипцию
3. Пользователь уведомляется о переключении
4. Обработка продолжается с Whisper

## Мониторинг

### Логирование

Все операции с Deepgram логируются с уровнем INFO:
- Инициализация клиента
- Отправка запросов
- Получение результатов
- Ошибки и fallback

### Статистика

Мониторинг доступен через административные команды:
- `/status` - общий статус системы
- `/health` - проверка здоровья компонентов
- `/stats` - детальная статистика

## Примеры использования

### Базовое использование

```python
from src.services.deepgram_service import deepgram_service

# Транскрипция без диаризации (SDK v5.x)
result = await deepgram_service.transcribe_file(
    file_path="audio.mp3",
    language="ru"
)

# Транскрипция с диаризацией (SDK v5.x)
result = await deepgram_service.transcribe_file(
    file_path="audio.mp3",
    language="ru",
    enable_diarization=True
)
```

**Примечание:** SDK v5.x использует `client.listen.v1().transcribe_file()` API.

### Интеграция в основной сервис

```python
from src.services.transcription_service import TranscriptionService

service = TranscriptionService()

# Автоматический выбор провайдера на основе настроек
result = await service.transcribe_with_diarization(
    file_path="audio.mp3",
    language="ru"
)
```

## Сравнение с другими провайдерами

| Провайдер | Точность | Скорость | Диаризация | Smart Format | Стоимость |
|-----------|----------|----------|------------|--------------|-----------|
| Whisper (локально) | Высокая | Медленная | Требует дополнительных моделей | Нет | Бесплатно |
| Groq | Высокая | Очень быстрая | Нет | Нет | Платно |
| Speechmatics | Очень высокая | Быстрая | Встроенная | Нет | Платно |
| **Deepgram** | **Очень высокая** | **Очень быстрая** | **Встроенная** | **Да** | **Платно** |
| Leopard | Высокая | Средняя | Нет | Нет | Платно (подписка) |

## Преимущества Deepgram

### Smart Format
- Автоматическое форматирование чисел, дат, времени
- Правильная капитализация имен и названий
- Форматирование валют и адресов

### Высокая скорость
- Одна из самых быстрых систем на рынке
- Оптимизация для real-time обработки

### Точность
- Современные модели на основе нейронных сетей
- Специализированные модели для разных доменов

### Простота интеграции
- Понятный REST API
- Официальные SDK для различных языков
- Подробная документация

## Рекомендации

### Когда использовать Deepgram

- Высокие требования к точности транскрипции
- Необходимость качественной диаризации
- Требуется smart format для удобочитаемости
- Обработка больших объемов аудио
- Важна скорость обработки

### Когда использовать другие провайдеры

- **Whisper (локально)**: ограниченный бюджет, конфиденциальность данных
- **Groq**: максимальная скорость без диаризации
- **Speechmatics**: специализированные домены (медицина, финансы)
- **Leopard**: локальная обработка с offline режимом

## Технические детали

### Версия SDK
Интеграция использует **Deepgram SDK v5.x** с новым API:
- `client.listen.v1().transcribe_file()` вместо `prerecorded.v("1").transcribe_file()`
- Опции передаются как словарь, не объект `PrerecordedOptions`
- Инициализация: `DeepgramClient(api_key=...)` с keyword argument

### API эндпоинт
```
POST https://api.deepgram.com/v1/listen
```

### Параметры запроса
- `model` - модель транскрипции
- `language` - язык аудио
- `smart_format=true` - умное форматирование
- `punctuate=true` - пунктуация
- `utterances=true` - разделение на высказывания
- `diarize=true` - диаризация говорящих

### Формат ответа
```json
{
  "metadata": {
    "request_id": "...",
    "duration": 25.5
  },
  "results": {
    "channels": [{
      "alternatives": [{
        "transcript": "полный текст транскрипции",
        "words": [...]
      }]
    }],
    "utterances": [{
      "speaker": 0,
      "transcript": "текст первого говорящего",
      "start": 0.0,
      "end": 5.5
    }]
  }
}
```

## Стоимость

Deepgram предлагает гибкие тарифные планы:
- **Pay-as-you-go** - оплата за использование
- **Growth** - фиксированная цена с включенными минутами
- **Enterprise** - индивидуальные условия

Первые $200 кредитов бесплатно для новых пользователей.

Подробности на [странице тарифов Deepgram](https://deepgram.com/pricing).

## Поддержка

При возникновении проблем:

1. Проверьте логи системы
2. Убедитесь в правильности API ключа
3. Проверьте лимиты вашего тарифного плана
4. Обратитесь к [документации Deepgram](https://developers.deepgram.com/)
5. Свяжитесь с поддержкой Deepgram через [консоль](https://console.deepgram.com/)

## Ресурсы

- [Официальная документация Deepgram](https://developers.deepgram.com/)
- [Deepgram Console](https://console.deepgram.com/)
- [Deepgram SDK для Python](https://github.com/deepgram/deepgram-python-sdk)
- [Миграция v3 → v5](https://github.com/deepgram/deepgram-python-sdk/blob/main/docs/Migrating-v3-to-v5.md)
- [Примеры использования](https://developers.deepgram.com/docs/getting-started-with-pre-recorded-audio)
- [Поддерживаемые языки](https://developers.deepgram.com/docs/models-languages-overview)

## Обновления

Интеграция Deepgram будет обновляться в соответствии с изменениями в их API. Следите за обновлениями в changelog проекта.

