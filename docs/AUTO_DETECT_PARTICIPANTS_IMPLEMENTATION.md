# Реализация автоматического определения участников из транскрипции

**Дата:** 26 октября 2025  
**Статус:** Реализовано ✅

## Обзор

Добавлена функциональность автоматического определения имен участников из транскрипции с диаризацией, когда список участников не предоставлен пользователем.

## Выбранный подход: Консервативный (Вариант 1)

LLM определяет имена участников **ТОЛЬКО** когда они явно упомянуты в транскрипции. Если не может определить - оставляет метки SPEAKER_1, SPEAKER_2 и т.д.

### Преимущества:
- Минимизирует галлюцинации и ошибки
- Прозрачность (пользователь видит где LLM не смогла определить имя)
- Можно комбинировать: часть участников с именами, часть - SPEAKER_N
- Меньше false positives

## Реализованные изменения

### 1. Обновлены специализированные системные промпты

**Файл:** `src/prompts/specialized_prompts.py`

Во всех функциях системных промптов добавлена секция:

```
ОПРЕДЕЛЕНИЕ УЧАСТНИКОВ ИЗ ТРАНСКРИПЦИИ:
⚠️ Если список участников не предоставлен явно:
- Извлекай имена ТОЛЬКО из явных упоминаний в транскрипции
- Источники: представления ('Меня зовут...'), обращения ('Света, как думаешь?')
- Преобразуй уменьшительные в полные: Света→Светлана, Леша→Алексей
- Используй формат 'Имя Фамилия' где возможно
- ЕСЛИ имя не определить - оставляй метку спикера (SPEAKER_1, SPEAKER_2)
- ❌ НЕ придумывай имена! НЕ используй "Участник 1", "Коллега"
```

Обновлены промпты:
- `_get_general_system_prompt()` - базовый промпт
- `_get_technical_system_prompt()` - для технических встреч
- `_get_business_system_prompt()` - для деловых встреч
- `_get_status_system_prompt()` - для отчетных встреч

### 2. Обновлены user prompts в llm_providers.py

**Файл:** `llm_providers.py`

Добавлены блоки `else:` в следующие функции:

#### a) `_build_system_prompt()` (строка ~105)
Добавлена секция в базовый системный промпт для всех провайдеров.

#### b) `_build_user_prompt()` (строка ~290)
Добавлен детальный блок инструкций для автоопределения:

```python
else:
    # Нет ни speaker_mapping, ни participants - автоопределение из транскрипции
    participants_info = "\n\n" + "═" * 63 + "\n"
    participants_info += "⚙️ АВТОМАТИЧЕСКОЕ ОПРЕДЕЛЕНИЕ УЧАСТНИКОВ ИЗ ТРАНСКРИПЦИИ\n"
    participants_info += "═" * 63 + "\n\n"
    # ... детальные инструкции с 4 разделами
```

#### c) `_build_extraction_prompt()` (строка ~966)
Аналогичный блок для двухэтапной генерации (extraction stage).

#### d) `_build_segment_analysis_prompt()` (строка ~1488)
Аналогичный блок для Chain-of-Thought обработки длинных встреч.

## Правила автоопределения

### 1️⃣ Источники имен
- **Представления:** "Меня зовут Иван Петров", "Я — Мария"
- **Обращения:** "Света, как думаешь?", "Петров, расскажи о задаче"
- **Упоминания:** "Как сказал Иван...", "Нужно уточнить у Марии"

### 2️⃣ Формат имен
- Предпочтительно: **'Имя Фамилия'** (БЕЗ отчества)
- Если известно только имя: **'Иван'**
- Если известна только фамилия: **'Петров'**
- Преобразование уменьшительных: Света→Светлана, Леша→Алексей, Володя→Владимир

### 3️⃣ Сопоставление со спикерами
- Каждая метка (SPEAKER_1, SPEAKER_2...) сопоставляется с именем если возможно
- Если имя определить **НЕВОЗМОЖНО** - остается метка спикера как есть
- Пример результата: `'Иван Петров\nСПЕАКЕR_2\nСветлана Короткова\nСПЕАКЕR_4'`

### 4️⃣ Строгие запреты
- ❌ НЕ придумывать имена, которых НЕТ в транскрипции
- ❌ НЕ использовать 'Участник 1', 'Коллега', 'Человек А', 'Неизвестный'
- ❌ НЕ дублировать: если Света = SPEAKER_1, не добавлять Светлану отдельно
- ❌ НЕ заменять SPEAKER_N на описания типа 'Руководитель встречи'

## Примеры использования

### Пример 1: Частичная идентификация
**Транскрипция:**
```
SPEAKER_1: Меня зовут Иван Петров, я проектный менеджер.
SPEAKER_2: Здравствуйте.
SPEAKER_3: Света, как продвигается задача?
SPEAKER_3: У меня все идет по плану.
```

**Результат в протоколе:**
```json
{
  "participants": "Иван Петров\nСПЕАКЕR_2\nСветлана"
}
```

### Пример 2: Полная идентификация
**Транскрипция:**
```
SPEAKER_1: Привет, это Алексей Тимченко.
SPEAKER_2: Привет, Леша! Мария на связи.
SPEAKER_1: Супер, Маш. Давайте начнем.
```

**Результат в протоколе:**
```json
{
  "participants": "Алексей Тимченко\nМария"
}
```

### Пример 3: Нет идентификации
**Транскрипция:**
```
SPEAKER_1: Добрый день.
SPEAKER_2: Здравствуйте.
SPEAKER_1: Начнем совещание.
```

**Результат в протоколе:**
```json
{
  "participants": "SPEAKER_1\nСПЕАКЕR_2"
}
```

## Приоритет обработки

Система работает с тремя сценариями (по приоритету):

1. **Есть speaker_mapping** (спикеры сопоставлены с участниками) → используется маппинг ✅
2. **Есть список participants** (без маппинга) → жесткие инструкции "использовать ТОЛЬКО из списка" ✅
3. **НЕТ ни того ни другого** → автоопределение из транскрипции (новая функция) ✅

## Технические детали

### Статистика изменений
- **Файлов изменено:** 2
- **Строк добавлено:** 137
- **Строк удалено:** 0

### Затронутые файлы
1. `src/prompts/specialized_prompts.py` - 40 строк добавлено
2. `llm_providers.py` - 97 строк добавлено

### Совместимость
- ✅ Все существующие промпты сохранены без изменений
- ✅ Обратная совместимость полностью сохранена
- ✅ Новая функциональность активируется только при отсутствии speaker_mapping и participants

## Тестирование

### Сценарии для проверки:
1. ✅ Встреча с явными представлениями участников
2. ✅ Встреча с обращениями по именам
3. ✅ Встреча без упоминания имен (остаются SPEAKER_N)
4. ✅ Встреча с частичной идентификацией (часть имен определена, часть - SPEAKER_N)
5. ✅ Встреча с уменьшительными именами (Света → Светлана)

## Заметки для разработчиков

### Будущие улучшения (опционально):
1. Можно добавить более агрессивный режим (определение по ролям/контексту)
2. Можно добавить двухэтапный подход (сначала извлечение всех имен, потом сопоставление)
3. Можно добавить confidence scores для каждого определенного имени
4. Можно добавить специальную обработку для разных типов встреч

### Известные ограничения:
- LLM может не определить имя если оно упомянуто неявно
- При сложных/нестандартных именах возможны ошибки
- Зависит от качества диаризации (правильного разделения спикеров)

## Связанные документы
- План реализации: `/auto-detect-participants-prompts.plan.md`
- Существующая документация по участникам: `docs/PARTICIPANT_MAPPING.md`
- Документация по промптам: `docs/PARTICIPANTS_PROMPTS_IMPROVEMENTS.md`

