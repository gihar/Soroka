# Сохранение статистики при перезапуске

## Обзор

Реализовано сохранение статистики обратной связи и метрик производительности в базу данных SQLite. Теперь при перезапуске бота вся статистика сохраняется и восстанавливается автоматически.

## Что было изменено

### 1. База данных (database.py)

Добавлены три новые таблицы:

#### `feedback` - обратная связь от пользователей
- `id` - уникальный идентификатор
- `user_id` - ID пользователя
- `rating` - оценка (1-5)
- `feedback_type` - тип обратной связи
- `comment` - комментарий (опционально)
- `protocol_id` - ID протокола
- `processing_time` - время обработки
- `file_format` - формат файла
- `file_size` - размер файла
- `created_at` - время создания

#### `performance_metrics` - общие метрики производительности
- `id` - уникальный идентификатор
- `name` - название метрики
- `value` - значение
- `unit` - единица измерения
- `tags` - теги в формате JSON
- `created_at` - время создания

#### `processing_metrics` - детальные метрики обработки файлов
- `id` - уникальный идентификатор
- `file_name` - имя файла
- `user_id` - ID пользователя
- `start_time` - время начала
- `end_time` - время окончания
- `download_duration` - длительность скачивания
- `validation_duration` - длительность валидации
- `conversion_duration` - длительность конвертации
- `transcription_duration` - длительность транскрипции
- `diarization_duration` - длительность диаризации
- `llm_duration` - длительность обработки LLM
- `formatting_duration` - длительность форматирования
- `file_size_bytes` - размер файла
- `file_format` - формат файла
- `audio_duration_seconds` - длительность аудио
- `transcription_length` - длина транскрипции
- `speakers_count` - количество спикеров
- `error_occurred` - была ли ошибка
- `error_stage` - этап ошибки
- `error_message` - сообщение об ошибке
- `created_at` - время создания

### 2. Система обратной связи (src/ux/feedback_system.py)

#### `FeedbackCollector`
- Добавлен метод `initialize()` - загружает последние 1000 записей из БД при старте
- Метод `add_feedback()` - теперь автоматически сохраняет в БД
- Метод `get_statistics()` - теперь получает статистику из БД
- Добавлен метод `_save_feedback_to_db()` - асинхронное сохранение в БД

### 3. Система метрик (src/performance/metrics.py)

#### `MetricsCollector`
- Добавлен метод `initialize()` - загружает метрики за последние 24 часа из БД
- Метод `finish_processing_metrics()` - теперь автоматически сохраняет в БД
- Добавлен метод `_save_processing_metrics_to_db()` - асинхронное сохранение в БД
- Восстанавливает почасовую статистику из БД при инициализации

### 4. Инициализация бота (src/bot.py)

В метод `start()` добавлена инициализация систем статистики:
```python
# 4. Инициализируем систему обратной связи и метрик
try:
    from ux import feedback_collector
    from performance.metrics import metrics_collector
    
    await feedback_collector.initialize()
    logger.info("Система обратной связи инициализирована")
    
    await metrics_collector.initialize()
    logger.info("Система метрик производительности инициализирована")
except Exception as e:
    logger.warning(f"Не удалось инициализировать статистику: {e}")
```

## Как это работает

1. **При запуске бота**:
   - Создаются новые таблицы в БД (если их нет)
   - `FeedbackCollector` загружает последние 1000 записей обратной связи
   - `MetricsCollector` загружает метрики обработки за последние 24 часа
   - Восстанавливается почасовая статистика

2. **Во время работы**:
   - Каждая новая обратная связь сохраняется в БД
   - Каждая завершенная обработка файла сохраняется в БД
   - Данные остаются в памяти для быстрого доступа

3. **При перезапуске**:
   - Вся статистика загружается из БД автоматически
   - История не теряется

## Преимущества

✅ **Персистентность** - статистика сохраняется между перезапусками
✅ **Надёжность** - данные хранятся в SQLite БД
✅ **Производительность** - данные кэшируются в памяти
✅ **Масштабируемость** - можно анализировать историю за любой период
✅ **Обратная совместимость** - работает с существующей БД

## Миграция

Миграция выполняется автоматически при первом запуске:
- Новые таблицы создаются командой `CREATE TABLE IF NOT EXISTS`
- Существующие данные не затрагиваются
- Если таблицы уже существуют, они не пересоздаются

## Использование

После этих изменений никаких дополнительных действий не требуется:

```bash
# Просто запустите бота как обычно
python3 main.py
```

При запуске вы увидите в логах:
```
✅ База данных инициализирована
✅ Система обратной связи инициализирована
✅ Система метрик производительности инициализирована
```

## Просмотр статистики

Статистика доступна через:
- Команду `/stats` (для пользователей)
- Административные команды (для администраторов)
- Напрямую через SQL запросы к БД `bot.db`

### Примеры SQL запросов

```sql
-- Просмотр всей обратной связи
SELECT * FROM feedback ORDER BY created_at DESC LIMIT 10;

-- Средняя оценка по типам
SELECT feedback_type, AVG(rating) as avg_rating, COUNT(*) as count 
FROM feedback 
GROUP BY feedback_type;

-- Метрики обработки за последний день
SELECT * FROM processing_metrics 
WHERE created_at >= datetime('now', '-1 day')
ORDER BY created_at DESC;

-- Средняя длительность обработки по форматам
SELECT file_format, 
       AVG(transcription_duration + llm_duration) as avg_duration,
       COUNT(*) as count
FROM processing_metrics
WHERE error_occurred = 0
GROUP BY file_format;
```

## Файлы с изменениями

- `database.py` - добавлены таблицы и методы для работы со статистикой
- `src/ux/feedback_system.py` - добавлена персистентность обратной связи
- `src/performance/metrics.py` - добавлена персистентность метрик
- `src/bot.py` - добавлена инициализация систем статистики

## Совместимость

- ✅ SQLite 3.x
- ✅ Python 3.8+
- ✅ Работает с существующей БД
- ✅ Не требует дополнительных зависимостей

