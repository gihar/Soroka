# Migration Guide: Консолидированная архитектура LLM

## Краткое руководство по переходу на новую архитектуру (2 запроса вместо 5-6)

## Что нужно сделать

### 1. Включить новую архитектуру

Добавьте в `.env` файл:
```bash
ENABLE_CONSOLIDATED_TWO_REQUEST=true
```

Или установите напрямую в `config.py`:
```python
enable_consolidated_two_request = True
```

### 2. Опционально настроить параметры

```python
# Порог качества (по умолчанию 0.7)
consolidated_protocol_quality_threshold = 0.8

# Разрешить fallback при ошибках (рекомендуется)
enable_consolidated_fallback = True

# Настройки токенов и температуры
consolidated_max_tokens_request1 = 4000
consolidated_max_tokens_request2 = 3000
consolidated_temperature_request1 = 0.3
consolidated_temperature_request2 = 0.4
```

### 3. Перезапустить приложение

```bash
# Если используете Docker
docker-compose restart

# Или если запускаете напрямую
python main.py
```

## Ожидаемые результаты

### Производительность
- **Обработка:** на 60% быстрее
- **Стоимость:** на 50% меньше
- **Запросов LLM:** с 5-6 до 2

### Качество
- **Консистентность:** улучшена благодаря единому контексту
- **Автоматическая QA:** встроенная проверка качества
- **Надежность:** fallback механизмы

## Мониторинг

После включения следите за логами:

```
[INFO] Использование новой консолидированной генерации протокола (2 запроса вместо 5-6)
[SUCCESS] Запрос 1 завершен успешно. Уверенность: 0.XX
[SUCCESS] Запрос 2 завершен успешно. Качество протокола: 0.XX
```

## Rollback

Если возникнут проблемы, просто выключите флаг:
```bash
ENABLE_CONSOLIDATED_TWO_REQUEST=false
```

Система автоматически вернется к предыдущим методам генерации.

## Поддержка

При возникновении вопросов:
1. Проверьте логи на ошибки
2. Убедитесь, что все зависимости обновлены
3. Смотрите полную документацию: `docs/CONSOLIDATED_ARCHITECTURE.md`