# üöÄ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ Prompt Caching

–ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é prompt caching –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ LLM –∑–∞–ø—Ä–æ—Å–æ–≤.

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–ß—Ç–æ —Ç–∞–∫–æ–µ Prompt Caching](#—á—Ç–æ-—Ç–∞–∫–æ–µ-prompt-caching)
- [–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–æ–¥–µ–ª–µ–π](#–ø–æ–¥–¥–µ—Ä–∂–∫–∞-–º–æ–¥–µ–ª–µ–π)
- [–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç](#–∫–∞–∫-—ç—Ç–æ-—Ä–∞–±–æ—Ç–∞–µ—Ç)
- [–ù–∞—Å—Ç—Ä–æ–π–∫–∞](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
- [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–º–ø—Ç–æ–≤](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–º–ø—Ç–æ–≤)
- [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–º–µ—Ç—Ä–∏–∫)
- [–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏](#–ª—É—á—à–∏–µ-–ø—Ä–∞–∫—Ç–∏–∫–∏)
- [Troubleshooting](#troubleshooting)

## –ß—Ç–æ —Ç–∞–∫–æ–µ Prompt Caching

Prompt caching - —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ –ø—Ä–æ–º–ø—Ç–æ–≤ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞. –ö–æ–≥–¥–∞ –≤—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –Ω–∞—á–∞–ª–æ–º –ø—Ä–æ–º–ø—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç + —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è), –ø—Ä–æ–≤–∞–π–¥–µ—Ä –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –≤–º–µ—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- **üí∞ –≠–∫–æ–Ω–æ–º–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏**: 50-90% —Å–∫–∏–¥–∫–∞ –Ω–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
- **‚ö° –£—Å–∫–æ—Ä–µ–Ω–∏–µ**: –ú–µ–Ω—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ = –±—ã—Å—Ç—Ä–µ–µ –æ—Ç–≤–µ—Ç
- **üìä –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**: –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API –ª–∏–º–∏—Ç–æ–≤

### –≠–∫–æ–Ω–æ–º–∏—è –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ

**–í—Å—Ç—Ä–µ—á–∞ 30 –º–∏–Ω—É—Ç** (—Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è ~20K —Ç–æ–∫–µ–Ω–æ–≤):

| –°—Ü–µ–Ω–∞—Ä–∏–π | –ë–µ–∑ –∫–µ—à–∞ | –° –∫–µ—à–µ–º | –≠–∫–æ–Ω–æ–º–∏—è |
|----------|----------|---------|----------|
| Stage 1 | $0.05 | $0.03 | 40% |
| Stage 2 | $0.03 | $0.015 | 50% |
| **–ò—Ç–æ–≥–æ** | **$0.08** | **$0.045** | **44%** |

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–æ–¥–µ–ª–µ–π

### OpenAI

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–æ–¥–µ–ª–∏:**
- `gpt-4o` ‚úÖ
- `gpt-4o-mini` ‚úÖ
- `gpt-4-turbo` ‚úÖ
- `gpt-4` ‚úÖ
- `gpt-3.5-turbo` ‚ùå

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 1024 —Ç–æ–∫–µ–Ω–∞ (~3000-4000 —Å–∏–º–≤–æ–ª–æ–≤)
- –°–∫–∏–¥–∫–∞: 50% –Ω–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
- –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–µ—à–∞: 5-10 –º–∏–Ω—É—Ç
- –ú–µ—Ç–æ–¥: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π (–ø—Ä–µ—Ñ–∏–∫—Å—ã >= 1024 —Ç–æ–∫–µ–Ω–æ–≤)

### Anthropic

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–æ–¥–µ–ª–∏:**
- `claude-3-5-sonnet-20241022` ‚úÖ
- `claude-3-5-sonnet-20240620` ‚úÖ
- `claude-3-opus-20240229` ‚úÖ
- `claude-3-sonnet-20240229` ‚úÖ

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 1024 —Ç–æ–∫–µ–Ω–∞
- –°–∫–∏–¥–∫–∞: 90% –Ω–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
- –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–µ—à–∞: 5 –º–∏–Ω—É—Ç
- –ú–µ—Ç–æ–¥: –Ø–≤–Ω—ã–π (—á–µ—Ä–µ–∑ `cache_control` –º–∞—Ä–∫–µ—Ä—ã)

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### OpenAI (–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ)

OpenAI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–µ—à–∏—Ä—É–µ—Ç –ø—Ä–µ—Ñ–∏–∫—Å—ã –ø—Ä–æ–º–ø—Ç–æ–≤:

```python
# –ó–∞–ø—Ä–æ—Å 1 (—Å–æ–∑–¥–∞–µ—Ç –∫–µ—à)
messages = [
    {"role": "system", "content": "–î–ª–∏–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç..."},  # –ö–µ—à–∏—Ä—É–µ—Ç—Å—è
    {"role": "user", "content": [
        {"type": "text", "text": "–¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø:\n\n..."},  # –ö–µ—à–∏—Ä—É–µ—Ç—Å—è
        {"type": "text", "text": "–°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –ø—Ä–æ–º–ø—Ç"}  # –ù–µ –∫–µ—à–∏—Ä—É–µ—Ç—Å—è
    ]}
]

# –ó–∞–ø—Ä–æ—Å 2 —Å —Ç–µ–º –∂–µ –ø—Ä–µ—Ñ–∏–∫—Å–æ–º (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–µ—à)
# System prompt + —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —á–∏—Ç–∞—é—Ç—Å—è –∏–∑ –∫–µ—à–∞ (50% —Å–∫–∏–¥–∫–∞)
# –¢–æ–ª—å–∫–æ "—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –ø—Ä–æ–º–ø—Ç" –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ
```

### Anthropic (–Ø–≤–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ)

Anthropic —Ç—Ä–µ–±—É–µ—Ç —è–≤–Ω—ã—Ö `cache_control` –º–∞—Ä–∫–µ—Ä–æ–≤:

```python
system = [
    {"type": "text", "text": "–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç..."},
    {
        "type": "text",
        "text": "–¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø:\n\n...",
        "cache_control": {"type": "ephemeral"}  # –Ø–≤–Ω–∞—è –º–µ—Ç–∫–∞ –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
    }
]

messages = [
    {"role": "user", "content": "–°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –ø—Ä–æ–º–ø—Ç"}  # –ù–µ –∫–µ—à–∏—Ä—É–µ—Ç—Å—è
]
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –í–∫–ª—é—á–∏—Ç—å prompt caching (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é True)
ENABLE_PROMPT_CACHING=true

# –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é True)
LOG_CACHE_METRICS=true

# –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
# ~1024 —Ç–æ–∫–µ–Ω–æ–≤ = ~3000-4000 —Å–∏–º–≤–æ–ª–æ–≤
MIN_TRANSCRIPTION_LENGTH_FOR_CACHE=3000

# –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
CACHE_METRICS_IN_FINAL_MESSAGE=false
```

### –í config.py

```python
class Settings(BaseSettings):
    # Prompt caching
    enable_prompt_caching: bool = Field(True, description="...")
    log_cache_metrics: bool = Field(True, description="...")
    min_transcription_length_for_cache: int = Field(3000, description="...")
    cache_metrics_in_final_message: bool = Field(False, description="...")
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–º–ø—Ç–æ–≤

### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ System Prompt (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π)         ‚îÇ ‚Üê –ö–µ—à–∏—Ä—É–µ—Ç—Å—è
‚îÇ - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏                        ‚îÇ
‚îÇ - –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞                     ‚îÇ
‚îÇ - –ü—Ä–∞–≤–∏–ª–∞                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è)          ‚îÇ ‚Üê –ö–µ—à–∏—Ä—É–µ—Ç—Å—è
‚îÇ - –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –≤—Å—Ç—Ä–µ—á–∏              ‚îÇ
‚îÇ - –î–∏–∞—Ä–∏–∑–∞—Ü–∏—è                        ‚îÇ
‚îÇ - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Task-specific prompt (–∏–∑–º–µ–Ω—è–µ—Ç—Å—è)   ‚îÇ ‚Üê –ù–ï –∫–µ—à–∏—Ä—É–µ—Ç—Å—è
‚îÇ - –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –∑–∞–¥–∞—á–∞ (Stage 1/2)    ‚îÇ
‚îÇ - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑–≤–ª–µ—á–µ–Ω–∏—è              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**
1. **–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤–Ω–∞—á–∞–ª–µ**: –í—Å—ë —á—Ç–æ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è - –≤ –ø—Ä–µ—Ñ–∏–∫—Å
2. **–ò–∑–º–µ–Ω—è—é—â–∏–π—Å—è –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –∫–æ–Ω—Ü–µ**: –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ - –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏
3. **–ú–∏–Ω–∏–º—É–º 1024 —Ç–æ–∫–µ–Ω–∞**: –ü—Ä–µ—Ñ–∏–∫—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–ª—å—à–∏–º

### ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Task-specific prompt (–∏–∑–º–µ–Ω—è–µ—Ç—Å—è)   ‚îÇ ‚Üê –õ–æ–º–∞–µ—Ç –∫–µ—à!
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è)          ‚îÇ ‚Üê –ù–µ –∫–µ—à–∏—Ä—É–µ—Ç—Å—è
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ System Prompt (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π)         ‚îÇ ‚Üê –ù–µ –∫–µ—à–∏—Ä—É–µ—Ç—Å—è
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫

### –í –ª–æ–≥–∞—Ö

–ü—Ä–∏ `LOG_CACHE_METRICS=true` –≤—ã —É–≤–∏–¥–∏—Ç–µ:

```
[Two-Stage: Stage 1 Extraction] –¢–æ–∫–µ–Ω—ã: prompt=21854, completion=3701, total=25555
[Two-Stage: Stage 1 Extraction] üí∞ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–æ: 15000 —Ç–æ–∫–µ–Ω–æ–≤ (68.6% –æ—Ç prompt)
[Two-Stage: Stage 1 Extraction] üíµ –≠–∫–æ–Ω–æ–º–∏—è: $0.0375 (50.0%) | –°—Ç–æ–∏–º–æ—Å—Ç—å: $0.0375 –≤–º–µ—Å—Ç–æ $0.0750
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ—Ç—Ä–∏–∫

```python
{
    "prompt_tokens": 21854,
    "completion_tokens": 3701,
    "total_tokens": 25555,
    "cached_tokens": 15000,
    "cache_hit_rate": 0.686,
    "cost_without_cache": 0.0750,
    "cost_with_cache": 0.0375,
    "cost_saved": 0.0375,
    "savings_percent": 50.0
}
```

### –ß–µ—Ä–µ–∑ API –º–µ—Ç—Ä–∏–∫

```python
from src.performance.metrics import metrics_collector

# –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏
stats = metrics_collector.get_current_stats()

# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏
json_data = metrics_collector.export_metrics(format="json")
```

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–º–ø—Ç–æ–≤

```python
# ‚úÖ –•–æ—Ä–æ—à–æ: —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–µ—Ñ–∏–∫—Å
system = "–î–ª–∏–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏..."  # –ö–µ—à–∏—Ä—É–µ—Ç—Å—è
user = f"–¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø: {text}\n\n–ó–∞–¥–∞—á–∞: {task}"  # –ß–∞—Å—Ç–∏—á–Ω–æ –∫–µ—à–∏—Ä—É–µ—Ç—Å—è

# ‚ùå –ü–ª–æ—Ö–æ: –∏–∑–º–µ–Ω—è—é—â–∏–µ—Å—è –¥–∞–Ω–Ω—ã–µ –≤ –Ω–∞—á–∞–ª–µ
user = f"–ó–∞–¥–∞—á–∞: {task}\n\n–¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø: {text}"  # –õ–æ–º–∞–µ—Ç –∫–µ—à
```

### 2. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

–î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ –∑–∞–ø—Ä–æ—Å—ã —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –ø—Ä–µ—Ñ–∏–∫—Å–æ–º –ø–æ–¥—Ä—è–¥:

```python
# ‚úÖ –•–æ—Ä–æ—à–æ: Stage 1 –∏ Stage 2 —Å –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–µ–π
result1 = await generate_stage1(transcription, ...)  # –°–æ–∑–¥–∞–µ—Ç –∫–µ—à
result2 = await generate_stage2(transcription, ...)  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–µ—à (5-10 –º–∏–Ω)

# ‚ùå –ü–ª–æ—Ö–æ: —Ä–∞–∑–Ω—ã–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
result1 = await generate_stage1(transcription1, ...)
result3 = await generate_stage1(transcription2, ...)  # –ù–æ–≤—ã–π –∫–µ—à
result2 = await generate_stage2(transcription1, ...)  # –ö–µ—à –∏—Å—Ç–µ–∫
```

### 3. –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ò–∑–±–µ–≥–∞–π—Ç–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π —á–∞—Å—Ç–∏:

```python
# ‚ùå –ü–ª–æ—Ö–æ: timestamp –≤ –∫–µ—à–∏—Ä—É–µ–º–æ–π —á–∞—Å—Ç–∏
system = f"–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏... (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ {datetime.now()})"

# ‚úÖ –•–æ—Ä–æ—à–æ: –±–µ–∑ –¥–∏–Ω–∞–º–∏–∫–∏
system = "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏..."
```

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

–†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –º–µ—Ç—Ä–∏–∫–∏:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
tail -f logs/bot.log | grep "–ö–µ—à–∏—Ä–æ–≤–∞–Ω–æ"

# –ê–Ω–∞–ª–∏–∑ cache hit rate
grep "cache_hit_rate" logs/bot.log | awk '{sum+=$NF; count++} END {print sum/count}'
```

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ –Ω–µ—Ç

**–°–∏–º–ø—Ç–æ–º—ã:**
```
Usage: CompletionUsage(..., prompt_tokens_details=None)
# –∏–ª–∏
üí∞ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–æ: 0 —Ç–æ–∫–µ–Ω–æ–≤
```

**–†–µ—à–µ–Ω–∏—è:**

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–æ–¥–µ–ª—å:**
```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –º–æ–¥–µ–ª—å
grep "Model:" logs/bot.log
```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä –ø—Ä–µ—Ñ–∏–∫—Å–∞:**
```python
# –ü—Ä–µ—Ñ–∏–∫—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å >= 1024 —Ç–æ–∫–µ–Ω–æ–≤ (~3000 —Å–∏–º–≤–æ–ª–æ–≤)
len(system_prompt + transcription) >= 3000
```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
```bash
echo $ENABLE_PROMPT_CACHING  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å true
echo $MIN_TRANSCRIPTION_LENGTH_FOR_CACHE  # –ù–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ
```

4. **–ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å:**
–ö–µ—à —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –≤—Ç–æ—Ä–æ–º:
```
–ó–∞–ø—Ä–æ—Å 1: prompt_tokens=20000, cached=0 (—Å–æ–∑–¥–∞–Ω–∏–µ –∫–µ—à–∞)
–ó–∞–ø—Ä–æ—Å 2: prompt_tokens=20000, cached=15000 (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–µ—à–∞)
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–∏–∑–∫–∏–π cache hit rate

**–°–∏–º–ø—Ç–æ–º—ã:**
```
üí∞ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–æ: 500 —Ç–æ–∫–µ–Ω–æ–≤ (2.5% –æ—Ç prompt)
```

**–†–µ—à–µ–Ω–∏—è:**

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É:**
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –∏–¥–µ—Ç –ø–µ—Ä–≤—ã–º.

2. **–£–≤–µ–ª–∏—á—å—Ç–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫—É—é —á–∞—Å—Ç—å:**
```python
# –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
system_prompt += "\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏..."
```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å–∞:**
```python
# –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
assert transcription1 == transcription2
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–µ—à –±—ã—Å—Ç—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç

**–°–∏–º–ø—Ç–æ–º—ã:**
–ö–µ—à —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è Stage 1, –Ω–æ –Ω–µ –¥–ª—è Stage 2.

**–†–µ—à–µ–Ω–∏—è:**

1. **–°–æ–∫—Ä–∞—Ç–∏—Ç–µ –≤—Ä–µ–º—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏:**
OpenAI/Anthropic –∫–µ—à –∂–∏–≤–µ—Ç 5-10 –º–∏–Ω—É—Ç.

2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ unified –ø–æ–¥—Ö–æ–¥:**
```bash
ENABLE_UNIFIED_PROTOCOL_GENERATION=true
```
–û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ –¥–≤—É—Ö = –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–µ—à–∞.

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ cache_control

**–°–∏–º–ø—Ç–æ–º—ã (Anthropic):**
```
anthropic.BadRequestError: Invalid cache_control
```

**–†–µ—à–µ–Ω–∏—è:**

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏—é SDK:**
```bash
pip show anthropic  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å >= 0.39.0
```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É:**
```python
# cache_control —Ç–æ–ª—å–∫–æ –≤ system blocks
system = [
    {"type": "text", "text": "...", "cache_control": {"type": "ephemeral"}}
]
# –ù–ï –≤ messages!
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [OpenAI Prompt Caching Documentation](https://platform.openai.com/docs/guides/prompt-caching)
- [Anthropic Prompt Caching Documentation](https://docs.anthropic.com/en/docs/prompt-caching)
- [LLM_PIPELINE_OPTIMIZATION.md](./LLM_PIPELINE_OPTIMIZATION.md) - –û–±—â–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

## Changelog

### 2025-11-02
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ OpenAI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Anthropic —è–≤–Ω–æ–≥–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ best practices

