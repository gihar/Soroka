# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ "message is too long"

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–û—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–æ–≤, –∫–æ–≥–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–µ–≤—ã—à–∞–ª –ª–∏–º–∏—Ç Telegram –≤ 4096 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º.

```
2025-08-28 05:53:38 | ERROR | handlers.callback_handlers:_process_file:283 - 
–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: Telegram server says - Bad Request: message is too long
```

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `_send_long_message`

**–§–∞–π–ª:** `src/handlers/callback_handlers.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –£—á–µ—Ç –¥–ª–∏–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã —á–∞—Å—Ç–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É –±–µ–∑ Markdown
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å graceful degradation
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

```python
async def _send_long_message(chat_id: int, text: str, bot, max_length: int = 4096):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —á–∞—Å—Ç—è–º"""
    # –£—á–∏—Ç—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã —á–∞—Å—Ç–∏
    header_template = "üìÑ **–ü—Ä–æ—Ç–æ–∫–æ–ª –≤—Å—Ç—Ä–µ—á–∏** (—á–∞—Å—Ç—å {}/{})\n\n"
    max_header_length = len(header_template.format(999, 999))
    max_part_length = max_length - max_header_length
    
    # ... —É–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–∑–±–∏–µ–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
```

### 2. –£–ª—É—á—à–µ–Ω–Ω—ã–π MessageBuilder

**–§–∞–π–ª:** `src/ux/message_builder.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–º–∞–∫—Å–∏–º—É–º 5 + "–∏ –µ—â–µ X")
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ–º
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ fallback –≤–µ—Ä—Å–∏–∏ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

```python
@classmethod
def processing_complete_message(cls, result: Dict[str, Any]) -> str:
    # ... –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ ...
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç Telegram
    if len(message) > 4000:  # –û—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø–∞—Å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        # –°–æ–∑–¥–∞–µ–º —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
        message = "üéâ **–ü—Ä–æ—Ç–æ–∫–æ–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!**\n\n"
        # ... —Å–æ–∫—Ä–∞—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
```

### 3. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–§–∞–π–ª:** `src/handlers/callback_handlers.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ "message is too long"
- ‚úÖ Try-catch –±–ª–æ–∫–∏ –¥–ª—è –≤—Å–µ—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ Fallback –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É –±–µ–∑ Markdown
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ –¥–ª–∏–Ω—ã
try:
    await callback.bot.send_message(
        callback.message.chat.id,
        result_message,
        parse_mode="Markdown"
    )
except Exception as e:
    if "message is too long" in str(e).lower():
        # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–µ–∑ Markdown
        await callback.bot.send_message(
            callback.message.chat.id,
            result_message
        )
```

### 4. –ù–æ–≤–∞—è —É—Ç–∏–ª–∏—Ç–∞ safe_send_message

**–§–∞–π–ª:** `src/utils/message_utils.py`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å graceful degradation
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç `test_message_length_fix.py` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

```bash
python test_message_length_fix.py
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤:**
- ‚úÖ MessageBuilder –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–ª–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –†–∞–∑–±–∏–µ–Ω–∏–µ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –í—Å–µ —á–∞—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞ Telegram

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ò–∑–º–µ–Ω–µ–Ω–∏—è | –°—Ç–∞—Ç—É—Å |
|-----------|-----------|--------|
| `_send_long_message` | –£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Ä–∞–∑–±–∏–µ–Ω–∏—è | ‚úÖ |
| `MessageBuilder` | –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã | ‚úÖ |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ | –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ | ‚úÖ |
| `safe_send_message` | –ù–æ–≤–∞—è —É—Ç–∏–ª–∏—Ç–∞ | ‚úÖ |

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

- ‚ùå **–î–æ:** –û—à–∏–±–∫–∞ "message is too long" –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–ª–∏–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- ‚úÖ **–ü–æ—Å–ª–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ graceful fallback

## üîÑ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã –∏ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –∫–æ—Ä–æ—Ç–∫–∏–º–∏ —Ñ–∞–π–ª–∞–º–∏ –Ω–µ –∑–∞–º–µ—Ç—è—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –¥–ª–∏–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ –ø–æ–ª—É—á–∞—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É.

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (>60 –º–∏–Ω—É—Ç) —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞–∑–¥–µ–ª–∏—Ç—å –∏—Ö –Ω–∞ —á–∞—Å—Ç–∏
2. **–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `safe_send_message` –¥–ª—è –≤—Å–µ—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
3. **–î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:** –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
