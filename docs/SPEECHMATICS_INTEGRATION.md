# Интеграция Speechmatics API

## Обзор

Добавлена поддержка Speechmatics API для транскрипции и диаризации аудио/видео файлов. Speechmatics предоставляет высококачественную облачную транскрипцию с автоматическим разделением говорящих.

## Возможности

### Транскрипция
- Поддержка множества аудио и видео форматов
- Высокая точность распознавания речи
- Поддержка различных языков
- Специализированные домены (finance, medical и др.)

### Диаризация
- Автоматическое разделение говорящих
- Интеграция с результатами транскрипции
- Поддержка до 10 говорящих одновременно

## Настройка

### 1. Получение API ключа

1. Зарегистрируйтесь на [Speechmatics Portal](https://portal.speechmatics.com/)
2. Создайте API ключ в разделе "API Keys"
3. Сохраните ключ в переменной окружения

### 2. Конфигурация

Добавьте следующие переменные в ваш `.env` файл:

```env
# Speechmatics API
SPEECHMATICS_API_KEY=your_api_key_here
SPEECHMATICS_LANGUAGE=ru
SPEECHMATICS_DOMAIN=  # Опционально: finance, medical и др.
SPEECHMATICS_OPERATING_POINT=standard  # standard или enhanced

# Режим транскрипции
TRANSCRIPTION_MODE=speechmatics

# SSL настройки (для решения проблем с сертификатами)
SSL_VERIFY=false  # Установите true для продакшена
```

### 3. Установка зависимостей

```bash
pip install speechmatics-python>=1.0.0
```

## Использование

### Переключение режима транскрипции

Администраторы могут переключать режим транскрипции через команду:

```
/transcription_mode
```

Доступные режимы:
- **Локальная (Whisper)** - локальная транскрипция
- **Облачная (Groq)** - облачная транскрипция через Groq
- **Гибридная** - облачная транскрипция + локальная диаризация
- **Speechmatics** - транскрипция и диаризация через Speechmatics

### Автоматический fallback

При ошибках Speechmatics API система автоматически переключается на локальную транскрипцию через Whisper.

## Конфигурационные параметры

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `speechmatics_api_key` | API ключ Speechmatics | - |
| `speechmatics_language` | Язык для транскрипции | `ru` |
| `speechmatics_domain` | Специализированный домен | - |
| `speechmatics_operating_point` | Операционная точка | `standard` |

### Операционные точки

- **standard** - стандартная точность, быстрая обработка
- **enhanced** - повышенная точность, более медленная обработка

### Поддерживаемые домены

- `finance` - финансовые документы
- `medical` - медицинские записи
- `legal` - юридические документы
- И другие специализированные домены

## Ограничения

### Размер файлов
- Максимальный размер: 2GB
- Рекомендуемый размер: до 500MB для оптимальной производительности

### Поддерживаемые форматы
- Аудио: MP3, WAV, M4A, FLAC, OGG
- Видео: MP4, AVI, MOV, MKV

### Лимиты API
- Зависит от вашего тарифного плана Speechmatics
- При превышении лимитов система автоматически переключается на локальную транскрипцию

## Обработка ошибок

### Типы ошибок

1. **SpeechmaticsAPIError** - ошибки API Speechmatics
   - Неверный API ключ (401)
   - Неверный формат запроса (400)
   - Файл слишком большой (413)
   - Превышен лимит запросов (429)
   - SSL ошибки (certificate verify failed)

2. **CloudTranscriptionError** - общие ошибки облачной транскрипции

### Решение SSL проблем

Если вы получаете ошибку `[SSL: CERTIFICATE_VERIFY_FAILED]`, это означает проблему с SSL сертификатами. Решение:

1. **Отключите SSL верификацию** (для разработки):
   ```env
   SSL_VERIFY=false
   ```

2. **Или обновите сертификаты** (для продакшена):
   ```bash
   # На macOS
   /Applications/Python\ 3.x/Install\ Certificates.command
   
   # На Ubuntu/Debian
   sudo apt-get update && sudo apt-get install ca-certificates
   ```

3. **Или установите корневые сертификаты**:
   ```bash
   pip install --upgrade certifi
   ```

### Fallback стратегия

При ошибке Speechmatics API:
1. Логируется ошибка
2. Система переключается на локальную транскрипцию
3. Пользователь уведомляется о переключении
4. Обработка продолжается с Whisper

### Решение проблем

#### SSL ошибки
Если получаете `[SSL: CERTIFICATE_VERIFY_FAILED]`:
```env
SSL_VERIFY=false
```

#### Ошибки валидации
Если получаете ошибки валидации Pydantic, убедитесь что:
- `speakers_text` содержит строки, а не списки
- Все поля соответствуют типам в модели `TranscriptionResult`

## Мониторинг

### Логирование

Все операции с Speechmatics логируются с уровнем INFO:
- Инициализация клиента
- Отправка задач
- Получение результатов
- Ошибки и fallback

### Статистика

Мониторинг доступен через административные команды:
- `/status` - общий статус системы
- `/health` - проверка здоровья компонентов
- `/stats` - детальная статистика

## Примеры использования

### Базовое использование

```python
from src.services.speechmatics_service import speechmatics_service

# Транскрипция без диаризации
result = await speechmatics_service.transcribe_file(
    file_path="audio.mp3",
    language="ru"
)

# Транскрипция с диаризацией
result = await speechmatics_service.transcribe_file(
    file_path="audio.mp3",
    language="ru",
    enable_diarization=True
)
```

### Интеграция в основной сервис

```python
from src.services.transcription_service import TranscriptionService

service = TranscriptionService()

# Автоматический выбор провайдера на основе настроек
result = await service.transcribe_with_diarization(
    file_path="audio.mp3",
    language="ru"
)
```

## Сравнение с другими провайдерами

| Провайдер | Точность | Скорость | Диаризация | Стоимость |
|-----------|----------|----------|------------|-----------|
| Whisper (локально) | Высокая | Медленная | Требует дополнительных моделей | Бесплатно |
| Groq | Высокая | Быстрая | Нет | Платно |
| Speechmatics | Очень высокая | Быстрая | Встроенная | Платно |

## Рекомендации

### Когда использовать Speechmatics

- Высокие требования к точности транскрипции
- Необходимость качественной диаризации
- Обработка больших объемов аудио
- Специализированные домены (медицина, финансы)

### Когда использовать другие провайдеры

- Ограниченный бюджет
- Простые задачи транскрипции
- Локальная обработка (конфиденциальность)
- Быстрое прототипирование

## Поддержка

При возникновении проблем:

1. Проверьте логи системы
2. Убедитесь в правильности API ключа
3. Проверьте лимиты вашего тарифного плана
4. Обратитесь к документации Speechmatics

## Обновления

Интеграция Speechmatics будет обновляться в соответствии с изменениями в их API. Следите за обновлениями в changelog проекта.
