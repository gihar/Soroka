# Улучшения LLM промптов и работы с шаблонами

## Проблема
LLM возвращал JSON-структуры вместо отформатированного текста для разделов "Принятые решения" и "Дальнейшие действия", что приводило к некорректному отображению в протоколах.

### Пример проблемы:
```
## Принятые решения
{'decision': 'Выполнить утреннюю последовательность действий...', 'decision_maker': 'Не указано (диаризация недоступна)'}

## Дальнейшие действия
{'item': 'Сделать зарядку', 'assignee': 'Не указано', 'due': 'Не указано', 'status': 'Не указано'}
```

## Исправления

### 1. Улучшение промптов для LLM

**Файл:** `llm_providers.py`

- Добавлено четкое указание в промпт, что LLM должен возвращать **ГОТОВЫЙ ОТФОРМАТИРОВАННЫЙ ТЕКСТ** для вставки в протокол
- Добавлены требования к форматированию:
  - Использование маркированных списков (•) для решений и действий
  - Запрет на возврат JSON-объектов внутри значений
  - Примеры правильного и неправильного форматирования

**Пример улучшенного промпта:**
```
ВАЖНО: Верни результат в формате JSON, где ключи - это названия переменных, а значения - ГОТОВЫЙ ОТФОРМАТИРОВАННЫЙ ТЕКСТ для вставки в протокол.

Требования к форматированию:
- Для списков решений и действий используй маркированные списки (•) или нумерованные списки
- НЕ возвращай JSON-объекты или словари внутри значений
- Каждое значение должно быть готовым текстом для вставки в протокол

Пример правильного ответа:
{
    "decisions": "• Решено увеличить бюджет на маркетинг на 20% (решение принял Иван Иванов)\n• Утверждена новая стратегия продвижения (решение принято коллегиально)",
    "action_items": "• Подготовить презентацию маркетинговой стратегии - Мария Петрова, до 20.01.2024\n• Согласовать бюджет с финансовым отделом - Иван Иванов, до 18.01.2024"
}
```

### 2. Динамическое извлечение переменных из шаблонов

**Файл:** `src/services/optimized_processing_service.py`

- Создан новый метод `_get_template_variables_from_template()` который извлекает переменные непосредственно из содержимого шаблона
- Заменено использование фиксированного набора переменных на динамическое извлечение
- Добавлен fallback на базовые переменные в случае ошибки

### 3. Постобработка результатов LLM

**Файл:** `src/services/optimized_processing_service.py`

Добавлены методы для исправления некорректных JSON-структур в результатах:

- `_post_process_llm_result()` - основная функция постобработки
- `_fix_json_in_text()` - преобразование JSON-объектов в читаемый текст

**Функциональность:**
- Автоматическое обнаружение JSON-объектов в тексте
- Преобразование JSON-структур решений в маркированные списки
- Преобразование JSON-структур действий в читаемый формат
- Очистка лишних символов и форматирование

### 4. Обновление шаблонов

**Файл:** `src/services/template_service.py`

- Обновлен шаблон "Краткое резюме встречи" для соответствия названиям разделов
- Изменены названия разделов на "Принятые решения" и "Дальнейшие действия"

## Результат

После внесения изменений протоколы должны выглядеть так:

```
# Резюме встречи  

Участники: Не указано (диаризация недоступна)

## Ключевые моменты
[Содержимое ключевых моментов]

## Принятые решения
• Выполнить утреннюю последовательность действий (решение принял: Не указано)

## Дальнейшие действия
• Сделать зарядку - Не указано, до Не указано
• Принять душ - Не указано, до Не указано
• Почистить зубы - Не указано, до Не указано
• Одеться - Не указано, до Не указано
• Пойти на работу - Не указано, до Не указано
```

## Технические детали

### Компоненты системы затронутые изменениями:
1. **LLM Providers** (OpenAI, Anthropic, YandexGPT) - обновлены промпты
2. **Template Service** - обновлен шаблон
3. **Processing Service** - добавлена логика извлечения переменных и постобработки
4. **JSON Processing** - добавлена система исправления некорректных JSON-структур

### Совместимость:
- Изменения обратно совместимы
- Сохранена поддержка существующих шаблонов
- Добавлен fallback для обработки ошибок

### Производительность:
- Постобработка выполняется только при необходимости
- Добавлено логирование для мониторинга
- Минимальное влияние на общую производительность системы
