# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π –≤ –ø—Ä–æ–º–ø—Ç–µ Stage 1

## –î–∞—Ç–∞
2 –Ω–æ—è–±—Ä—è 2025

## –ü—Ä–æ–±–ª–µ–º–∞

–í –ø—Ä–æ–º–ø—Ç–µ –¥–ª—è Stage 1 –¥–≤—É—Ö—ç—Ç–∞–ø–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –±—ã–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–≤–æ–¥–∏–ª–∏ –∫ –æ—à–∏–±–∫–∞–º –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON, –æ—Å–æ–±–µ–Ω–Ω–æ –Ω–∞ –±–æ–ª—å—à–∏—Ö —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è—Ö:

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è:

1. **–ó–∞–ø—Ä–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ vs —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞**
   - –ü—Ä–æ–º–ø—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–µ—â–∞–ª: "–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã {}"
   - –ù–æ —Ç—Ä–µ–±—É–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–¥–µ—Ä–∂–∞–ª–∞: `{"extracted_data": {...}}`
   - –≠—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª–æ –ø—É—Ç–∞–Ω–∏—Ü—É –¥–ª—è –º–æ–¥–µ–ª–∏

2. **–ù–µ–ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ö–µ–º—ã**
   - –°—Ö–µ–º–∞ `TwoStageExtractionSchema` —Å–æ–¥–µ—Ä–∂–∏—Ç 7 –ø–æ–ª–µ–π
   - –ü—Ä–æ–º–ø—Ç –æ–ø–∏—Å—ã–≤–∞–ª —Ç–æ–ª—å–∫–æ 3 –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—è
   - 4 optional –ø–æ–ª—è –Ω–µ –±—ã–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã

3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π**
   - –ù–µ—Ç —É–∫–∞–∑–∞–Ω–∏–π, –∫–∞–∫ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –ø—Ä–∏ —Ä–∏—Å–∫–µ –æ–±—Ä–µ–∑–∞–Ω–∏—è JSON
   - –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—à–∏–±–∫–∞–º —Ç–∏–ø–∞: `Expecting value: line 541 column 1 (char 2970)`

## –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –£—Ç–æ—á–Ω–µ–Ω–∞ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –æ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞—Ö

**–§–∞–π–ª:** `llm_providers.py`, —Ñ—É–Ω–∫—Ü–∏—è `_build_extraction_prompt()`, —Å—Ç—Ä–æ–∫–∏ ~1695-1701

**–ë—ã–ª–æ:**
```
–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚Äî —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –í–°–ï –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ü–†–û–°–¢–´–ú–ò –°–¢–†–û–ö–ê–ú–ò (string)
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã {} –∏–ª–∏ –º–∞—Å—Å–∏–≤—ã [] –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∑–Ω–∞—á–µ–Ω–∏–π
```

**–°—Ç–∞–ª–æ:**
```
–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚Äî —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –≤ extracted_data:
- –í–°–ï –∑–Ω–∞—á–µ–Ω–∏—è –í–ù–£–¢–†–ò extracted_data –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ü–†–û–°–¢–´–ú–ò –°–¢–†–û–ö–ê–ú–ò (string)
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã {} –∏–ª–∏ –º–∞—Å—Å–∏–≤—ã [] –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª–µ–π –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
- ‚úÖ –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è (extracted_data, confidence_score, extraction_notes)
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –£—Å—Ç—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ - —Ç–µ–ø–µ—Ä—å —è—Å–Ω–æ, —á—Ç–æ –∑–∞–ø—Ä–µ—Ç –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –≤–Ω—É—Ç—Ä–∏ `extracted_data`, –∞ –Ω–µ –∫ —Å–∞–º–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –æ—Ç–≤–µ—Ç–∞.

---

### 2. –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ optional –ø–æ–ª–µ–π

**–§–∞–π–ª:** `llm_providers.py`, —Ñ—É–Ω–∫—Ü–∏—è `_build_extraction_prompt()`, –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ ~1728

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```
–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –û–ü–¶–ò–û–ù–ê–õ–¨–ù–´–ï –ü–û–õ–Ø (–¥–æ–±–∞–≤–ª—è–π –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ):
- detected_speaker_mapping: –æ–±—ä–µ–∫—Ç —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º SPEAKER_N —Å –∏–º–µ–Ω–∞–º–∏
  –ü—Ä–∏–º–µ—Ä: {"SPEAKER_1": "–ê–ª–µ–∫—Å–µ–π –¢–∏–º—á–µ–Ω–∫–æ", "SPEAKER_2": "–ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞"}
- speaker_confidence_scores: –æ–±—ä–µ–∫—Ç —Å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é –≤ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ (0.0-1.0)
  –ü—Ä–∏–º–µ—Ä: {"SPEAKER_1": 0.95, "SPEAKER_2": 0.80}
- unmapped_speakers: –º–∞—Å—Å–∏–≤ —Å–ø–∏–∫–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å
  –ü—Ä–∏–º–µ—Ä: ["SPEAKER_3", "SPEAKER_5"]
- mapping_notes: —Å—Ç—Ä–æ–∫–∞ —Å –∑–∞–º–µ—Ç–∫–∞–º–∏ –æ –ª–æ–≥–∏–∫–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–ø–∏–∫–µ—Ä–æ–≤
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –ú–æ–¥–µ–ª—å —Ç–µ–ø–µ—Ä—å –∑–Ω–∞–µ—Ç –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–ø–∏–∫–µ—Ä–æ–≤ –∏ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–∏ –ø–æ–ª—è.

---

### 3. –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –±–æ–ª—å—à–∏–º–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è–º–∏

**–§–∞–π–ª:** `llm_providers.py`, —Ñ—É–Ω–∫—Ü–∏—è `_build_extraction_prompt()`, –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ö†Ô∏è –†–ê–ë–û–¢–ê –° –ë–û–õ–¨–®–ò–ú–ò –¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø–ú–ò
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–∞—è –∏ –µ—Å—Ç—å —Ä–∏—Å–∫ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ –æ—Ç–≤–µ—Ç–∞:

1. –ü–†–ò–û–†–ò–¢–ï–¢–´ –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø (–æ—Ç –≤—ã—Å—à–µ–≥–æ –∫ –Ω–∏–∑—à–µ–º—É):
   ‚úÖ –†–µ—à–µ–Ω–∏—è –∏ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
   ‚úÖ –ó–∞–¥–∞—á–∏ —Å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∏ —Å—Ä–æ–∫–∞–º–∏ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
   ‚úÖ –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –æ–±—Å—É–∂–¥–µ–Ω–∏—è (–≤–∞–∂–Ω–æ)
   ‚ö†Ô∏è –î–µ—Ç–∞–ª–∏ –∏ –ø—Ä–∏–º–µ—Ä—ã (–º–æ–∂–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—É—Ç—å)

2. –ü–†–ê–í–ò–õ–ê –°–û–ö–†–ê–©–ï–ù–ò–Ø:
   - –°–æ–∫—Ä–∞—â–∞–π –î–ï–¢–ê–õ–ò –æ–±—Å—É–∂–¥–µ–Ω–∏—è, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–π –°–£–¢–¨ –∏ –†–ï–®–ï–ù–ò–Ø
   - –ù–ï –û–ë–†–´–í–ê–ô JSON –Ω–∞ –ø–æ–ª—É—Å–ª–æ–≤–µ - –ª—É—á—à–µ —Å–æ–∫—Ä–∞—Ç–∏ –¥–µ—Ç–∞–ª–∏, –Ω–æ –∑–∞–∫—Ä–æ–π –≤—Å–µ –∫–∞–≤—ã—á–∫–∏ –∏ —Å–∫–æ–±–∫–∏
   - –ï—Å–ª–∏ —Å–æ–∫—Ä–∞—â–∞–µ—à—å - –¥–æ–±–∞–≤—å –≤ extraction_notes: "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ —Å –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–µ–π..."

3. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
   üö® JSON –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –í–ê–õ–ò–î–ù–´–ú –∏ –ü–û–õ–ù–´–ú, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–∫—Ä–∞—â–µ–Ω–æ!
   üö® –í—Å–µ —Å–∫–æ–±–∫–∏ {}, –∫–∞–≤—ã—á–∫–∏ "" –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–∫—Ä—ã—Ç—ã
   üö® –õ—É—á—à–µ –∫–æ—Ä–æ—Ç–∫–∏–π, –Ω–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON, —á–µ–º –¥–ª–∏–Ω–Ω—ã–π –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –Ø–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –æ–±—Ä–µ–∑–∞–Ω–∏–µ JSON –∏ –¥–∞—é—Ç –º–æ–¥–µ–ª–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Ä–∞–±–æ—Ç—ã —Å –±–æ–ª—å—à–∏–º–∏ –æ–±—ä–µ–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö.

---

### 4. –û–±–Ω–æ–≤–ª–µ–Ω —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏

**–§–∞–π–ª:** `llm_providers.py`, —Ñ—É–Ω–∫—Ü–∏—è `_build_system_prompt()`, —Å—Ç—Ä–æ–∫–∏ ~840-842

**–ë—ã–ª–æ:**
```
- –í–°–ï –∑–Ω–∞—á–µ–Ω–∏—è –≤ JSON –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ü–†–û–°–¢–´–ú–ò –°–¢–†–û–ö–ê–ú–ò (string)
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã {} –∏–ª–∏ –º–∞—Å—Å–∏–≤—ã [] –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª–µ–π
```

**–°—Ç–∞–ª–æ:**
```
- –í–°–ï –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ü–†–û–°–¢–´–ú–ò –°–¢–†–û–ö–ê–ú–ò (string), –Ω–µ –æ–±—ä–µ–∫—Ç–∞–º–∏ –∏–ª–∏ –º–∞—Å—Å–∏–≤–∞–º–∏
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã {} –∏–ª–∏ –º–∞—Å—Å–∏–≤—ã [] –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª–µ–π –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–∞—è —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–Ω—ã–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –ø—Ä–æ–º–ø—Ç–∞–º–∏.

---

### 5. –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ —Å—Ö–µ–º—É

**–§–∞–π–ª:** `src/models/llm_schemas.py`, –∫–ª–∞—Å—Å `TwoStageExtractionSchema`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```python
class TwoStageExtractionSchema(BaseModel):
    """
    –°—Ö–µ–º–∞ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —ç—Ç–∞–ø–∞ –¥–≤—É—Ö—ç—Ç–∞–ø–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ)
    
    –í–ê–ñ–ù–û: 
    - extracted_data —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–µ –æ–±—ä–µ–∫—Ç—ã, –Ω–µ –º–∞—Å—Å–∏–≤—ã)
      –ö–ª—é—á–∏ = –ø–æ–ª—è –∏–∑ template_variables, –∑–Ω–∞—á–µ–Ω–∏—è = —Å—Ç—Ä–æ–∫–∏ —Å –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    - Optional –ø–æ–ª—è (detected_speaker_mapping –∏ –¥—Ä.) –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–ø–∏–∫–µ—Ä–æ–≤
      –û–Ω–∏ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –µ—Å—Ç—å –º–µ—Ç–∫–∏ SPEAKER_N
    - –í—Å–µ Dict –ø–æ–ª—è –Ω–µ –≤–∫–ª—é—á–∞—é—Ç—Å—è –≤ required –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Azure OpenAI strict mode
      (additionalProperties –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ required fields)
    """
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–µ–ø–µ—Ä—å –ø–æ–Ω–∏–º–∞—é—Ç –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Å—Ö–µ–º—ã –∏ –ø–æ—á–µ–º—É Dict –ø–æ–ª—è –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å required.

---

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:

1. ‚úÖ **–£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è** - –º–æ–¥–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —è—Å–Ω—ã–µ –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
2. ‚úÖ **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å—Ö–µ–º—ã** - –º–æ–¥–µ–ª—å –∑–Ω–∞–µ—Ç –æ–±–æ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–ª—è—Ö
3. ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç –æ–±—Ä–µ–∑–∞–Ω–∏—è JSON** - —è–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –±–æ–ª—å—à–∏–º–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è–º–∏
4. ‚úÖ **–£–ª—É—á—à–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å** - –∫–æ–¥ –∏ —Å—Ö–µ–º—ã —Ö–æ—Ä–æ—à–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã

## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

### –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π 1: –î–ª–∏–Ω–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (11+ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ JSON –Ω–µ –æ–±—Ä–µ–∑–∞–µ—Ç—Å—è –Ω–∞ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–∞—Ö –¥–∞–Ω–Ω—ã—Ö

**–®–∞–≥–∏:**
1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤ –±–æ—Ç –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ —Ñ–∞–π–ª –≤—Å—Ç—Ä–µ—á–∏ —Å 11+ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
2. –î–æ–∂–¥–∏—Ç–µ—Å—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ Stage 1
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–æ—Ç–æ–∫–æ–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ä–µ—à–µ–Ω–∏—è, –∑–∞–¥–∞—á–∏, —É—á–∞—Å—Ç–Ω–∏–∫–∏)

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ —Ç–∏–ø–∞ "Expecting value: line X column Y"
- ‚úÖ JSON –≤–∞–ª–∏–¥–Ω—ã–π –∏ –ø–æ–ª–Ω—ã–π
- ‚úÖ extracted_data —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –∫–ª—é—á–∏ –∏–∑ template_variables
- ‚úÖ –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —Å–æ–∫—Ä–∞—â–µ–Ω—ã, –≤ extraction_notes –µ—Å—Ç—å –ø–æ–º–µ—Ç–∫–∞

### –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π 2: –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —Å –º–µ—Ç–∫–∞–º–∏ SPEAKER_N

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏–∫–µ—Ä–æ–≤

**–®–∞–≥–∏:**
1. –û–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –≤—Å—Ç—Ä–µ—á—É —Å –¥–∏–∞—Ä–∏–∑–∞—Ü–∏–µ–π (–º–µ—Ç–∫–∏ SPEAKER_1, SPEAKER_2, ...)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ª–∏ optional –ø–æ–ª—è:
   - `detected_speaker_mapping`
   - `speaker_confidence_scores`
   - `unmapped_speakers`
   - `mapping_notes`

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å —Å–º–æ–≥–ª–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏–∫–µ—Ä–æ–≤
- ‚úÖ confidence_scores –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 0.0-1.0
- ‚úÖ mapping_notes —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ—è—Å–Ω–µ–Ω–∏—è

### –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π 3: –ö–æ—Ä–æ—Ç–∫–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —É—Ö—É–¥—à–∏–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ –Ω–∞ –æ–±—ã—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–®–∞–≥–∏:**
1. –û–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –∫–æ—Ä–æ—Ç–∫—É—é –≤—Å—Ç—Ä–µ—á—É (3-5 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, 15-30 –º–∏–Ω—É—Ç)
2. –°—Ä–∞–≤–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –≤–µ—Ä—Å–∏—è–º–∏

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –Ω–µ —É—Ö—É–¥—à–∏–ª–æ—Å—å
- ‚úÖ –í—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ù–µ—Ç –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π

## –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ:

1. **–ß–∞—Å—Ç–æ—Ç–∞ –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON** (–¥–æ–ª–∂–Ω–∞ —Å–Ω–∏–∑–∏—Ç—å—Å—è –¥–æ ~0%)
2. **–°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ Stage 1** (–º–æ–∂–µ—Ç –Ω–µ–º–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–∏—Ç—å—Å—è –∏–∑-–∑–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π)
3. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö optional –ø–æ–ª–µ–π** (speaker_mapping –∏ –¥—Ä.)
4. **–ö–∞—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤** –Ω–∞ –¥–ª–∏–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è—Ö (—Å—É–±—ä–µ–∫—Ç–∏–≤–Ω–∞—è –æ—Ü–µ–Ω–∫–∞)

## –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏

‚ö†Ô∏è **–£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–æ–º–ø—Ç–∞** - –¥–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –±–æ–ª—å—à–∏–º–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è–º–∏ (~200 —Ç–æ–∫–µ–Ω–æ–≤)
- **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –≤ extraction prompt, –Ω–µ –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö

‚ö†Ô∏è **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è –º–æ–¥–µ–ª–∏** - –±–æ–ª–µ–µ —á–µ—Ç–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –º–æ–≥—É—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª—å –∏–∑–≤–ª–µ—á–µ–Ω–∏—è
- **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –ü—Ä–æ–≤–µ–¥–∏—Ç–µ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—ã–±–æ—Ä–∫–µ –≤—Å—Ç—Ä–µ—á

‚ö†Ô∏è **Optional –ø–æ–ª—è –º–æ–≥—É—Ç –Ω–µ –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è** - –º–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏—Ö
- **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –ü–æ–ª—è optional, –∏—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã

## –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –ø—Ä–æ–±–ª–µ–º—ã, –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è:

```bash
git revert <commit-hash>
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é –≤–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –≤:
- `llm_providers.py`: —Ñ—É–Ω–∫—Ü–∏–∏ `_build_extraction_prompt()` –∏ `_build_system_prompt()`
- `src/models/llm_schemas.py`: –∫–ª–∞—Å—Å `TwoStageExtractionSchema`

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `docs/EMPTY_PROTOCOL_FIX.md` - –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤
- `docs/STRUCTURED_OUTPUTS_IMPLEMENTATION.md` - –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ structured outputs
- `docs/LLM_PROMPT_IMPROVEMENTS.md` - –∏—Å—Ç–æ—Ä–∏—è —É–ª—É—á—à–µ–Ω–∏–π –ø—Ä–æ–º–ø—Ç–æ–≤

