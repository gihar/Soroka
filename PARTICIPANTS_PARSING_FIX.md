# Исправление парсинга участников

## Проблема
Система неправильно определяла количество участников при парсинге email-приглашений, выдавая ошибку **"Слишком много участников (максимум 20)"** для текста с 18 реальными участниками.

## Причины
1. **Текстовый парсинг воспринимал email-поля как участников**: строки типа "От: ...", "Кому: ...", "Тема: ...", "Когда: ..." распознавались как имена участников
2. **Дедупликация не работала**: ключ `"тимченко алексей александрович"` не совпадал с `"от: тимченко алексей александрович"`
3. **Запятая вместо точки с запятой**: в строке "Старостин Леонид Валериевич, Прохоровская Оксана Александровна" второе имя терялось, так как извлекалось только первое ФИО
4. **Итог**: 17 реальных участников + 4 мусорных записи = 21 "участник" > лимит 20

## Решение

### 1. Фильтрация email-полей
**Файл**: `src/services/participants_service.py`  
**Метод**: `_parse_single_line`

Добавлена фильтрация строк, начинающихся с ключевых слов email-полей:
```python
email_field_prefixes = ['от:', 'кому:', 'копия:', 'cc:', 'тема:', 'subject:', 
                        'когда:', 'when:', 'дата:', 'date:', 'время:', 'time:']
if any(line.lower().startswith(prefix) for prefix in email_field_prefixes):
    return None
```

### 2. Извлечение всех ФИО из строки
**Файл**: `src/services/meeting_info_service.py`  
**Метод**: `_extract_name_from_email_line`

Изменен возвращаемый тип с `Optional[str]` на `List[str]` и использован `findall` вместо `search` для извлечения **всех** ФИО из строки:
```python
# Ищем ВСЕ полные имена (3 слова: Фамилия Имя Отчество)
name_matches = re.findall(r'([А-ЯЁ][а-яё]+\s+[А-ЯЁ][а-яё]+\s+[А-ЯЁ][а-яё]+)', line)
if name_matches:
    return [name.strip() for name in name_matches]
```

### 3. Адаптация связанных методов
Обновлены методы, использующие `_extract_name_from_email_line`:
- `_extract_names_from_list` - теперь использует `extend` вместо `append`
- `_extract_organizer` - берет первое имя из списка
- `_extract_participants` - обрабатывает список имен

## Результат

✅ **До исправления**: 21 "участник" (17 реальных + 4 мусорных) → ❌ Ошибка "Слишком много участников"  
✅ **После исправления**: 18 участников (все реальные) → ✅ Валидация проходит успешно

### Тестовый пример
Для текста:
```
От: Тимченко Алексей Александрович
Кому: Носов Степан Евгеньевич; Поляков Михаил Андреевич; ... 
      Старостин Леонид Валериевич, Прохоровская Оксана Александровна; ...
```

**Результат**:
- 1 участник из "От:"
- 17 участников из "Кому:" (включая оба имени из проблемной строки)
- 0 мусорных записей (email-поля отфильтрованы)
- **Итого: 18 участников ✅**

## Измененные файлы
- `/Users/timchenko/Soroka/src/services/participants_service.py`
- `/Users/timchenko/Soroka/src/services/meeting_info_service.py`

## Дата исправления
27 октября 2025 г.

