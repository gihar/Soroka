"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback –∑–∞–ø—Ä–æ—Å–æ–≤
"""

from aiogram import Router, F
from aiogram.types import CallbackQuery, InlineKeyboardButton, InlineKeyboardMarkup
from aiogram.fsm.context import FSMContext
from loguru import logger

from services import UserService, TemplateService, EnhancedLLMService, OptimizedProcessingService
from src.utils.pdf_converter import convert_markdown_to_pdf


async def _safe_callback_answer(callback: CallbackQuery, text: str = None):
    """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ callback query —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"""
    try:
        await callback.answer(text=text)
    except Exception as e:
        error_str = str(e).lower()
        if "query is too old" in error_str or "query id is invalid" in error_str:
            logger.debug(f"Callback query —É—Å—Ç–∞—Ä–µ–ª: {e}")
        else:
            logger.warning(f"–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ callback: {e}")


def setup_callback_handlers(user_service: UserService, template_service: TemplateService,
                           llm_service: EnhancedLLMService, processing_service: OptimizedProcessingService) -> Router:
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ callback –∑–∞–ø—Ä–æ—Å–æ–≤"""
    router = Router()
    
    @router.callback_query(F.data.startswith("set_llm_"))
    async def set_llm_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ LLM"""
        try:
            llm_provider = callback.data.replace("set_llm_", "")
            
            await user_service.update_user_llm_preference(callback.from_user.id, llm_provider)
            
            available_providers = llm_service.get_available_providers()
            provider_name = available_providers.get(llm_provider, llm_provider)
            
            await callback.message.edit_text(
                f"‚úÖ LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: {provider_name}\n\n"
                f"–¢–µ–ø–µ—Ä—å —ç—Ç–æ—Ç LLM –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫."
            )
            await callback.answer()
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ set_llm_callback: {e}")
            await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫")
    
    @router.callback_query(F.data == "reset_llm_preference")
    async def reset_llm_preference_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–±—Ä–æ—Å–∞ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π LLM"""
        try:
            await user_service.update_user_llm_preference(callback.from_user.id, None)
            
            await callback.message.edit_text(
                "üîÑ –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è LLM —Å–±—Ä–æ—à–µ–Ω—ã.\n\n"
                "–¢–µ–ø–µ—Ä—å –±–æ—Ç –±—É–¥–µ—Ç —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –≤—ã–±–æ—Ä LLM –ø—Ä–∏ –∫–∞–∂–¥–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞."
            )
            await callback.answer()
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ reset_llm_preference_callback: {e}")
            await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫")
    
    @router.callback_query(F.data.startswith("select_template_"))
    async def select_template_callback(callback: CallbackQuery, state: FSMContext):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —à–∞–±–ª–æ–Ω–∞"""
        try:
            # –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback query
            await _safe_callback_answer(callback)
            
            template_id = int(callback.data.replace("select_template_", ""))
            await state.update_data(template_id=template_id)
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä LLM
            await _show_llm_selection(callback, state, user_service, llm_service, processing_service)
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ select_template_callback: {e}")
            await _safe_callback_answer(callback, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —à–∞–±–ª–æ–Ω–∞")
    
    @router.callback_query(F.data.startswith("use_default_template_"))
    async def use_default_template_callback(callback: CallbackQuery, state: FSMContext):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        try:
            # –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback query
            await _safe_callback_answer(callback)
            
            template_id = int(callback.data.replace("use_default_template_", ""))
            await state.update_data(template_id=template_id)
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä LLM
            await _show_llm_selection(callback, state, user_service, llm_service, processing_service)
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ use_default_template_callback: {e}")
            await _safe_callback_answer(callback, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —à–∞–±–ª–æ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
    
    @router.callback_query(F.data == "show_all_templates")
    async def show_all_templates_callback(callback: CallbackQuery, state: FSMContext):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö —à–∞–±–ª–æ–Ω–æ–≤"""
        try:
            from services import TemplateService
            template_service = TemplateService()
            
            templates = await template_service.get_all_templates()
            
            if not templates:
                await callback.message.edit_text("‚ùå –®–∞–±–ª–æ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
                return
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(
                    text=f"{'‚≠ê ' if t.is_default else ''}{t.name}",
                    callback_data=f"select_template_{t.id}"
                )]
                for t in templates
            ])
            
            await callback.message.edit_text(
                "üìù –í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –¥–ª—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞:",
                reply_markup=keyboard
            )
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ show_all_templates_callback: {e}")
            await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —à–∞–±–ª–æ–Ω–æ–≤")
    
    @router.callback_query(F.data.startswith("select_llm_"))
    async def select_llm_callback(callback: CallbackQuery, state: FSMContext):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ LLM –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏"""
        try:
            # –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback query
            await _safe_callback_answer(callback)
            
            llm_provider = callback.data.replace("select_llm_", "")
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ
            await user_service.update_user_llm_preference(callback.from_user.id, llm_provider)
            await state.update_data(llm_provider=llm_provider)
            
            # –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
            await _process_file(callback, state, processing_service)
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ select_llm_callback: {e}")
            await _safe_callback_answer(callback, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ LLM")
    
    @router.callback_query(F.data.startswith("set_transcription_mode_"))
    async def set_transcription_mode_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏"""
        try:
            mode = callback.data.replace("set_transcription_mode_", "")
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            from config import settings
            settings.transcription_mode = mode
            
            mode_names = {
                "local": "–õ–æ–∫–∞–ª—å–Ω–∞—è (Whisper)",
                "cloud": "–û–±–ª–∞—á–Ω–∞—è (Groq)",
                "hybrid": "–ì–∏–±—Ä–∏–¥–Ω–∞—è (Groq + –¥–∏–∞—Ä–∏–∑–∞—Ü–∏—è)",
                "speechmatics": "Speechmatics",
                "deepgram": "Deepgram",
                "leopard": "Leopard (Picovoice)"
            }
            
            mode_name = mode_names.get(mode, mode)
            
            await callback.message.edit_text(
                f"‚úÖ **–†–µ–∂–∏–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞:** {mode_name}\n\n"
                f"–ù–æ–≤—ã–π —Ä–µ–∂–∏–º –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫ —Ñ–∞–π–ª–æ–≤.",
                parse_mode="Markdown"
            )
            await callback.answer()
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ set_transcription_mode_callback: {e}")
            await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏")
    
    @router.callback_query(F.data.startswith("view_template_category_"))
    async def view_template_category_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —à–∞–±–ª–æ–Ω–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
        try:
            category = callback.data.replace("view_template_category_", "")
            
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —à–∞–±–ª–æ–Ω—ã
            all_templates = await template_service.get_all_templates()
            
            # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if category == "all":
                templates = all_templates
                category_title = "–í—Å–µ —à–∞–±–ª–æ–Ω—ã"
            else:
                templates = [t for t in all_templates if (t.category or 'general') == category]
                category_names = {
                    'management': 'üëî –£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–µ',
                    'product': 'üöÄ –ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ',
                    'technical': '‚öôÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ',
                    'general': 'üìã –û–±—â–∏–µ',
                    'sales': 'üíº –ü—Ä–æ–¥–∞–∂–∏'
                }
                category_title = category_names.get(category, category.title())
            
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω—ã: is_default —Å–Ω–∞—á–∞–ª–∞, –∑–∞—Ç–µ–º –ø–æ –∏–º–µ–Ω–∏
            templates.sort(key=lambda t: (not t.is_default, t.name))
            
            # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å —à–∞–±–ª–æ–Ω–∞–º–∏
            keyboard_buttons = [
                [InlineKeyboardButton(
                    text=f"{'‚≠ê ' if t.is_default else ''}{t.name}",
                    callback_data=f"view_template_{t.id}"
                )] for t in templates
            ]
            
            keyboard_buttons.extend([
                [InlineKeyboardButton(
                    text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º",
                    callback_data="back_to_templates"
                )]
            ])
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=keyboard_buttons)
            
            await callback.message.edit_text(
                f"üìù **{category_title}**\n\n"
                f"–ù–∞–π–¥–µ–Ω–æ —à–∞–±–ª–æ–Ω–æ–≤: {len(templates)}",
                reply_markup=keyboard
            )
            await callback.answer()
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ view_template_category_callback: {e}")
            await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —à–∞–±–ª–æ–Ω–æ–≤")
    
    @router.callback_query(F.data.startswith("view_template_"))
    async def view_template_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —à–∞–±–ª–æ–Ω–∞"""
        try:
            template_id = int(callback.data.replace("view_template_", ""))
            template = await template_service.get_template_by_id(template_id)
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ —É–¥–∞–ª–µ–Ω–∏—è: –≤–ª–∞–¥–µ–ª–µ—Ü –∏ –Ω–µ –±–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω
            try:
                user = await user_service.get_user_by_telegram_id(callback.from_user.id)
                owned_ids = set()
                if user:
                    owned_ids.add(user.id)
                owned_ids.add(callback.from_user.id)  # –ø–æ–¥–¥–µ—Ä–∂–∫–∞ legacy-—à–∞–±–ª–æ–Ω–æ–≤
                can_delete = (not template.is_default) and (template.created_by in owned_ids)
            except Exception:
                can_delete = False
            
            text = f"üìù **{template.name}**\n\n"
            if template.description:
                text += f"*–û–ø–∏—Å–∞–Ω–∏–µ:* {template.description}\n\n"
            
            text += f"```\n{template.content}\n```"
            
            # –ö–Ω–æ–ø–∫–∏: —É–¥–∞–ª–∏—Ç—å –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É
            rows = []
            if can_delete:
                rows.append([InlineKeyboardButton(
                    text="üóë –£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω",
                    callback_data=f"delete_template_{template.id}"
                )])
            rows.append([InlineKeyboardButton(
                text="üîô –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —à–∞–±–ª–æ–Ω–æ–≤",
                callback_data="back_to_templates"
            )])
            keyboard = InlineKeyboardMarkup(inline_keyboard=rows)
            
            await callback.message.edit_text(text, parse_mode="Markdown", reply_markup=keyboard)
            await callback.answer()
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ view_template_callback: {e}")
            await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ —à–∞–±–ª–æ–Ω–∞")

    @router.callback_query(F.data.startswith("delete_template_"))
    async def delete_template_prompt_callback(callback: CallbackQuery):
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è"""
        try:
            template_id = int(callback.data.replace("delete_template_", ""))
            template = await template_service.get_template_by_id(template_id)

            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [
                    InlineKeyboardButton(text="‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å", callback_data=f"confirm_delete_template_{template_id}"),
                    InlineKeyboardButton(text="‚Ü©Ô∏è –û—Ç–º–µ–Ω–∞", callback_data=f"view_template_{template_id}")
                ]
            ])
            await callback.message.edit_text(
                f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω:\n\n‚Ä¢ {template.name}",
                reply_markup=keyboard
            )
            await callback.answer()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ delete_template_prompt_callback: {e}")
            await callback.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è")

    @router.callback_query(F.data.startswith("confirm_delete_template_"))
    async def confirm_delete_template_callback(callback: CallbackQuery):
        """–£–¥–∞–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"""
        try:
            template_id = int(callback.data.replace("confirm_delete_template_", ""))
            success = await template_service.delete_template(callback.from_user.id, template_id)

            if success:
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
                templates = await template_service.get_all_templates()
                keyboard = InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(
                        text=f"{'‚≠ê ' if t.is_default else ''}{t.name}",
                        callback_data=f"view_template_{t.id}"
                    )] for t in templates
                ] + [[InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω", callback_data="add_template")]])

                await callback.message.edit_text(
                    "üóë –®–∞–±–ª–æ–Ω —É–¥–∞–ª—ë–Ω.\n\nüìù **–î–æ—Å—Ç—É–ø–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã:**",
                    reply_markup=keyboard,
                    parse_mode="Markdown"
                )
                await callback.answer()
            else:
                await callback.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ confirm_delete_template_callback: {e}")
            await callback.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —à–∞–±–ª–æ–Ω–∞")
    
    @router.callback_query(F.data == "back_to_templates")
    async def back_to_templates_callback(callback: CallbackQuery):
        """–í–æ–∑–≤—Ä–∞—Ç –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —à–∞–±–ª–æ–Ω–æ–≤"""
        try:
            templates = await template_service.get_all_templates()
            
            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            from collections import defaultdict
            categories = defaultdict(list)
            for template in templates:
                category = template.category or 'general'
                categories[category].append(template)
            
            # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
            category_names = {
                'management': 'üëî –£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–µ',
                'product': 'üöÄ –ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ',
                'technical': '‚öôÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ',
                'general': 'üìã –û–±—â–∏–µ',
                'sales': 'üíº –ü—Ä–æ–¥–∞–∂–∏'
            }
            
            keyboard_buttons = []
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            for category, cat_templates in sorted(categories.items()):
                category_name = category_names.get(category, f'üìÅ {category.title()}')
                keyboard_buttons.append([InlineKeyboardButton(
                    text=f"{category_name} ({len(cat_templates)})",
                    callback_data=f"view_template_category_{category}"
                )])
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–í—Å–µ —à–∞–±–ª–æ–Ω—ã"
            keyboard_buttons.append([InlineKeyboardButton(
                text="üìù –í—Å–µ —à–∞–±–ª–æ–Ω—ã",
                callback_data="view_template_category_all"
            )])
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–∞
            keyboard_buttons.append([InlineKeyboardButton(
                text="‚ûï –î–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω",
                callback_data="add_template"
            )])
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=keyboard_buttons)
            
            await callback.message.edit_text(
                f"üìù **–î–æ—Å—Ç—É–ø–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã:** {len(templates)}\n\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:",
                reply_markup=keyboard,
                parse_mode="Markdown"
            )
            await callback.answer()
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ back_to_templates_callback: {e}")
            await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —à–∞–±–ª–æ–Ω–æ–≤")
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    @router.callback_query(F.data == "settings_preferred_llm")
    async def settings_preferred_llm_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–æ–≥–æ –ò–ò"""
        try:
            available_providers = llm_service.get_available_providers()
            
            # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ LLM
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(
                    text=f"ü§ñ {provider_name}",
                    callback_data=f"set_llm_{provider_key}"
                )] for provider_key, provider_name in available_providers.items()
            ] + [
                [InlineKeyboardButton(
                    text="üîÑ –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ",
                    callback_data="reset_llm_preference"
                )],
                [InlineKeyboardButton(
                    text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º",
                    callback_data="back_to_settings"
                )]
            ])
            
            await callback.message.edit_text(
                "ü§ñ **–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π –ò–ò**\n\n"
                "–≠—Ç–æ—Ç –ò–ò –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫:",
                reply_markup=keyboard
            )
            await callback.answer()
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ settings_preferred_llm_callback: {e}")
            await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫")

    @router.callback_query(F.data == "settings_openai_model")
    async def settings_openai_model_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ OpenAI"""
        try:
            from config import settings as app_settings
            models = getattr(app_settings, 'openai_models', [])
            if not models or len(models) == 0:
                await callback.message.edit_text(
                    "‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –º–æ–¥–µ–ª–∏ OpenAI.\n\n"
                    "–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `OPENAI_MODELS` —Å –ø–µ—Ä–µ—á–Ω–µ–º –ø—Ä–µ—Å–µ—Ç–æ–≤.",
                    reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                        [InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º", callback_data="back_to_settings")]
                    ])
                )
                await callback.answer()
                return
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –µ–≥–æ –≤—ã–±–æ—Ä
            user = await user_service.get_user_by_telegram_id(callback.from_user.id)
            selected_key = getattr(user, 'preferred_openai_model_key', None) if user else None

            keyboard_rows = []
            for p in models:
                label = f"{'‚úÖ ' if selected_key == p.key else ''}{p.name}"
                keyboard_rows.append([InlineKeyboardButton(text=label, callback_data=f"set_openai_model_{p.key}")])
            keyboard_rows.append([InlineKeyboardButton(text="üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏", callback_data="reset_openai_model_preference")])
            keyboard_rows.append([InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º", callback_data="back_to_settings")])

            await callback.message.edit_text(
                "üß† **–ú–æ–¥–µ–ª—å OpenAI**\n\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ OpenAI:",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=keyboard_rows)
            )
            await callback.answer()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ settings_openai_model_callback: {e}")
            await callback.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª–∏ OpenAI")

    @router.callback_query(F.data.startswith("set_openai_model_"))
    async def set_openai_model_callback(callback: CallbackQuery):
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—É—é –º–æ–¥–µ–ª—å OpenAI"""
        try:
            model_key = callback.data.replace("set_openai_model_", "")
            await user_service.update_user_openai_model_preference(callback.from_user.id, model_key)
            # –ù–∞—Ö–æ–¥–∏–º —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –∏–º—è –º–æ–¥–µ–ª–∏ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            try:
                from config import settings as app_settings
                preset = next((p for p in getattr(app_settings, 'openai_models', []) if p.key == model_key), None)
                model_name = preset.name if preset else model_key
            except Exception:
                model_name = model_key
            await callback.message.edit_text(
                f"‚úÖ –ú–æ–¥–µ–ª—å OpenAI –æ–±–Ω–æ–≤–ª–µ–Ω–∞: {model_name}.\n\n"
                "–û–Ω–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ OpenAI.",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º", callback_data="back_to_settings")]
                ])
            )
            await callback.answer()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ set_openai_model_callback: {e}")
            await callback.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏")

    @router.callback_query(F.data == "reset_openai_model_preference")
    async def reset_openai_model_preference_callback(callback: CallbackQuery):
        """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—É—é –º–æ–¥–µ–ª—å OpenAI"""
        try:
            await user_service.update_user_openai_model_preference(callback.from_user.id, None)
            await callback.message.edit_text(
                "üîÑ –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ OpenAI —Å–±—Ä–æ—à–µ–Ω.\n\n"
                "–ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø—Ä–µ—Å–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º", callback_data="back_to_settings")]
                ])
            )
            await callback.answer()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ reset_openai_model_preference_callback: {e}")
            await callback.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏")
    
    
    
    @router.callback_query(F.data == "settings_default_template")
    async def settings_default_template_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —à–∞–±–ª–æ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã
            all_templates = await template_service.get_all_templates()
            
            if not all_templates:
                # –ï—Å–ª–∏ –Ω–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–æ–∑–¥–∞—Ç—å
                keyboard = InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(
                        text="üìù –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω",
                        callback_data="create_template"
                    )],
                    [InlineKeyboardButton(
                        text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º",
                        callback_data="back_to_settings"
                    )]
                ])
                
                await callback.message.edit_text(
                    "üìù **–®–∞–±–ª–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**\n\n"
                    "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤.\n"
                    "–°–æ–∑–¥–∞–π—Ç–µ —à–∞–±–ª–æ–Ω, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ–≥–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:",
                    reply_markup=keyboard
                )
            else:
                # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                from collections import defaultdict
                categories = defaultdict(list)
                for template in all_templates:
                    category = template.category or 'general'
                    categories[category].append(template)
                
                # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
                category_names = {
                    'management': 'üëî –£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–µ',
                    'product': 'üöÄ –ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ',
                    'technical': '‚öôÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ',
                    'general': 'üìã –û–±—â–∏–µ',
                    'sales': 'üíº –ü—Ä–æ–¥–∞–∂–∏'
                }
                
                keyboard_buttons = []
                
                # –ü–ï–†–í–ê–Ø –∫–Ω–æ–ø–∫–∞ - –£–º–Ω—ã–π –≤—ã–±–æ—Ä (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
                keyboard_buttons.append([InlineKeyboardButton(
                    text="ü§ñ –£–º–Ω—ã–π –≤—ã–±–æ—Ä (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)",
                    callback_data="set_default_template_0"  # 0 = —É–º–Ω—ã–π –≤—ã–±–æ—Ä
                )])
                
                # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —à–∞–±–ª–æ–Ω–æ–≤
                for category, templates in sorted(categories.items()):
                    category_name = category_names.get(category, f'üìÅ {category.title()}')
                    keyboard_buttons.append([InlineKeyboardButton(
                        text=f"{category_name} ({len(templates)})",
                        callback_data=f"template_category_{category}"
                    )])
                
                keyboard_buttons.extend([
                    [InlineKeyboardButton(
                        text="üìù –í—Å–µ —à–∞–±–ª–æ–Ω—ã",
                        callback_data="template_category_all"
                    )],
                    [InlineKeyboardButton(
                        text="üîÑ –°–±—Ä–æ—Å–∏—Ç—å —à–∞–±–ª–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
                        callback_data="reset_default_template"
                    )],
                    [InlineKeyboardButton(
                        text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º",
                        callback_data="back_to_settings"
                    )]
                ])
                
                keyboard = InlineKeyboardMarkup(inline_keyboard=keyboard_buttons)
                
                await callback.message.edit_text(
                    "üìù **–®–∞–±–ª–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**\n\n"
                    "ü§ñ **–£–º–Ω—ã–π –≤—ã–±–æ—Ä** - –ò–ò –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–µ—Ä—ë—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π —à–∞–±–ª–æ–Ω\n"
                    "üìÅ **–ö–∞—Ç–µ–≥–æ—Ä–∏–∏** - –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —à–∞–±–ª–æ–Ω\n\n"
                    "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:",
                    reply_markup=keyboard,
                    parse_mode="Markdown"
                )
            
            await callback.answer()
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ settings_default_template_callback: {e}")
            await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫")
    
    @router.callback_query(F.data.startswith("template_category_"))
    async def template_category_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —à–∞–±–ª–æ–Ω–æ–≤"""
        try:
            category = callback.data.replace("template_category_", "")
            
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —à–∞–±–ª–æ–Ω—ã
            all_templates = await template_service.get_all_templates()
            
            # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if category == "all":
                templates = all_templates
                category_title = "–í—Å–µ —à–∞–±–ª–æ–Ω—ã"
            else:
                templates = [t for t in all_templates if (t.category or 'general') == category]
                category_names = {
                    'management': 'üëî –£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–µ',
                    'product': 'üöÄ –ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ',
                    'technical': '‚öôÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ',
                    'general': 'üìã –û–±—â–∏–µ',
                    'sales': 'üíº –ü—Ä–æ–¥–∞–∂–∏'
                }
                category_title = category_names.get(category, category.title())
            
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω—ã: is_default —Å–Ω–∞—á–∞–ª–∞, –∑–∞—Ç–µ–º –ø–æ –∏–º–µ–Ω–∏
            templates.sort(key=lambda t: (not t.is_default, t.name))
            
            # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å —à–∞–±–ª–æ–Ω–∞–º–∏
            keyboard_buttons = [
                [InlineKeyboardButton(
                    text=f"{'‚≠ê ' if t.is_default else ''}{t.name}",
                    callback_data=f"set_default_template_{t.id}"
                )] for t in templates
            ]
            
            keyboard_buttons.extend([
                [InlineKeyboardButton(
                    text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º",
                    callback_data="settings_default_template"
                )]
            ])
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=keyboard_buttons)
            
            await callback.message.edit_text(
                f"üìù **{category_title}**\n\n"
                f"–ù–∞–π–¥–µ–Ω–æ —à–∞–±–ª–æ–Ω–æ–≤: {len(templates)}\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:",
                reply_markup=keyboard
            )
            await callback.answer()
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ template_category_callback: {e}")
            await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —à–∞–±–ª–æ–Ω–æ–≤")
    
    @router.callback_query(F.data.startswith("file_template_category_"))
    async def file_template_category_callback(callback: CallbackQuery, state: FSMContext):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è —Ñ–∞–π–ª–∞"""
        try:
            category = callback.data.replace("file_template_category_", "")
            
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —à–∞–±–ª–æ–Ω—ã
            all_templates = await template_service.get_all_templates()
            
            # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if category == "all":
                templates = all_templates
                category_title = "–í—Å–µ —à–∞–±–ª–æ–Ω—ã"
            else:
                templates = [t for t in all_templates if (t.category or 'general') == category]
                category_names = {
                    'management': 'üëî –£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–µ',
                    'product': 'üöÄ –ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ',
                    'technical': '‚öôÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ',
                    'general': 'üìã –û–±—â–∏–µ',
                    'sales': 'üíº –ü—Ä–æ–¥–∞–∂–∏'
                }
                category_title = category_names.get(category, category.title())
            
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω—ã: is_default —Å–Ω–∞—á–∞–ª–∞, –∑–∞—Ç–µ–º –ø–æ –∏–º–µ–Ω–∏
            templates.sort(key=lambda t: (not t.is_default, t.name))
            
            # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å —à–∞–±–ª–æ–Ω–∞–º–∏
            keyboard_buttons = [
                [InlineKeyboardButton(
                    text=f"{'‚≠ê ' if t.is_default else ''}{t.name}",
                    callback_data=f"select_template_{t.id}"
                )] for t in templates
            ]
            
            keyboard_buttons.append([InlineKeyboardButton(
                text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º",
                callback_data="back_to_template_categories"
            )])
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=keyboard_buttons)
            
            await callback.message.edit_text(
                f"üìù **{category_title}**\n\n"
                f"–ù–∞–π–¥–µ–Ω–æ —à–∞–±–ª–æ–Ω–æ–≤: {len(templates)}\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω:",
                reply_markup=keyboard
            )
            await callback.answer()
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ file_template_category_callback: {e}")
            await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —à–∞–±–ª–æ–Ω–æ–≤")
    
    @router.callback_query(F.data == "back_to_template_categories")
    async def back_to_template_categories_callback(callback: CallbackQuery, state: FSMContext):
        """–í–æ–∑–≤—Ä–∞—Ç –∫ –≤—ã–±–æ—Ä—É –∫–∞—Ç–µ–≥–æ—Ä–∏–π —à–∞–±–ª–æ–Ω–æ–≤"""
        try:
            templates = await template_service.get_all_templates()
            
            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            from collections import defaultdict
            categories = defaultdict(list)
            for template in templates:
                category = template.category or 'general'
                categories[category].append(template)
            
            # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
            category_names = {
                'management': 'üëî –£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–µ',
                'product': 'üöÄ –ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ',
                'technical': '‚öôÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ',
                'general': 'üìã –û–±—â–∏–µ',
                'sales': 'üíº –ü—Ä–æ–¥–∞–∂–∏'
            }
            
            keyboard_buttons = []
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–º–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
            keyboard_buttons.append([InlineKeyboardButton(
                text="ü§ñ –£–º–Ω—ã–π –≤—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞",
                callback_data="smart_template_selection"
            )])
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            for category, cat_templates in sorted(categories.items()):
                category_name = category_names.get(category, f'üìÅ {category.title()}')
                keyboard_buttons.append([InlineKeyboardButton(
                    text=f"{category_name} ({len(cat_templates)})",
                    callback_data=f"file_template_category_{category}"
                )])
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–í—Å–µ —à–∞–±–ª–æ–Ω—ã"
            keyboard_buttons.append([InlineKeyboardButton(
                text="üìù –í—Å–µ —à–∞–±–ª–æ–Ω—ã",
                callback_data="file_template_category_all"
            )])
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=keyboard_buttons)
            
            await callback.message.edit_text(
                "üìù **–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –¥–ª—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞:**\n\n"
                "ü§ñ **–£–º–Ω—ã–π –≤—ã–±–æ—Ä** - –ò–ò –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–µ—Ä—ë—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π —à–∞–±–ª–æ–Ω\n"
                "üìÅ **–ö–∞—Ç–µ–≥–æ—Ä–∏–∏** - –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≤—Å—Ç—Ä–µ—á–∏",
                reply_markup=keyboard,
                parse_mode="Markdown"
            )
            await callback.answer()
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ back_to_template_categories_callback: {e}")
            await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞")
    
    @router.callback_query(F.data == "smart_template_selection")
    async def smart_template_selection_callback(callback: CallbackQuery, state: FSMContext):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–º–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —à–∞–±–ª–æ–Ω–∞ —á–µ—Ä–µ–∑ ML"""
        try:
            # –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback query
            await _safe_callback_answer(callback)
            
            # –ù–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º template_id - –ø–æ–∑–≤–æ–ª—è–µ–º ML-—Å–µ–ª–µ–∫—Ç–æ—Ä—É –≤—ã–±—Ä–∞—Ç—å –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
            await state.update_data(template_id=0, use_smart_selection=True)
            
            await callback.message.edit_text(
                "ü§ñ **–£–º–Ω—ã–π –≤—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!**\n\n"
                "–ò–ò –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–∞—à–µ–π –≤—Å—Ç—Ä–µ—á–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–µ—Ä—ë—Ç "
                "–Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —à–∞–±–ª–æ–Ω –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏.\n\n"
                "‚è≥ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤—ã–±–æ—Ä—É –ò–ò –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏...",
                parse_mode="Markdown"
            )
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä LLM –∏—Å–ø–æ–ª—å–∑—É—è —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è callback
            await _show_llm_selection(callback, state, user_service, llm_service, processing_service)
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ smart_template_selection_callback: {e}")
            await _safe_callback_answer(callback, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —É–º–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞")
    
    @router.callback_query(F.data == "quick_smart_select")
    async def quick_smart_selection_callback(callback: CallbackQuery, state: FSMContext):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –±—ã—Å—Ç—Ä–æ–≥–æ —É–º–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —à–∞–±–ª–æ–Ω–∞"""
        try:
            # –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback query
            await _safe_callback_answer(callback)
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–º–Ω—ã–π –≤—ã–±–æ—Ä
            await state.update_data(template_id=0, use_smart_selection=True)
            
            await callback.message.edit_text(
                "ü§ñ **–£–º–Ω—ã–π –≤—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞**\n\n"
                "–ò–ò –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–µ—Ä—ë—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π —à–∞–±–ª–æ–Ω –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏.\n\n"
                "‚è≥ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤—ã–±–æ—Ä—É –ò–ò –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏...",
                parse_mode="Markdown"
            )
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä LLM
            await _show_llm_selection(callback, state, user_service, llm_service, processing_service)
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ quick_smart_selection_callback: {e}")
            await _safe_callback_answer(callback, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —É–º–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞")
    
    @router.callback_query(F.data == "use_saved_default")
    async def use_saved_default_callback(callback: CallbackQuery, state: FSMContext):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        try:
            # –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback query
            await _safe_callback_answer(callback)
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –µ–≥–æ —à–∞–±–ª–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            user = await user_service.get_user_by_telegram_id(callback.from_user.id)
            
            if not user or not user.default_template_id:
                await callback.message.edit_text(
                    "‚ùå **–û—à–∏–±–∫–∞**\n\n"
                    "–£ –≤–∞—Å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —à–∞–±–ª–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.",
                    parse_mode="Markdown"
                )
                return
            
            # –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω —É–º–Ω—ã–π –≤—ã–±–æ—Ä (template_id = 0)
            if user.default_template_id == 0:
                await state.update_data(template_id=0, use_smart_selection=True)
                await callback.message.edit_text(
                    "ü§ñ **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –£–º–Ω—ã–π –≤—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞**\n\n"
                    "–ò–ò –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–µ—Ä—ë—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π —à–∞–±–ª–æ–Ω –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏.\n\n"
                    "‚è≥ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤—ã–±–æ—Ä—É –ò–ò –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏...",
                    parse_mode="Markdown"
                )
            else:
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —à–∞–±–ª–æ–Ω
                template = await template_service.get_template_by_id(user.default_template_id)
                if not template:
                    await callback.message.edit_text(
                        "‚ùå **–û—à–∏–±–∫–∞**\n\n"
                        "–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.",
                        parse_mode="Markdown"
                    )
                    return
                
                await state.update_data(template_id=template.id, use_smart_selection=False)
                await callback.message.edit_text(
                    f"üìã **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —à–∞–±–ª–æ–Ω: {template.name}**\n\n"
                    "‚è≥ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤—ã–±–æ—Ä—É –ò–ò –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏...",
                    parse_mode="Markdown"
                )
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä LLM
            await _show_llm_selection(callback, state, user_service, llm_service, processing_service)
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ use_saved_default_callback: {e}")
            await _safe_callback_answer(callback, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —à–∞–±–ª–æ–Ω–∞")
    
    @router.callback_query(F.data == "quick_set_default")
    async def quick_set_default_callback(callback: CallbackQuery, state: FSMContext):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –±—ã—Å—Ç—Ä–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —à–∞–±–ª–æ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        try:
            # –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback query
            await _safe_callback_answer(callback)
            
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —à–∞–±–ª–æ–Ω—ã
            templates = await template_service.get_all_templates()
            
            if not templates:
                await callback.message.edit_text(
                    "‚ùå **–®–∞–±–ª–æ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã**\n\n"
                    "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
                    parse_mode="Markdown"
                )
                return
            
            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            from collections import defaultdict
            categories = defaultdict(list)
            for template in templates:
                category = template.category or 'general'
                categories[category].append(template)
            
            # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
            category_names = {
                'management': 'üëî –£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–µ',
                'product': 'üöÄ –ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ',
                'technical': '‚öôÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ',
                'general': 'üìã –û–±—â–∏–µ',
                'sales': 'üíº –ü—Ä–æ–¥–∞–∂–∏'
            }
            
            keyboard_buttons = []
            
            # –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–£–º–Ω—ã–π –≤—ã–±–æ—Ä" –ø–µ—Ä–≤–æ–π
            keyboard_buttons.append([InlineKeyboardButton(
                text="ü§ñ –£–º–Ω—ã–π –≤—ã–±–æ—Ä (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)",
                callback_data="quick_template_smart"
            )])
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            for category, cat_templates in sorted(categories.items()):
                category_name = category_names.get(category, f'üìÅ {category.title()}')
                keyboard_buttons.append([InlineKeyboardButton(
                    text=f"{category_name} ({len(cat_templates)})",
                    callback_data=f"quick_category_{category}"
                )])
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–í—Å–µ —à–∞–±–ª–æ–Ω—ã"
            keyboard_buttons.append([InlineKeyboardButton(
                text="üìù –í—Å–µ —à–∞–±–ª–æ–Ω—ã",
                callback_data="quick_category_all"
            )])
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=keyboard_buttons)
            
            await callback.message.edit_text(
                "‚öôÔ∏è **–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:**\n\n"
                "–í—ã–±—Ä–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞.",
                reply_markup=keyboard,
                parse_mode="Markdown"
            )
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ quick_set_default_callback: {e}")
            await _safe_callback_answer(callback, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —à–∞–±–ª–æ–Ω–æ–≤")
    
    @router.callback_query(F.data.startswith("quick_category_"))
    async def quick_category_callback(callback: CallbackQuery, state: FSMContext):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —à–∞–±–ª–æ–Ω–∞"""
        try:
            await _safe_callback_answer(callback)
            
            category = callback.data.replace("quick_category_", "")
            
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —à–∞–±–ª–æ–Ω—ã
            all_templates = await template_service.get_all_templates()
            
            # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if category == "all":
                templates = all_templates
                category_title = "–í—Å–µ —à–∞–±–ª–æ–Ω—ã"
            else:
                templates = [t for t in all_templates if (t.category or 'general') == category]
                category_names = {
                    'management': 'üëî –£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–µ',
                    'product': 'üöÄ –ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ',
                    'technical': '‚öôÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ',
                    'general': 'üìã –û–±—â–∏–µ',
                    'sales': 'üíº –ü—Ä–æ–¥–∞–∂–∏'
                }
                category_title = category_names.get(category, category.title())
            
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω—ã
            templates.sort(key=lambda t: (not t.is_default, t.name))
            
            # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å —à–∞–±–ª–æ–Ω–∞–º–∏
            keyboard_buttons = [
                [InlineKeyboardButton(
                    text=f"{'‚≠ê ' if t.is_default else ''}{t.name}",
                    callback_data=f"quick_template_{t.id}"
                )] for t in templates
            ]
            
            keyboard_buttons.append([InlineKeyboardButton(
                text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º",
                callback_data="quick_set_default"
            )])
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=keyboard_buttons)
            
            await callback.message.edit_text(
                f"‚öôÔ∏è **{category_title}**\n\n"
                f"–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω ({len(templates)}):",
                reply_markup=keyboard,
                parse_mode="Markdown"
            )
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ quick_category_callback: {e}")
            await _safe_callback_answer(callback, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —à–∞–±–ª–æ–Ω–æ–≤")
    
    @router.callback_query(F.data.startswith("quick_template_"))
    async def quick_template_callback(callback: CallbackQuery, state: FSMContext):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏"""
        try:
            await _safe_callback_answer(callback)
            
            template_ref = callback.data.replace("quick_template_", "")
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–ª—É—á–∞–π "smart"
            if template_ref == "smart":
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º —É–º–Ω—ã–π –≤—ã–±–æ—Ä –∫–∞–∫ —à–∞–±–ª–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (id = 0)
                await template_service.set_user_default_template(callback.from_user.id, 0)
                await state.update_data(template_id=0, use_smart_selection=True)
                
                await callback.message.edit_text(
                    "‚úÖ **–£–º–Ω—ã–π –≤—ã–±–æ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**\n\n"
                    "ü§ñ –ò–ò –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–µ—Ä—ë—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π —à–∞–±–ª–æ–Ω.\n\n"
                    "‚è≥ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤—ã–±–æ—Ä—É –ò–ò –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏...",
                    parse_mode="Markdown"
                )
            else:
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞
                template_id = int(template_ref)
                template = await template_service.get_template_by_id(template_id)
                
                if not template:
                    await callback.message.edit_text(
                        "‚ùå **–û—à–∏–±–∫–∞**\n\n"
                        "–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.",
                        parse_mode="Markdown"
                    )
                    return
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º —à–∞–±–ª–æ–Ω –∫–∞–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                await template_service.set_user_default_template(callback.from_user.id, template_id)
                await state.update_data(template_id=template_id, use_smart_selection=False)
                
                await callback.message.edit_text(
                    f"‚úÖ **–®–∞–±–ª–æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {template.name}**\n\n"
                    f"–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.\n\n"
                    "‚è≥ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤—ã–±–æ—Ä—É –ò–ò –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏...",
                    parse_mode="Markdown"
                )
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä LLM
            await _show_llm_selection(callback, state, user_service, llm_service, processing_service)
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ quick_template_callback: {e}")
            await _safe_callback_answer(callback, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —à–∞–±–ª–æ–Ω–∞")
    
    @router.callback_query(F.data == "settings_reset")
    async def settings_reset_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–±—Ä–æ—Å–∞ –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
        try:
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await user_service.update_user_llm_preference(callback.from_user.id, None)
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –≤—ã–≤–æ–¥–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            try:
                await user_service.update_user_protocol_output_preference(callback.from_user.id, 'messages')
            except Exception:
                pass
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(
                    text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º",
                    callback_data="back_to_settings"
                )]
            ])
            
            await callback.message.edit_text(
                "üîÑ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã**\n\n"
                "–í—Å–µ –≤–∞—à–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:\n\n"
                "‚Ä¢ –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ò–ò —Å–±—Ä–æ—à–µ–Ω—ã\n"
                "‚Ä¢ –®–∞–±–ª–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–±—Ä–æ—à–µ–Ω\n"
                "‚Ä¢ –î—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã\n\n"
                "–¢–µ–ø–µ—Ä—å –±–æ—Ç –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.",
                reply_markup=keyboard
            )
            await callback.answer()
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ settings_reset_callback: {e}")
            await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫")

    @router.callback_query(F.data == "settings_protocol_output")
    async def settings_protocol_output_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–∂–∏–º–∞ –≤—ã–≤–æ–¥–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user = await user_service.get_user_by_telegram_id(callback.from_user.id)
            current = getattr(user, 'protocol_output_mode', None) or 'messages'

            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(
                    text=f"{'‚úÖ ' if current == 'messages' else ''}üí¨ –í —Å–æ–æ–±—â–µ–Ω–∏—è",
                    callback_data="set_protocol_output_messages"
                )],
                [InlineKeyboardButton(
                    text=f"{'‚úÖ ' if current == 'file' else ''}üìé –í —Ñ–∞–π–ª md",
                    callback_data="set_protocol_output_file"
                )],
                [InlineKeyboardButton(
                    text=f"{'‚úÖ ' if current == 'pdf' else ''}üìÑ –í —Ñ–∞–π–ª pdf",
                    callback_data="set_protocol_output_pdf"
                )],
                [InlineKeyboardButton(
                    text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º",
                    callback_data="back_to_settings"
                )]
            ])

            await callback.message.edit_text(
                "üì§ **–í—ã–≤–æ–¥ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞**\n\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≥–æ—Ç–æ–≤—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª:\n"
                "‚Ä¢ üí¨ –í —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –ø—Ä–æ—Ç–æ–∫–æ–ª –ø—Ä–∏—Ö–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç–æ–º –≤ —á–∞—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)\n"
                "‚Ä¢ üìé –í —Ñ–∞–π–ª md ‚Äî –ø—Ä–æ—Ç–æ–∫–æ–ª –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª (.md)\n"
                "‚Ä¢ üìÑ –í —Ñ–∞–π–ª pdf ‚Äî –ø—Ä–æ—Ç–æ–∫–æ–ª –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª (.pdf)",
                reply_markup=keyboard,
                parse_mode="Markdown"
            )
            await callback.answer()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ settings_protocol_output_callback: {e}")
            await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫")

    @router.callback_query(F.data.in_({"set_protocol_output_messages", "set_protocol_output_file", "set_protocol_output_pdf"}))
    async def set_protocol_output_mode_callback(callback: CallbackQuery):
        """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–∂–∏–º–∞ –≤—ã–≤–æ–¥–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞"""
        try:
            if callback.data.endswith('messages'):
                mode = 'messages'
                mode_text = "üí¨ –í —Å–æ–æ–±—â–µ–Ω–∏—è"
            elif callback.data.endswith('pdf'):
                mode = 'pdf'
                mode_text = "üìÑ –í —Ñ–∞–π–ª pdf"
            else:
                mode = 'file'
                mode_text = "üìé –í —Ñ–∞–π–ª md"
            
            await user_service.update_user_protocol_output_preference(callback.from_user.id, mode)

            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(
                    text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º",
                    callback_data="back_to_settings"
                )]
            ])

            await callback.message.edit_text(
                f"‚úÖ –†–µ–∂–∏–º –≤—ã–≤–æ–¥–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –∏–∑–º–µ–Ω—ë–Ω –Ω–∞: {mode_text}",
                reply_markup=keyboard
            )
            await callback.answer()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ set_protocol_output_mode_callback: {e}")
            await callback.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º –≤—ã–≤–æ–¥–∞")
    
    @router.callback_query(F.data == "back_to_settings")
    async def back_to_settings_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
        try:
            from ux.quick_actions import QuickActionsUI
            
            keyboard = QuickActionsUI.create_settings_menu()
            
            await callback.message.edit_text(
                "‚öôÔ∏è **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞**\n\n"
                "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –ø–æ–¥ –≤–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è:",
                reply_markup=keyboard
            )
            await callback.answer()
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ back_to_settings_callback: {e}")
            await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º")
    
    
    
    @router.callback_query(F.data.startswith("set_default_template_"))
    async def set_default_template_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —à–∞–±–ª–æ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        try:
            template_id = int(callback.data.replace("set_default_template_", ""))
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∞–±–ª–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            success = await template_service.set_user_default_template(callback.from_user.id, template_id)
            
            if success:
                keyboard = InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(
                        text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º",
                        callback_data="back_to_settings"
                    )]
                ])
                
                # –ï—Å–ª–∏ template_id = 0, —ç—Ç–æ "–£–º–Ω—ã–π –≤—ã–±–æ—Ä"
                if template_id == 0:
                    await callback.message.edit_text(
                        "‚úÖ **–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ä–µ–∂–∏–º: –£–º–Ω—ã–π –≤—ã–±–æ—Ä**\n\n"
                        "ü§ñ –ò–ò –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–∏—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π —à–∞–±–ª–æ–Ω "
                        "–Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –∫–∞–∂–¥–æ–π –≤—Å—Ç—Ä–µ—á–∏.\n\n"
                        "üìä –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è:\n"
                        "‚Ä¢ –¢–µ–º–∞—Ç–∏–∫–∞ –≤—Å—Ç—Ä–µ—á–∏\n"
                        "‚Ä¢ –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞\n"
                        "‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è\n\n"
                        "–≠—Ç–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–µ–∂–∏–º –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.\n\n"
                        "üí° –í—ã –º–æ–∂–µ—Ç–µ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —à–∞–±–ª–æ–Ω—É.",
                        reply_markup=keyboard,
                        parse_mode="Markdown"
                    )
                else:
                    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —à–∞–±–ª–æ–Ω–µ
                    template = await template_service.get_template_by_id(template_id)
                    
                    await callback.message.edit_text(
                        f"‚úÖ **–®–∞–±–ª–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!**\n\n"
                        f"–¢–µ–ø–µ—Ä—å —à–∞–±–ª–æ–Ω **{template.name}** –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ "
                        f"–ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–æ–≤.\n\n"
                        f"–í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —ç—Ç–æ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.",
                        reply_markup=keyboard,
                        parse_mode="Markdown"
                    )
            else:
                keyboard = InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(
                        text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º",
                        callback_data="back_to_settings"
                    )]
                ])
                
                await callback.message.edit_text(
                    "‚ùå **–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —à–∞–±–ª–æ–Ω–∞**\n\n"
                    "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —à–∞–±–ª–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.\n"
                    "–í–æ–∑–º–æ–∂–Ω–æ, —à–∞–±–ª–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.",
                    reply_markup=keyboard
                )
            
            await callback.answer()
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ set_default_template_callback: {e}")
            await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —à–∞–±–ª–æ–Ω–∞")
    
    
    
    @router.callback_query(F.data == "reset_default_template")
    async def reset_default_template_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–±—Ä–æ—Å–∞ —à–∞–±–ª–æ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        try:
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —à–∞–±–ª–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —á–µ—Ä–µ–∑ template_service
            success = await template_service.reset_user_default_template(callback.from_user.id)
            
            if success:
                keyboard = InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(
                        text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º",
                        callback_data="back_to_settings"
                    )]
                ])
                
                await callback.message.edit_text(
                    "üîÑ **–®–∞–±–ª–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–±—Ä–æ—à–µ–Ω**\n\n"
                    "–¢–µ–ø–µ—Ä—å –±–æ—Ç –±—É–¥–µ—Ç —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –≤—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞.\n\n"
                    "üí° **–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ 'ü§ñ –£–º–Ω—ã–π –≤—ã–±–æ—Ä' –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞ "
                    "–ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ —à–∞–±–ª–æ–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –≤—Å—Ç—Ä–µ—á–∏.\n\n"
                    "–í—ã –º–æ–∂–µ—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π —à–∞–±–ª–æ–Ω –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.",
                    reply_markup=keyboard,
                    parse_mode="Markdown"
                )
                await callback.answer()
            else:
                await callback.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å —à–∞–±–ª–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ reset_default_template_callback: {e}")
            await callback.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —à–∞–±–ª–æ–Ω–∞")
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á–∏ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
    @router.callback_query(F.data.startswith("cancel_task_"))
    async def cancel_task_handler(callback: CallbackQuery, state: FSMContext):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á–∏"""
        await _cancel_task_callback(callback, state)
    
    return router


async def _show_llm_selection(callback: CallbackQuery, state: FSMContext, 
                             user_service: UserService, llm_service: EnhancedLLMService,
                             processing_service: OptimizedProcessingService):
    """–ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±–æ—Ä LLM –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è"""
    user = await user_service.get_user_by_telegram_id(callback.from_user.id)
    available_providers = llm_service.get_available_providers()
    
    if not available_providers:
        await callback.message.edit_text(
            "‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤. "
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é API –∫–ª—é—á–µ–π."
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
    if user and user.preferred_llm is not None:
        preferred_llm = user.preferred_llm
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π LLM –¥–æ—Å—Ç—É–ø–µ–Ω
        if preferred_llm in available_providers:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ
            await state.update_data(llm_provider=preferred_llm)
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è: –¥–ª—è OpenAI –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏, –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
            llm_display = available_providers[preferred_llm]
            if preferred_llm == 'openai':
                try:
                    from config import settings as app_settings
                    selected_key = getattr(user, 'preferred_openai_model_key', None)
                    preset = None
                    if selected_key:
                        preset = next((p for p in getattr(app_settings, 'openai_models', []) if p.key == selected_key), None)
                    if not preset:
                        models = getattr(app_settings, 'openai_models', [])
                        if models:
                            preset = models[0]
                    if preset and getattr(preset, 'name', None):
                        llm_display = preset.name
                except Exception:
                    pass
            await callback.message.edit_text(
                f"ü§ñ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è LLM: {llm_display}\n\n"
                "‚è≥ –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É..."
            )
            # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback –ø–µ—Ä–µ–¥ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
            await _safe_callback_answer(callback)
            await _process_file(callback, state, processing_service)
            return
    
    # –ï—Å–ª–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –Ω–µ—Ç –∏–ª–∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π LLM –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
    current_llm = user.preferred_llm if user else 'openai'
    
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(
            text=f"{'‚úÖ ' if provider_key == current_llm else ''}{provider_name}",
            callback_data=f"select_llm_{provider_key}"
        )]
        for provider_key, provider_name in available_providers.items()
    ])
    
    await callback.message.edit_text(
        "ü§ñ –í—ã–±–µ—Ä–∏—Ç–µ LLM –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:",
        reply_markup=keyboard
    )


async def _process_file(callback: CallbackQuery, state: FSMContext, processing_service: OptimizedProcessingService):
    """–ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–∞–π–ª–∞"""
    from src.models.processing import ProcessingRequest
    from src.services.task_queue_manager import task_queue_manager
    from src.models.task_queue import TaskPriority
    from src.ux.queue_tracker import QueueTrackerFactory
    import asyncio
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        data = await state.get_data()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ LLM (template_id –º–æ–∂–µ—Ç –±—ã—Ç—å None –¥–ª—è —É–º–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞)
        if not data.get('llm_provider'):
            await callback.message.edit_text(
                "‚ùå –û—à–∏–±–∫–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å."
            )
            await state.clear()
            return
        
        # –ï—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–º–Ω—ã–π –≤—ã–±–æ—Ä, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ template_id
        if not data.get('use_smart_selection') and not data.get('template_id'):
            await callback.message.edit_text(
                "‚ùå –û—à–∏–±–∫–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω —à–∞–±–ª–æ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å."
            )
            await state.clear()
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –ª–∏–±–æ file_id (–¥–ª—è Telegram —Ñ–∞–π–ª–æ–≤), –ª–∏–±–æ file_path (–¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Ñ–∞–π–ª–æ–≤)
        is_external_file = data.get('is_external_file', False)
        if is_external_file:
            if not data.get('file_path') or not data.get('file_name'):
                await callback.message.edit_text(
                    "‚ùå –û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –æ –≤–Ω–µ—à–Ω–µ–º —Ñ–∞–π–ª–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å."
                )
                await state.clear()
                return
        else:
            if not data.get('file_id') or not data.get('file_name'):
                await callback.message.edit_text(
                    "‚ùå –û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –æ —Ñ–∞–π–ª–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å."
                )
                await state.clear()
                return
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É
        request = ProcessingRequest(
            file_id=data.get('file_id') if not is_external_file else None,
            file_path=data.get('file_path') if is_external_file else None,
            file_name=data['file_name'],
            template_id=data['template_id'],
            llm_provider=data['llm_provider'],
            user_id=callback.from_user.id,
            language="ru",
            is_external_file=is_external_file
        )
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ –æ—á–µ—Ä–µ–¥—å
        queued_task = await task_queue_manager.add_task(
            request=request,
            chat_id=callback.message.chat.id,
            priority=TaskPriority.NORMAL
        )
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—ã–±–æ—Ä–æ–º
        try:
            await callback.message.delete()
        except Exception:
            pass
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ –æ—á–µ—Ä–µ–¥–∏
        position = await task_queue_manager.get_queue_position(str(queued_task.task_id))
        total_in_queue = await task_queue_manager.get_queue_size()
        
        # –°–æ–∑–¥–∞–µ–º —Ç—Ä–µ–∫–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –≤ –æ—á–µ—Ä–µ–¥–∏
        queue_tracker = await QueueTrackerFactory.create_tracker(
            bot=callback.bot,
            chat_id=callback.message.chat.id,
            task_id=str(queued_task.task_id),
            initial_position=position if position is not None else 0,
            total_in_queue=total_in_queue
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id –≤ –∑–∞–¥–∞—á–µ
        if queue_tracker.message_id:
            queued_task.message_id = queue_tracker.message_id
            from database import db
            await db.update_queue_task_message_id(str(queued_task.task_id), queue_tracker.message_id)
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ –æ—á–µ—Ä–µ–¥–∏
        from src.handlers.message_handlers import _monitor_queue_position
        asyncio.create_task(_monitor_queue_position(
            queue_tracker, queued_task.task_id, task_queue_manager
        ))
        
        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        await state.clear()
        
        logger.info(f"–ó–∞–¥–∞—á–∞ {queued_task.task_id} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –æ—á–µ—Ä–µ–¥—å —á–µ—Ä–µ–∑ callback")
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É: {e}")
        await callback.message.edit_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞.")
        await state.clear()


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á–∏
async def _cancel_task_callback(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á–∏ –∏–∑ –æ—á–µ—Ä–µ–¥–∏"""
    from src.services.task_queue_manager import task_queue_manager
    from src.ux.queue_tracker import QueuePositionTracker
    
    try:
        # –ò–∑–≤–ª–µ–∫–∞–µ–º task_id –∏–∑ callback_data
        task_id = callback.data.replace("cancel_task_", "")
        
        # –û—Ç–º–µ–Ω—è–µ–º –∑–∞–¥–∞—á—É
        success = await task_queue_manager.cancel_task(task_id)
        
        if success:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            tracker = QueuePositionTracker(callback.bot, callback.message.chat.id, task_id)
            tracker.message_id = callback.message.message_id
            await tracker.show_cancelled()
            
            logger.info(f"–ó–∞–¥–∞—á–∞ {task_id} –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {callback.from_user.id}")
        else:
            # –ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
            await callback.answer(
                "–ó–∞–¥–∞—á–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–º–µ–Ω–µ–Ω–∞",
                show_alert=True
            )
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–¥–∞—á–∏: {e}")
        await callback.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–¥–∞—á–∏", show_alert=True)


# –°—Ç–∞—Ä—ã–π –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ _process_file - —É–¥–∞–ª–µ–Ω–æ
# –¢–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á


async def _send_long_message(chat_id: int, text: str, bot, max_length: int = 4096):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —á–∞—Å—Ç—è–º"""
    # –£—á–∏—Ç—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã —á–∞—Å—Ç–∏
    header_template = "üìÑ **–ü—Ä–æ—Ç–æ–∫–æ–ª –≤—Å—Ç—Ä–µ—á–∏** (—á–∞—Å—Ç—å {}/{})\n\n"
    max_header_length = len(header_template.format(999, 999))  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞
    max_part_length = max_length - max_header_length
    
    if len(text) <= max_length:
        try:
            await bot.send_message(chat_id, text, parse_mode="Markdown")
            return
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å Markdown, –ø—Ä–æ–±—É–µ–º –±–µ–∑ –Ω–µ–≥–æ
            await bot.send_message(chat_id, text)
            return
    
    # –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏
    parts = []
    current_part = ""
    
    for line in text.split('\n'):
        if len(current_part) + len(line) + 1 <= max_part_length:
            current_part += line + '\n'
        else:
            if current_part:
                parts.append(current_part.strip())
            current_part = line + '\n'
    
    if current_part:
        parts.append(current_part.strip())
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–∞—Å—Ç–∏ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
    for i, part in enumerate(parts):
        try:
            header = f"üìÑ **–ü—Ä–æ—Ç–æ–∫–æ–ª –≤—Å—Ç—Ä–µ—á–∏** (—á–∞—Å—Ç—å {i+1}/{len(parts)})\n\n"
            full_message = header + part
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç
            if len(full_message) > max_length:
                # –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–∞–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–µ–∑ Markdown
                await bot.send_message(chat_id, full_message)
            else:
                await bot.send_message(chat_id, full_message, parse_mode="Markdown")
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–∞—Å—Ç–∏ {i+1}: {e}")
            # –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –±–µ–∑ Markdown
            try:
                header = f"üìÑ –ü—Ä–æ—Ç–æ–∫–æ–ª –≤—Å—Ç—Ä–µ—á–∏ (—á–∞—Å—Ç—å {i+1}/{len(parts)})\n\n"
                await bot.send_message(chat_id, header + part)
            except Exception as e2:
                logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–∞—Å—Ç–∏ {i+1}: {e2}")
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
                await bot.send_message(chat_id, part[:max_length])
    
    # ============================================================================
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –º–µ–Ω—é
    # ============================================================================
    
    @router.callback_query(F.data == "admin_status")
    async def admin_status_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã'"""
        from src.utils.admin_utils import is_admin
        
        if not is_admin(callback.from_user.id):
            await callback.answer("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤", show_alert=True)
            return
        
        try:
            from api.monitoring import monitoring_api
            
            await callback.answer()
            await callback.message.edit_text("üîÑ –ü–æ–ª—É—á–∞—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∏—Å—Ç–µ–º—ã...")
            
            report = monitoring_api.format_status_report()
            await callback.message.edit_text(report, parse_mode="Markdown")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ admin_status_callback: {e}")
            await callback.message.edit_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: {e}")
    
    @router.callback_query(F.data == "admin_health")
    async def admin_health_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è'"""
        from src.utils.admin_utils import is_admin
        
        if not is_admin(callback.from_user.id):
            await callback.answer("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤", show_alert=True)
            return
        
        try:
            from reliability.health_check import health_checker
            
            await callback.answer()
            await callback.message.edit_text("üîç –í—ã–ø–æ–ª–Ω—è—é –ø—Ä–æ–≤–µ—Ä–∫—É –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã...")
            
            health_results = await health_checker.check_all()
            
            report_lines = ["üè• **–î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è**\n"]
            
            for component, result in health_results.items():
                status_emoji = {
                    "healthy": "‚úÖ",
                    "degraded": "‚ö†Ô∏è",
                    "unhealthy": "‚ùå",
                    "unknown": "‚ùì"
                }.get(result.status.value, "‚ùì")
                
                report_lines.append(f"**{component}:** {status_emoji} {result.status.value}")
                report_lines.append(f"  ‚îî {result.message}")
                
                if result.response_time:
                    report_lines.append(f"  ‚îî –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: {result.response_time:.3f}—Å")
                
                report_lines.append("")
            
            report = "\n".join(report_lines)
            await callback.message.edit_text(report, parse_mode="Markdown")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ admin_health_callback: {e}")
            await callback.message.edit_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∑–¥–æ—Ä–æ–≤—å—è: {e}")
    
    @router.callback_query(F.data == "admin_performance")
    async def admin_performance_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å'"""
        from src.utils.admin_utils import is_admin
        
        if not is_admin(callback.from_user.id):
            await callback.answer("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤", show_alert=True)
            return
        
        try:
            from performance import (
                performance_cache, metrics_collector, memory_optimizer, task_pool
            )
            
            await callback.answer()
            await callback.message.edit_text("üìä –°–æ–±–∏—Ä–∞—é –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...")
            
            # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            cache_stats = performance_cache.get_stats()
            memory_stats = memory_optimizer.get_optimization_stats()
            task_stats = task_pool.get_stats()
            metrics_stats = metrics_collector.get_current_stats()
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
            report = (
                "üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**\n\n"
                
                "üíæ **–ö—ç—à:**\n"
                f"‚Ä¢ Hit Rate: {cache_stats['hit_rate_percent']}%\n"
                f"‚Ä¢ –ü–∞–º—è—Ç—å: {cache_stats['memory_usage_mb']}MB "
                f"({cache_stats['memory_usage_percent']}%)\n"
                f"‚Ä¢ –ó–∞–ø–∏—Å–µ–π: {cache_stats['memory_entries']} + {cache_stats['disk_entries']} (–¥–∏—Å–∫)\n\n"
                
                "üß† **–ü–∞–º—è—Ç—å:**\n"
                f"‚Ä¢ –°–∏—Å—Ç–µ–º–∞: {memory_stats['current_memory']['percent']}%\n"
                f"‚Ä¢ –ü—Ä–æ—Ü–µ—Å—Å: {memory_stats['current_memory']['process_mb']:.1f}MB\n"
                f"‚Ä¢ –ê–≤—Ç–æ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: {'–í–∫–ª' if memory_stats['is_optimizing'] else '–í—ã–∫–ª'}\n\n"
                
                "‚ö° **–ó–∞–¥–∞—á–∏:**\n"
                f"‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã–µ: {task_stats['active_tasks']}\n"
                f"‚Ä¢ –ú–∞–∫—Å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ: {task_stats['max_concurrent']}\n"
                f"‚Ä¢ –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: {task_stats['success_rate']:.1f}%\n\n"
                
                "üìà **–û–±—Ä–∞–±–æ—Ç–∫–∞:**\n"
                f"‚Ä¢ –ó–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ —á–∞—Å: {metrics_stats['processing']['requests_1h']}\n"
                f"‚Ä¢ –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: {metrics_stats['processing']['success_rate_percent']}%\n"
                f"‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: {metrics_stats['processing']['avg_duration_seconds']}—Å\n"
                f"‚Ä¢ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {metrics_stats['processing']['avg_efficiency_ratio']}\n"
            )
            
            await callback.message.edit_text(report, parse_mode="Markdown")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ admin_performance_callback: {e}")
            await callback.message.edit_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
    
    @router.callback_query(F.data == "admin_cleanup")
    async def admin_cleanup_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞–º–∏'"""
        from src.utils.admin_utils import is_admin
        
        if not is_admin(callback.from_user.id):
            await callback.answer("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤", show_alert=True)
            return
        
        try:
            from src.services.cleanup_service import cleanup_service
            from config import settings
            
            await callback.answer()
            
            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            stats = cleanup_service.get_cleanup_stats()
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
            report = (
                "üìÅ **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∞–π–ª–æ–≤**\n\n"
                f"üìÇ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã: {stats['temp_files']} ({stats['temp_size_mb']:.1f}MB)\n"
                f"üóÇÔ∏è –ö—ç—à —Ñ–∞–π–ª—ã: {stats['cache_files']} ({stats['cache_size_mb']:.1f}MB)\n\n"
                f"‚è∞ –°—Ç–∞—Ä—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã: {stats['old_temp_files']}\n"
                f"‚è∞ –°—Ç–∞—Ä—ã–µ –∫—ç—à —Ñ–∞–π–ª—ã: {stats['old_cache_files']}\n\n"
                f"‚öôÔ∏è **–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**\n"
                f"‚Ä¢ –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—á–∏—Å—Ç–∫–∏: {settings.cleanup_interval_minutes} –º–∏–Ω\n"
                f"‚Ä¢ –ú–∞–∫—Å. –≤–æ–∑—Ä–∞—Å—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: {settings.temp_file_max_age_hours} —á\n"
                f"‚Ä¢ –ú–∞–∫—Å. –≤–æ–∑—Ä–∞—Å—Ç –∫—ç—à —Ñ–∞–π–ª–æ–≤: {settings.cache_max_age_hours} —á\n"
                f"‚Ä¢ –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞: {'‚úÖ' if settings.enable_cleanup else '‚ùå'}\n\n"
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /cleanup_force –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏"
            )
            
            await callback.message.edit_text(report, parse_mode="Markdown")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ admin_cleanup_callback: {e}")
            await callback.message.edit_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
    
    @router.callback_query(F.data == "admin_transcription")
    async def admin_transcription_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–†–µ–∂–∏–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏'"""
        from src.utils.admin_utils import is_admin
        
        if not is_admin(callback.from_user.id):
            await callback.answer("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤", show_alert=True)
            return
        
        try:
            from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup
            from config import settings
            
            await callback.answer()
            
            # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(
                    text=f"{'‚úÖ ' if settings.transcription_mode == 'local' else ''}üè† –õ–æ–∫–∞–ª—å–Ω–∞—è (Whisper)",
                    callback_data="set_transcription_mode_local"
                )],
                [InlineKeyboardButton(
                    text=f"{'‚úÖ ' if settings.transcription_mode == 'cloud' else ''}‚òÅÔ∏è –û–±–ª–∞—á–Ω–∞—è (Groq)",
                    callback_data="set_transcription_mode_cloud"
                )],
                [InlineKeyboardButton(
                    text=f"{'‚úÖ ' if settings.transcription_mode == 'hybrid' else ''}üîÑ –ì–∏–±—Ä–∏–¥–Ω–∞—è (Groq + –¥–∏–∞—Ä–∏–∑–∞—Ü–∏—è)",
                    callback_data="set_transcription_mode_hybrid"
                )],
                [InlineKeyboardButton(
                    text=f"{'‚úÖ ' if settings.transcription_mode == 'speechmatics' else ''}üéØ Speechmatics",
                    callback_data="set_transcription_mode_speechmatics"
                )],
                [InlineKeyboardButton(
                    text=f"{'‚úÖ ' if settings.transcription_mode == 'deepgram' else ''}üé§ Deepgram",
                    callback_data="set_transcription_mode_deepgram"
                )],
                [InlineKeyboardButton(
                    text=f"{'‚úÖ ' if settings.transcription_mode == 'leopard' else ''}üêÜ Leopard (Picovoice)",
                    callback_data="set_transcription_mode_leopard"
                )]
            ])
            
            current_mode = settings.transcription_mode
            mode_descriptions = {
                "local": "–õ–æ–∫–∞–ª—å–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —á–µ—Ä–µ–∑ Whisper",
                "cloud": "–û–±–ª–∞—á–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —á–µ—Ä–µ–∑ Groq API",
                "hybrid": "–ì–∏–±—Ä–∏–¥–Ω–∞—è: –æ–±–ª–∞—á–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è + –ª–æ–∫–∞–ª—å–Ω–∞—è –¥–∏–∞—Ä–∏–∑–∞—Ü–∏—è",
                "speechmatics": "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∏ –¥–∏–∞—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Speechmatics API",
                "deepgram": "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∏ –¥–∏–∞—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Deepgram API",
                "leopard": "–õ–æ–∫–∞–ª—å–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —á–µ—Ä–µ–∑ Picovoice Leopard"
            }
            
            current_description = mode_descriptions.get(current_mode, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º")
            
            await callback.message.edit_text(
                f"üéôÔ∏è **–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏:** {current_mode}\n"
                f"üìù **–û–ø–∏—Å–∞–Ω–∏–µ:** {current_description}\n\n"
                f"–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Ä–µ–∂–∏–º:",
                reply_markup=keyboard,
                parse_mode="Markdown"
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ admin_transcription_callback: {e}")
            await callback.message.edit_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–æ–≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏: {e}")
    
    @router.callback_query(F.data == "admin_reset")
    async def admin_reset_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–°–±—Ä–æ—Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤'"""
        from src.utils.admin_utils import is_admin
        
        if not is_admin(callback.from_user.id):
            await callback.answer("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤", show_alert=True)
            return
        
        try:
            from reliability.health_check import health_checker
            
            await callback.answer()
            await callback.message.edit_text("üîÑ –°–±—Ä–∞—Å—ã–≤–∞—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏...")
            
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            await llm_service.reset_reliability_components()
            await processing_service.reset_reliability_components()
            
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º health checker
            for name, cb in health_checker.component_health.items():
                cb.consecutive_failures = 0
                cb.status = health_checker.HealthStatus.UNKNOWN
            
            await callback.message.edit_text("‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ —Å–±—Ä–æ—à–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ.")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ admin_reset_callback: {e}")
            await callback.message.edit_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ: {e}")
    
    @router.callback_query(F.data == "admin_export")
    async def admin_export_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–≠–∫—Å–ø–æ—Ä—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏'"""
        from src.utils.admin_utils import is_admin
        
        if not is_admin(callback.from_user.id):
            await callback.answer("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤", show_alert=True)
            return
        
        try:
            from api.monitoring import monitoring_api
            import tempfile
            import os
            from aiogram.types import FSInputFile, BufferedInputFile
            
            await callback.answer()
            await callback.message.edit_text("üì• –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...")
            
            # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            json_stats = monitoring_api.export_stats_json()
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Ñ–∞–π–ª
            file_input = BufferedInputFile(
                json_stats.encode('utf-8'),
                filename="bot_stats.json"
            )
            
            await callback.message.answer_document(
                file_input,
                caption="üìä –≠–∫—Å–ø–æ—Ä—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã"
            )
            
            await callback.message.delete()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ admin_export_callback: {e}")
            await callback.message.edit_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: {e}")
    
    @router.callback_query(F.data == "admin_help")
    async def admin_help_callback(callback: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–°–ø—Ä–∞–≤–∫–∞'"""
        from src.utils.admin_utils import is_admin
        
        if not is_admin(callback.from_user.id):
            await callback.answer("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤", show_alert=True)
            return
        
        await callback.answer()
        
        help_text = """
üîß **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã**

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
‚Ä¢ `/status` - –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
‚Ä¢ `/health` - –¥–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
‚Ä¢ `/stats` - –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚Ä¢ `/export_stats` - —ç–∫—Å–ø–æ—Ä—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ JSON

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
‚Ä¢ `/performance` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
‚Ä¢ `/optimize` - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
‚Ä¢ `/reset_reliability` - —Å–±—Ä–æ—Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
‚Ä¢ `/transcription_mode` - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏

**–û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤:**
‚Ä¢ `/cleanup` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∞–π–ª–æ–≤ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—á–∏—Å—Ç–∫–∏
‚Ä¢ `/cleanup_force` - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

**–°–ø—Ä–∞–≤–∫–∞:**
‚Ä¢ `/admin_help` - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
        """
        
        await callback.message.edit_text(help_text, parse_mode="Markdown")


