"""
Консолидированные промпты для двухзапросного подхода к генерации протоколов
"""

from typing import Dict, Any, Optional


def build_consolidated_extraction_prompt(
    transcription: str,
    participants_list: Optional[str] = None,
    meeting_metadata: Optional[Dict[str, str]] = None,
    meeting_type: str = "general"
) -> str:
    """
    Создает унифицированный промпт для первого запроса:
    - Сопоставление спикеров с участниками
    - Извлечение структуры встречи
    - Оценка качества извлечения

    Args:
        transcription: Текст транскрипции с метками SPEAKER_N
        participants_list: Список участников
        meeting_metadata: Метаданные встречи (дата, время, тема)
        meeting_type: Тип встречи

    Returns:
        Промпт для LLM
    """
    # Базовые метаданные
    meeting_date = meeting_metadata.get('meeting_date', '') if meeting_metadata else ''
    meeting_time = meeting_metadata.get('meeting_time', '') if meeting_metadata else ''
    meeting_topic = meeting_metadata.get('meeting_topic', '') if meeting_metadata else ''

    # Получаем специализированные инструкции для типа встречи
    type_instructions = _get_type_specific_instructions(meeting_type)

    prompt = f"""Проанализируй стенограмму встречи и выполни три задачи:

ЗАДАЧА 1: ОПРЕДЕЛЕНИЕ ТИПА ВСТРЕЧИ
На основе анализа контента стенограммы определи тип встречи:

ТИПЫ ВСТРЕЧ:
- **technical** (техническое): Обсуждение кода, архитектуры, API, баз данных, серверов, тестирования, фреймворков, библиотек, CI/CD, девопса, багов, дебага
- **business** (деловое): Обсуждение бюджета, прибыли, контрактов, сделок, клиентов, продаж, маркетинга, стратегии, финансов, инвестиций, ROI, конкурентов, договоров
- **educational** (образовательное): Обучение, объяснение, изучение, лекции, семинары, тренинги, презентации, передача знаний, менторство
- **brainstorm** (брейншторм): Генерация идей, креативные сессии, предложение вариантов, обсуждение возможностей, инновации, новые подходы
- **status** (статусное): Отчеты о прогрессе, статусные обновления, обсуждение метрик, KPI, результатов достижений, стендапы, ретроспективы
- **general** (общее): Если тип точно не определяется или смешанное содержание

ЛОГИКА ОПРЕДЕЛЕНИЯ:
1. Проанализируй основные темы и ключевые слова в стенограмме
2. Определи доминирующий тип контента
3. Учти характер обсуждения (обучение vs принятие решений vs генерация идей)
4. Выбери ОДИН наиболее подходящий тип

ЗАДАЧА 2: СОПОСТАВЛЕНИЕ СПИКЕРОВ
Изучи список участников и сопоставь метки SPEAKER_1, SPEAKER_2 с реальными именами.

Правила сопоставления:
- Уверенность >= 0.7: включай в speaker_mappings
- Уверенность < 0.7: включай в unmapped_speakers
- Используй формат 'Имя Фамилия' (БЕЗ отчества)
- Учитывай уменьшительные формы: Света→Светлана, Леша→Алексей, Саша→Александр
- Используй контекст высказываний для точного сопоставления

Список участников:
{participants_list or 'Не предоставлен'}

ЗАДАЧА 3: ИЗВЛЕЧЕНИЕ СТРУКТУРЫ ВСТРЕЧИ
Полностью проанализируй ВСЮ транскрипцию и извлеки информацию для протокола.

КРИТИЧЕСКИ ВАЖНЫЕ ПРИНЦИПЫ:
- АБСОЛЮТНАЯ ПОЛНОТА: Обработай всю транскрипцию от начала до конца
- ФАКТИЧЕСКАЯ ТОЧНОСТЬ: Используй только информацию из транскрипции
- НЕТ ДОМЫСЛОВ: Не добавляй информацию от себя
- АТРИБУЦИЯ: Сохраняй кто что сказал
- ДЕТАЛИ: Фиксируй все цифры, даты, имена, термины

{type_instructions}

СТРУКТУРА ПРОТОКОЛА:
- meeting_title: Краткое название встречи (если известно из контекста)
- meeting_type: Тип встречи определенный из анализа (technical, business, educational, brainstorm, status, general)
- meeting_date: Дата встречи ({meeting_date})
- meeting_time: Время встречи ({meeting_time})
- participants: Список участников в формате 'Имя Фамилия' (каждый с новой строки через \\n)
- agenda: Повестка дня (пункты списком через \\n)
- discussion: Подробное обсуждение по темам с атрибуцией высказываний (Имя: текст) через \\n
- key_points: Краткие итоги и выводы по обсуждению (пункты списком через \\n)
- decisions: Принятые решения (каждое с новой строки через \\n)
- action_items: Задачи и поручения (каждая с новой строки через \\n)
- next_meeting: Информация о следующей встрече
- additional_notes: Дополнительные заметки

КАЧЕСТВО И АНАЛИЗ:
- extraction_confidence: Общая уверенность в извлечении (0.0-1.0)
- missing_elements: Список элементов, которые не удалось извлечь
- quality_issues: Проблемы качества (неоднозначность, противоречия)
- extraction_notes: Общие заметки по процессу

СТЕНОГРАММА ВСТРЕЧИ:
{transcription}

ВНИМАНИЕ:
- Все значения в JSON должны быть строками
- Списки форматируй как многострочный текст с маркерами "- " через \\n
- Участники: каждый с новой строки через \\n
- НЕ используй вложенные объекты или массивы в значениях полей"""

    return prompt


def build_consolidated_extraction_system_prompt() -> str:
    """
    Создает системный промпт для первого запроса (извлечение)
    """
    return """Ты — профессиональный протоколист и эксперт по анализу встреч.

ТВОЯ РОЛЬ:
1. ТОЧНО сопоставить метки SPEAKER_N с именами участников
2. ПОЛНОСТЬЮ извлечь всю информацию из стенограммы для протокола
3. ОЦЕНИТЬ качество и полноту извлечения

ПРИНЦИПЫ ТОЧНОСТИ:
- Изучай ВЕСЬ текст от первого до последнего слова
- Используй ТОЛЬКО информацию из стенограммы
- Сохраняй точные формулировки, цифры, даты
- Не додумывай и не интерпретируй

ПРАВИЛА СОПОСТАВЛЕНИЯ СПИКЕРОВ:
- Ищи явные упоминания имен в контексте высказываний
- Учитывай обращения, представления, контекст речи
- Преобразуй уменьшительные формы в полные
- Требуй уверенность >= 0.7 для надежного сопоставления

ПРАВИЛА ИЗВЛЕЧЕНИЯ:
- Фиксируй ВСЕ темы, решения, задачи
- Сохраняй атрибуцию высказываний
- Извлекай все детали (сроки, суммы, технологии)
- Структурируй информацию по секциям протокола

КАЧЕСТВО И ВАЛИДАЦИЯ:
- Оценивай полноту извлеченной информации
- Отмечай неоднозначные моменты
- Фиксируй проблемы и ограничения

ФОРМАТ ВЫВОДА:
Строго валидный JSON с соответствующей схемой. Все значения - строки."""


def build_consolidated_protocol_prompt(
    extraction_result: Dict[str, Any],
    template_variables: Dict[str, str],
    meeting_type: str = "general"
) -> str:
    """
    Создает унифицированный промпт для второго запроса:
    - Финальная генерация протокола
    - Проверка качества и согласованности
    - Форматирование для вывода

    Args:
        extraction_result: Результаты первого запроса
        template_variables: Переменные шаблона
        meeting_type: Тип встречи

    Returns:
        Промпт для LLM
    """
    # Извлекаем данные из первого запроса (ConsolidatedExtractionSchema)
    # Данные находятся прямо в корне extraction_result, нет вложенного protocol_data
    extracted_data = extraction_result
    speaker_mapping = extraction_result.get('speaker_mappings', {})
    confidence = extraction_result.get('extraction_confidence', 0.0)
    missing_elements = extraction_result.get('missing_elements', [])
    quality_issues = extraction_result.get('quality_issues', [])

    # Получаем специализированные инструкции для типа встречи
    type_instructions = _get_type_specific_formatting_instructions(meeting_type)

    prompt = f"""Создай финальный протокол встречи на основе извлеченных данных.

ИСХОДНЫЕ ДАННЫЕ:

Извлеченная информация:
{extracted_data}

Сопоставление спикеров:
{speaker_mapping}

Уверенность извлечения: {confidence}
Пропущенные элементы: {missing_elements}
Проблемы качества: {quality_issues}

{type_instructions}

ТРЕБОВАНИЯ К ФИНАЛЬНОМУ ПРОТОКОЛУ:

1. СТРУКТУРА И СОДЕРЖАНИЕ:
- Уточни и отформатируй все поля протокола
- Исправь несоответствия и ошибки
- Добавь контекст где необходимо
- Примени специализированные правила для типа встречи

2. КАЧЕСТВО И СОГЛАСОВАННОСТЬ:
- Проверь соответствие между участниками
- Удостоверься в логической связности
- Валидируй даты, время, сроки
- Проверь полноту информации

3. ФОРМАТИРОВАНИЕ:
- Участники: 'Имя Фамилия' (каждый с новой строки через \\n)
- Повестка: пункты списком через \\n
- Обсуждение: подробное обсуждение по темам с атрибуцией (Имя: текст) через \\n
- Ключевые моменты: краткие итоги и выводы (пункты списком через \\n)
- Решения: каждое с новой строки через \\n
- Задачи: каждая с новой строки через \\n

4. СПЕЦИАЛЬНЫЕ ПРОВЕРКИ:
- participants_consistent: Имена в секции 'Участники' соответствуют извлеченным данным
- dates_valid: Даты и время корректны и согласованы
- decisions_complete: Все решения имеют четкую формулировку
- action_items_clear: Все задачи имеют описание и ответственных
- meeting_type_appropriate: Формат соответствует типу встречи

5. САМОРЕФЛЕКСИЯ И УЛУЧШЕНИЯ:
- Оцени общее качество протокола (0.0-1.0)
- Предложения по улучшению
- Заметки о качестве генерации
- Специфичные наблюдения для типа встречи

6. ЗАПОЛНЕНИЕ ПОЛЕЙ КАЧЕСТВА:
- verified_speaker_mapping: Проверенное сопоставление SPEAKER_N → 'Имя Фамилия'
- speaker_mapping_confidence: Общая уверенность в сопоставлении спикеров (0.0-1.0)
- consistency_checks: Объект с проверками {'participants_consistent': true/false, 'dates_valid': true/false, 'decisions_complete': true/false, 'action_items_clear': true/false, 'meeting_type_appropriate': true/false}
- meeting_type: Тип встречи (general, technical, business, educational, brainstorm, status)
- type_specific_observations: Специфичные наблюдения для типа встречи
- completeness_assessment: Оценка полноты протокола
- improvement_suggestions: Список предложений по улучшению через \n
- self_reflection_notes: Заметки саморефлексии по качеству генерации

СОЗДАЙ ФИНАЛЬНЫЙ ПРОТОКОЛ:
- meeting_title: Четкое название встречи
- meeting_date: Дата в формате ДД.ММ.ГГГГ
- meeting_time: Время в формате ЧЧ:ММ
- participants: Список участников через \\n
- agenda: Повестка дня через \\n
- discussion: Подробное обсуждение по темам с атрибуцией через \\n
- key_points: Краткие итоги и выводы через \\n
- decisions: Принятые решения через \\n
- action_items: Задачи и поручения через \\n
- next_meeting: Информация о следующей встрече
- additional_notes: Дополнительные заметки

ВНИМАНИЕ:
- Все значения должны быть строками
- Используй многострочное форматирование с \\n
- НЕ используй вложенные объекты или массивы
- Применяй утвержденный формат имен 'Имя Фамилия'"""

    return prompt


def build_consolidated_protocol_system_prompt() -> str:
    """
    Создает системный промпт для второго запроса (финальный протокол)
    """
    return """Ты — старший протоколист с опытом создания идеальных протоколов деловых встреч.

ТВОЯ РОЛЬ:
1. Создать безупречный финальный протокол на основе извлеченных данных
2. Обеспечить высочайшее качество и согласованность
3. Применить специализированные правила для типа встречи
4. Провести саморефлексию и оценку качества

ПРИНЦИПЫ КАЧЕСТВА:
- ТОЧНОСТЬ: Проверь все факты и цифры
- ПОЛНОТА: Удостоверься в наличии всех необходимых разделов
- СОГЛАСОВАННОСТЬ: Проверь соответствие между всеми секциями
- ФОРМАТ: Примени утвержденный стандарт форматирования

ПРАВИЛА ФОРМАТИРОВАНИЯ:
- Имена участников: 'Имя Фамилия' (БЕЗ отчества)
- Списки: каждый элемент с новой строки через \\n
- Структура: четкое разделение на тематические блоки
- Язык: официально-деловой стиль

СПЕЦИАЛИЗИРОВАННЫЕ ПРАВИЛА:
- Технические встречи: сохраняй термины, API, технологии
- Деловые встречи: точные цифры, сроки, условия
- Образовательные: структура по темам, определения
- Брейнштормы: сохраняй креативные формулировки
- Отчетные: точные метрики, статусы, KPI

КОНТРОЛЬ КАЧЕСТВА:
- Проверь логическую связность
- Валидируй все даты и время
- Удостоверься в полноте решений и задач
- Проверь соответствие формата требованиям

САМОРЕФЛЕКСИЯ:
- Оцени качество своей работы (0.0-1.0)
- Выяви возможности для улучшения
- Заметки о специфических аспектах протокола
- Рекомендации для будущих протоколов

ФОРМАТ ВЫВОДА:
Строго валидный JSON с соответствующей схемой. Все значения - строки."""


def _get_type_specific_instructions(meeting_type: str) -> str:
    """
    Получает специализированные инструкции для типа встречи
    """
    instructions = {
        'technical': """
СПЕЦИФИКА ТЕХНИЧЕСКИХ ВСТРЕЧ:
- Сохраняй названия технологий, API, библиотек как есть
- Включай технические детали (версии, конфигурации)
- Отмечай архитектурные решения и их обоснования
- Фиксируй технические компромиссы и риски
- Указывай технический долг и рефакторинг
""",
        'business': """
СПЕЦИФИКА ДЕЛОВЫХ ВСТРЕЧ:
- Используй точные финансовые цифры без округления
- Указывай валюту для всех сумм
- Фиксируй юридически значимые формулировки
- Отмечай условия и оговорки договоренностей
- Выделяй коммерческие риски и гарантии
""",
        'educational': """
СПЕЦИФИКА ОБРАЗОВАТЕЛЬНЫХ ВСТРЕЧ:
- Структурируй материал по темам/разделам
- Выделяй ключевые термины и определения
- Включай приведенные примеры и пояснения
- Отмечай практические задания и упражнения
- Фиксируй вопросы аудитории и ответы
""",
        'brainstorm': """
СПЕЦИФИКА БРЕЙНШТОРМОВ:
- Фиксируй все идеи без фильтрации
- Сохраняй оригинальную формулировку идей
- Группируй связанные идеи по темам
- Отмечай развитие и комбинацию идей
- Выделяй инновационные предложения
""",
        'status': """
СПЕЦИФИКА ОТЧЕТНЫХ ВСТРЕЧ:
- Фиксируй все метрики и показатели
- Используй точные статусы (завершено, в процессе, заблокировано)
- Отмечай процент выполнения где упомянуто
- Выделяй критические блокеры и риски
- Указывай планы на следующие периоды
"""
    }

    return instructions.get(meeting_type, "")


def _get_type_specific_formatting_instructions(meeting_type: str) -> str:
    """
    Получает инструкции по форматированию для типа встречи
    """
    instructions = {
        'technical': """
ФОРМАТИРОВАНИЕ ДЛЯ ТЕХНИЧЕСКИХ ВСТРЕЧ:
- Сохраняй технические термины на английском если они в оригинале
- Используй точные названия технологий и фреймворков
- Фиксируй архитектурные диаграммы в текстовом формате
- Отмечай версии, конфигурации, зависимости
""",
        'business': """
ФОРМАТИРОВАНИЕ ДЛЯ ДЕЛОВЫХ ВСТРЕЧ:
- Форматируй суммы с указанием валюты
- Используй точные даты и сроки
- Фиксируй условия договоренностей в явном виде
- Отмечай ответственных лиц и их роли
""",
        'educational': """
ФОРМАТИРОВАНИЕ ДЛЯ ОБРАЗОВАТЕЛЬНЫХ ВСТРЕЧ:
- Структурируй материал по логическим блокам
- Выделяй определения жирным шрифтом или подчеркиванием
- Фиксируй примеры в отдельном блоке
- Отмечай домашние задания отдельно
""",
        'brainstorm': """
ФОРМАТИРОВАНИЕ ДЛЯ БРЕЙНШТОРМОВ:
- Сохраняй креативную формулировку идей
- Группируй идеи по тематическим блокам
- Отмечай авторов идей если известно
- Выделяй выбранные идеи отдельно
""",
        'status': """
ФОРМАТИРОВАНИЕ ДЛЯ ОТЧЕТНЫХ ВСТРЕЧ:
- Используй четкие статусы для задач
- Фиксируй количественные показатели
- Отмечай прогресс в процентах
- Выделяй блокеры красным цветом или специальным маркером
"""
    }

    return instructions.get(meeting_type, "")